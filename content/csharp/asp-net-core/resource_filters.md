## Фильтры ресурсов в ASP.NET Core 8.0

Фильтры ресурсов – это мощный механизм ASP.NET Core, позволяющий выполнять код до или после выполнения метода-обработчика действия (action). Они являются частью конвейера обработки запроса и позволяют централизованно управлять кросс-сегментной функциональностью, такой как: 

* **Авторизация**: Проверка прав доступа пользователя к ресурсу.
* **Кэширование**: Кэширование ответа сервера для уменьшения нагрузки.
* **Обработка ошибок**: Перехват и обработка исключений, возникающих при выполнении действия.
* **Логирование**: Запись информации о запросе и ответе в лог.
* **Валидация**: Проверка входных данных, передаваемых в действие.

### Типы фильтров ресурсов

В ASP.NET Core 8.0 существует пять типов фильтров ресурсов:

| Тип фильтра | Описание |
|---|---|
| **Authorization filters** | Отвечают за авторизацию доступа к действию. |
| **Resource filters** | Выполняются до и после выполнения всех остальных фильтров, кроме фильтров авторизации. |
| **Action filters** | Выполняются до и после выполнения действия. |
| **Exception filters** | Используются для обработки исключений, возникающих во время выполнения запроса. |
| **Result filters** | Выполняются до и после возврата результата действия. |

### Реализация фильтра ресурсов

Для создания фильтра ресурса необходимо реализовать соответствующий интерфейс из пространства имен `Microsoft.AspNetCore.Mvc.Filters`:

```csharp
using Microsoft.AspNetCore.Mvc.Filters;

public class LogResourceFilter : Attribute, IResourceFilter
{
    private readonly ILogger<LogResourceFilter> _logger;

    public LogResourceFilter(ILogger<LogResourceFilter> logger)
    {
        _logger = logger;
    }

    public void OnResourceExecuting(ResourceExecutingContext context)
    {
        // Логируем информацию о запросе
        _logger.LogInformation($"Запрос к {context.HttpContext.Request.Path}");
    }

    public void OnResourceExecuted(ResourceExecutedContext context)
    {
        // Логируем информацию об ответе
        _logger.LogInformation($"Ответ от {context.HttpContext.Request.Path} со статусом {context.HttpContext.Response.StatusCode}");
    }
}
```

В данном примере мы создали фильтр `LogResourceFilter`, который реализует интерфейс `IResourceFilter`. 

* В методе `OnResourceExecuting` мы логируем информацию о запросе, такую как путь запроса. 
* В методе `OnResourceExecuted` мы логируем информацию об ответе, такую как путь запроса и код состояния ответа.

### Применение фильтра ресурсов

Фильтры ресурсов могут применяться на разных уровнях:

* **Глобально**: Фильтр применяется ко всем запросам в приложении.
* **К контроллеру**: Фильтр применяется ко всем действиям в контроллере.
* **К действию**: Фильтр применяется только к определенному действию.

#### Глобальное применение

Для глобального применения фильтра ресурса необходимо добавить его в коллекцию `Filters` в методе `builder.Services.AddControllers` в файле `Program.cs`:

```csharp
builder.Services.AddControllers(options =>
{
    options.Filters.Add<LogResourceFilter>();
});
```

#### Применение к контроллеру

Для применения фильтра ресурса к контроллеру необходимо добавить атрибут с типом фильтра над объявлением контроллера:

```csharp
[LogResourceFilter]
public class HomeController : Controller
{
    // ...
}
```

#### Применение к действию

Для применения фильтра ресурса к действию необходимо добавить атрибут с типом фильтра над объявлением действия:

```csharp
public class HomeController : Controller
{
    [LogResourceFilter]
    public IActionResult Index()
    {
        // ...
    }
}
```

### Порядок выполнения фильтров ресурсов

Фильтры ресурсов выполняются в следующем порядке:

1. **Authorization filters**
2. **Resource filters**
3. **Action filters**
4. **Action method**
5. **Result filters**
6. **Exception filters**

### Преимущества использования фильтров ресурсов

Использование фильтров ресурсов предоставляет следующие преимущества:

* **Повторное использование кода**: Логику, общую для нескольких действий или контроллеров, можно вынести в фильтр ресурса.
* **Централизованное управление**: Фильтры ресурсов позволяют управлять кросс-сегментной функциональностью из одного места.
* **Улучшение читаемости кода**: Вынос логики в фильтры ресурсов делает код действий более чистым и понятным.

Фильтры ресурсов – это мощный инструмент, который позволяет создавать более гибкие, масштабируемые и легко поддерживаемые приложения ASP.NET Core. Понимание типов фильтров и принципов их работы поможет вам создавать более эффективные и безопасные приложения. 

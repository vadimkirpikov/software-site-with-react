## Основы авторизации в ASP.NET Core 8.0

Авторизация — это процесс определения того, имеет ли пользователь доступ к конкретному ресурсу или выполнению определенного действия в вашем приложении. В отличие от аутентификации, которая подтверждает личность пользователя, авторизация определяет, какие права и разрешения у этого пользователя есть.

В ASP.NET Core 8.0 существует несколько способов реализации авторизации:

* **Ролевая авторизация:** Предоставление доступа к ресурсам на основе ролей, к которым принадлежит пользователь.
* **Политика авторизации:** Более гибкий подход, позволяющий определять сложные правила авторизации на основе требований к пользователю и контексту запроса.

### Ролевая авторизация

Ролевая авторизация — это простой и часто используемый подход. 

1. **Определите роли:**  В вашем приложении нужно определить роли, которые будут использоваться для авторизации. Например, "Администратор", "Менеджер", "Пользователь".

2. **Назначьте роли пользователям:** При регистрации или в процессе использования приложения пользователям назначаются определенные роли.

3. **Защитите контроллеры и действия атрибутом `[Authorize]`:**  Используйте атрибут `[Authorize]` для ограничения доступа к контроллерам или действиям. 

   ```csharp
   [Authorize(Roles = "Администратор")]
   public IActionResult AdminPanel()
   {
       // ...
   }
   ```

   В этом примере доступ к действию `AdminPanel` разрешен только пользователям, принадлежащим к роли "Администратор".

4. **Используйте `User.IsInRole()` для проверки роли в коде:** Вы можете проверить, принадлежит ли пользователь к определенной роли, используя метод `User.IsInRole()` внутри контроллера или представления.

   ```csharp
   public IActionResult SomeAction()
   {
       if (User.IsInRole("Менеджер"))
       {
           // ...
       }

       return View();
   }
   ```

### Политика авторизации

Политика авторизации — более гибкий подход, позволяющий определять сложные правила авторизации.

1. **Определите требования:** Требования — это условия, которым должен соответствовать пользователь, чтобы получить доступ к ресурсу. Например, требование "Возраст" может проверять возраст пользователя.

2. **Создайте политики:** Политика — это набор требований, объединенных логикой.  Для создания политик используется класс `AuthorizationPolicyBuilder`.

   ```csharp
   builder.Services.AddAuthorization(options =>
   {
       options.AddPolicy("MinimumAge", policy =>
           policy.Requirements.Add(new MinimumAgeRequirement(18)));
   });
   ```

   В этом примере создается политика "MinimumAge", которая требует, чтобы пользователь был старше 18 лет.

3. **Создайте обработчики требований:** Обработчик требований — это класс, реализующий интерфейс `IAuthorizationHandler`, который отвечает за проверку выполнения требований политики.

   ```csharp
   public class MinimumAgeRequirement : IAuthorizationRequirement
   {
       public int MinimumAge { get; }

       public MinimumAgeRequirement(int minimumAge)
       {
           MinimumAge = minimumAge;
       }
   }

   public class MinimumAgeHandler : AuthorizationHandler<MinimumAgeRequirement>
   {
       protected override Task HandleRequirementAsync(AuthorizationHandlerContext context,
           MinimumAgeRequirement requirement)
       {
           var dateOfBirthClaim = context.User.FindFirst(c => c.Type == ClaimTypes.DateOfBirth);

           if (dateOfBirthClaim != null && DateTime.TryParse(dateOfBirthClaim.Value, out var dateOfBirth))
           {
               var age = DateTime.Today.Year - dateOfBirth.Year;

               if (age >= requirement.MinimumAge)
               {
                   context.Succeed(requirement);
               }
           }

           return Task.CompletedTask;
       }
   }
   ```

4. **Используйте атрибут `[Authorize]` с именем политики:** Для применения политики используйте атрибут `[Authorize]` с именем созданной политики.

   ```csharp
   [Authorize(Policy = "MinimumAge")]
   public IActionResult AdultContent()
   {
       // ...
   }
   ```

   В этом примере доступ к действию `AdultContent` разрешен только пользователям, соответствующим требованиям политики "MinimumAge".

### Дополнительные возможности

ASP.NET Core предоставляет множество дополнительных возможностей для работы с авторизацией, таких как:

* **Ресурсные фильтры:** Позволяют централизовать логику авторизации для контроллеров или действий.
* **Кастомная авторизация:** Вы можете создавать собственные обработчики авторизации для реализации сложной логики доступа.

### Заключение

Авторизация — важный аспект безопасности любого веб-приложения. ASP.NET Core 8.0 предоставляет мощные и гибкие инструменты для реализации различных сценариев авторизации, помогая вам контролировать доступ к вашим ресурсам и данным. 

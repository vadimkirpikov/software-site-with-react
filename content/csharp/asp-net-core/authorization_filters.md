## Фильтры авторизации в ASP.NET Core

Фильтры авторизации в ASP.NET Core позволяют контролировать доступ пользователей к ресурсам приложения. Они определяют, разрешено ли пользователю выполнять определенное действие, например, просмотр страницы, отправка формы или доступ к API. 

Фильтры авторизации выполняются до фильтров ресурсов, что позволяет предотвратить выполнение неавторизованных запросов. Если запрос не проходит авторизацию, остальные этапы обработки запроса пропускаются.

### Типы фильтров авторизации

В ASP.NET Core доступны следующие типы фильтров авторизации:

* **AuthorizeAttribute:** Базовый класс для всех фильтров авторизации. Используется для указания того, что ресурс требует авторизации.
* **AllowAnonymousAttribute:** Позволяет обойти авторизацию для определенного действия или контроллера.
* **RequireClaimAttribute:** Проверяет наличие у пользователя определенного утверждения (claim).
* **RequireRoleAttribute:** Проверяет, принадлежит ли пользователь к определенной роли.
* **Custom authorization filters:** Позволяют создавать собственные фильтры авторизации с кастомной логикой.

### Использование атрибута Authorize

Атрибут `AuthorizeAttribute` можно применять на уровне действия, контроллера или глобально. 

**Пример использования на уровне действия:**

```C#
[Authorize]
public IActionResult Profile()
{
    // ... логика действия
}
```

В этом примере доступ к действию `Profile` будет разрешен только авторизованным пользователям.

**Пример использования на уровне контроллера:**

```C#
[Authorize]
public class UserController : Controller
{
    // ... действия контроллера
}
```

В этом случае все действия контроллера `UserController` будут требовать авторизации.

**Пример глобальной настройки авторизации:**

```C#
// В файле Program.cs
builder.Services.AddAuthorization(options =>
{
    options.FallbackPolicy = new AuthorizationPolicyBuilder()
        .RequireAuthenticatedUser()
        .Build();
});
```

Этот код требует авторизации для всех запросов к приложению.

### Использование атрибута AllowAnonymous

Атрибут `AllowAnonymousAttribute` позволяет разрешить доступ к определенному действию или контроллеру без авторизации, даже если на уровне контроллера или приложения настроена авторизация.

```C#
[Authorize]
public class UserController : Controller
{
    [AllowAnonymous]
    public IActionResult Login()
    {
        // ... логика действия
    }
}
```

В этом примере доступ к действию `Login` будет разрешен всем пользователям, независимо от их авторизации.

### Работа с политиками авторизации

Политики авторизации - это более гибкий способ настройки доступа к ресурсам. Они позволяют определять требования к авторизации, которые проверяются при каждом запросе.

#### Создание политики авторизации:

```C#
builder.Services.AddAuthorization(options =>
{
    options.AddPolicy("AdminOnly", policy =>
        policy.RequireRole("Admin"));
});
```

Этот код создает политику авторизации с именем `AdminOnly`, которая требует, чтобы пользователь принадлежал к роли `Admin`.

#### Использование политики авторизации:

```C#
[Authorize(Policy = "AdminOnly")]
public IActionResult AdminPanel()
{
    // ... логика действия
}
```

В этом примере доступ к действию `AdminPanel` будет разрешен только пользователям, которые удовлетворяют политике авторизации `AdminOnly`, то есть принадлежат к роли `Admin`.

### Создание пользовательских фильтров авторизации

Для создания кастомного фильтра авторизации необходимо создать класс, реализующий интерфейс `IAuthorizationFilter`. 

```C#
public class CustomAuthorizationFilter : IAuthorizationFilter
{
    public void OnAuthorization(AuthorizationFilterContext context)
    {
        // ... логика авторизации

        if (!isAuthorized)
        {
            context.Result = new ForbidResult();
        }
    }
}
```

В методе `OnAuthorization` выполняется логика авторизации. Если авторизация не пройдена, устанавливается `ForbidResult`, который возвращает код ответа 403 (Forbidden).

#### Регистрация пользовательского фильтра:

```C#
builder.Services.AddControllersWithViews(options =>
{
    options.Filters.Add(typeof(CustomAuthorizationFilter));
});
```

Этот код регистрирует фильтр `CustomAuthorizationFilter` для всех контроллеров.

### Заключение

Фильтры авторизации являются важной частью безопасности приложений ASP.NET Core. Они позволяют контролировать доступ пользователей к ресурсам и предотвращать несанкционированный доступ. Используйте различные типы фильтров авторизации и политики авторизации, чтобы настроить  безопасность приложения в соответствии с вашими требованиями.

## Транзакции в SQLite

Транзакции - это механизм, гарантирующий, что ряд операций с базой данных будет выполнен как единое целое: либо все операции будут успешно завершены, либо ни одна из них не будет применена. Это свойство транзакций называется **атомарностью**.

SQLite, будучи встраиваемой базой данных, поддерживает транзакции, обеспечивая надежность и целостность данных. В этой статье мы рассмотрим основные аспекты работы с транзакциями в SQLite версии 3.43.

### Типы транзакций

В SQLite существует два типа транзакций:

1. **Явные транзакции:** Начинаются и завершаются пользователем с помощью команд `BEGIN TRANSACTION` и `COMMIT` (или `ROLLBACK`). 

2. **Неявные транзакции:** Автоматически запускаются SQLite для каждого выражения SQL, которое изменяет данные, если явная транзакция не активна.

### Управление транзакциями

#### Начало транзакции

Для начала явной транзакции используется команда `BEGIN TRANSACTION`:

```sql
BEGIN TRANSACTION;
-- SQL-операции, которые должны быть выполнены в рамках транзакции
```

#### Завершение транзакции

Существует два способа завершения транзакции:

* **`COMMIT`**: Применяет все изменения, сделанные в рамках транзакции, к базе данных.
```sql
COMMIT;
```

* **`ROLLBACK`**: Отменяет все изменения, сделанные в рамках транзакции. База данных возвращается к состоянию, которое было до начала транзакции.
```sql
ROLLBACK;
```

#### Пример явной транзакции

Рассмотрим пример работы с транзакцией:

```sql
-- Начало транзакции
BEGIN TRANSACTION;

-- Добавление нового пользователя
INSERT INTO users (name, email) VALUES ('Иван', 'ivan@example.com');

-- Обновление информации о пользователе
UPDATE users SET email = 'ivan.ivanov@example.com' WHERE name = 'Иван';

-- Завершение транзакции с применением изменений
COMMIT;
```

В этом примере, если бы во время выполнения `UPDATE` произошла ошибка, то ни `INSERT`, ни `UPDATE` не были бы применены к базе данных благодаря команде `ROLLBACK`, выполненной автоматически в случае ошибки.

### Состояния транзакций

Транзакция в SQLite может находиться в одном из следующих состояний:

| Состояние | Описание |
|---|---|
| **Неактивна** |  Транзакция не запущена. |
| **Активна** |  Транзакция запущена и ожидает завершения. |
| **Завершена** |  Все изменения в транзакции успешно выполнены и готовы к применению. |

### Уровни изоляции транзакций

Уровень изоляции транзакции определяет, как транзакции взаимодействуют друг с другом и с данными, к которым они обращаются. SQLite поддерживает следующие уровни изоляции:

* **READ UNCOMMITTED:** Позволяет транзакциям считывать данные, которые были изменены, но еще не зафиксированы другими транзакциями.
* **READ COMMITTED (по умолчанию):** Гарантирует, что транзакция увидит только зафиксированные изменения, сделанные другими транзакциями.
* **SERIALIZABLE:** Обеспечивает самый высокий уровень изоляции, гарантируя, что одновременное выполнение транзакций будет эквивалентно их последовательному выполнению.

#### Установка уровня изоляции

Для установки уровня изоляции используется команда `PRAGMA read_uncommitted`. По умолчанию SQLite использует уровень изоляции `READ COMMITTED`.

```sql
-- Включение режима READ UNCOMMITTED
PRAGMA read_uncommitted = ON;

-- Выключение режима READ UNCOMMITTED (возврат к READ COMMITTED)
PRAGMA read_uncommitted = OFF;
```

### Автоматическая обработка ошибок

SQLite автоматически откатывает транзакции в случае следующих ошибок:

* Ошибки операционной системы, такие как ошибки диска или нехватка памяти.
* Ошибки базы данных, такие как нарушение ограничений целостности.
* Явный вызов `ROLLBACK`.

### Точки сохранения

Точки сохранения позволяют откатить транзакцию к определенной точке внутри нее, не откатывая всю транзакцию целиком. 

#### Создание точки сохранения

```sql
SAVEPOINT имя_точки_сохранения;
```

#### Откат к точке сохранения

```sql
ROLLBACK TO SAVEPOINT имя_точки_сохранения;
```

#### Пример использования точки сохранения

```sql
BEGIN TRANSACTION;
INSERT INTO users (name, email) VALUES ('Петр', 'petr@example.com');
SAVEPOINT after_insert;
UPDATE users SET email = 'petr.petrov@example.com' WHERE name = 'Петр';
-- Произошла ошибка, откат к точке after_insert
ROLLBACK TO SAVEPOINT after_insert;
-- Транзакция все еще активна, можно продолжить работу
COMMIT;
```

### Заключение

Транзакции являются неотъемлемым инструментом для обеспечения целостности и надежности данных в SQLite. Понимание того, как работают транзакции, их типы, состояния, уровни изоляции и способы управления ими, позволит вам создавать более надежные и безопасные приложения, работающие с базами данных SQLite. 

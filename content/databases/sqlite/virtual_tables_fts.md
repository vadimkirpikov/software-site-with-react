## Виртуальные таблицы и FTS в SQLite

SQLite предоставляет механизм виртуальных таблиц, которые, в отличие от обычных таблиц, не хранят данные непосредственно в базе данных. Вместо этого, они предоставляют абстрактный интерфейс для доступа к данным, которые могут быть расположены в памяти, файлах или даже генерироваться "на лету".

Одним из ключевых применений виртуальных таблиц является реализация полнотекстового поиска (FTS) с помощью модуля **FTS5**. FTS5 позволяет индексировать текстовые данные и выполнять быстрый поиск по ключевым словам, даже с учетом морфологии.

### Создание и использование виртуальных таблиц

Для создания виртуальной таблицы используется команда `CREATE VIRTUAL TABLE` с указанием имени таблицы, используемого модуля виртуальной таблицы и параметров модуля.

```sql
-- Создание виртуальной таблицы FTS5 для индексации документов
CREATE VIRTUAL TABLE documents_fts USING fts5(
    title,  -- Заголовок документа
    content -- Содержимое документа
);
```

Работа с виртуальными таблицами практически не отличается от работы с обычными таблицами. Вы можете добавлять, изменять, удалять и искать данные с помощью стандартных SQL-запросов:

```sql
-- Добавление документа в индекс
INSERT INTO documents_fts(title, content) VALUES (
    'Введение в SQLite',
    'SQLite - это легковесная встраиваемая база данных...'
);

-- Поиск документов по ключевому слову
SELECT * FROM documents_fts WHERE content MATCH 'база данных';
```

### Модуль FTS5

FTS5 предоставляет широкие возможности для настройки и оптимизации полнотекстового поиска:

* **Токенизация:** Разбиение текста на отдельные слова или фразы (токены) с учетом пунктуации, регистра и других особенностей языка.
* **Стемминг:** Приведение слов к их основе (например, "кошками" -> "кошка") для поиска по всем формам слова.
* **Ранжирование:** Сортировка результатов поиска по релевантности, учитывая частоту встречаемости слов, близость слов в документе и другие факторы.

### Настройка FTS5

Параметры модуля FTS5 позволяют настраивать его поведение при создании виртуальной таблицы:

* **tokenizers:** Указывает используемый токенизатор. По умолчанию используется токенизатор `simple`, который разбивает текст по пробелам и знакам препинания.
* **stemmer:**  Указывает используемый алгоритм стемминга.  FTS5 поддерживает несколько алгоритмов, включая `porter` (английский) и `snowball` (многоязычный).
* **columnsize=0:**  Отключает хранение данных столбца в таблице индекса FTS.  Полезно для экономии места, если данные столбца доступны из другой таблицы.

Пример создания виртуальной таблицы FTS5 с использованием стеммера `porter` и отключенным хранением данных столбца `content`:

```sql
CREATE VIRTUAL TABLE documents_fts USING fts5(
    title,
    content,
    content_rowid,  -- ID документа для связи с другой таблицей
    tokenize=porter,
    columnsize=0
);
```

### Поиск с использованием FTS5

FTS5 предоставляет специальный оператор `MATCH` для выполнения полнотекстового поиска.

**Базовый синтаксис:**

```sql
SELECT * FROM documents_fts WHERE content MATCH 'поиск';
```

**Поиск фраз:**

```sql
SELECT * FROM documents_fts WHERE content MATCH '"база данных"'; 
```

**Логические операторы:**

```sql
-- Поиск документов, содержащих "база" ИЛИ "данные"
SELECT * FROM documents_fts WHERE content MATCH 'база OR данные'; 

-- Поиск документов, содержащих "база" И "данные"
SELECT * FROM documents_fts WHERE content MATCH 'база AND данные';

-- Поиск документов, содержащих "база", но НЕ "данные"
SELECT * FROM documents_fts WHERE content MATCH 'база NOT данные';
```

**Префиксный поиск:**

```sql
-- Поиск документов, содержащих слова, начинающиеся на "баз"
SELECT * FROM documents_fts WHERE content MATCH 'баз*';
```

### Дополнительные возможности FTS5

* **Ранжирование результатов:** FTS5 может ранжировать результаты поиска по релевантности.
* **Близость слов:** Поиск документов, в которых искомые слова находятся близко друг к другу.
* **Синтаксический поиск:** Поиск по определенным частям речи (например, поиск только существительных).

### Заключение

Виртуальные таблицы и FTS5 предоставляют мощный механизм для реализации полнотекстового поиска в SQLite.  FTS5 предлагает гибкую настройку и оптимизацию, позволяя создавать эффективные поисковые системы для различных приложений. 

Более подробную информацию о FTS5 и его возможностях можно найти в официальной документации SQLite: [https://www.sqlite.org/fts5.html](https://www.sqlite.org/fts5.html) 

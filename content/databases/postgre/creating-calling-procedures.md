## Создание и вызов хранимых процедур

Хранимые процедуры в PostgreSQL представляют собой блоки кода SQL, которые сохраняются на сервере базы данных и могут быть вызваны по имени. Это позволяет:

* **Повторно использовать код:**  Хранимые процедуры позволяют писать код один раз и использовать его многократно, что сокращает дублирование кода и повышает его maintainability.
* **Улучшить производительность:**  Вызов хранимой процедуры обычно быстрее, чем отправка эквивалентного SQL-запроса, так как код уже скомпилирован и оптимизирован.
* **Повысить безопасность:**  Хранимые процедуры позволяют ограничить доступ к данным, предоставляя пользователям доступ только к процедуре, а не к самим данным.

### Создание хранимой процедуры

Для создания хранимой процедуры используется команда `CREATE PROCEDURE`.

```sql
CREATE PROCEDURE имя_процедуры ( [ [аргумент_1 тип_данных_1], ...] ] )
LANGUAGE язык_процедуры
AS $$
-- Тело процедуры
$$;
```

* **имя_процедуры:** Имя создаваемой процедуры.
* **аргумент_1:** Имя аргумента.
* **тип_данных_1:** Тип данных аргумента.
* **язык_процедуры:** Язык программирования, на котором написана процедура. PostgreSQL поддерживает несколько языков, включая SQL, PL/pgSQL, PL/Python и другие.
* **Тело процедуры:** Код процедуры, заключенный в символы `$$`.

#### Пример создания простой процедуры:

```sql
CREATE PROCEDURE add_numbers(num1 INT, num2 INT)
LANGUAGE plpgsql
AS $$
BEGIN
  SELECT num1 + num2;
END;
$$;
```

Эта процедура принимает два целых числа (`num1` и `num2`) и возвращает их сумму.

### Типы аргументов

Хранимые процедуры могут принимать аргументы различных типов:

* **IN:** Аргумент только для чтения. Значение передается в процедуру, но изменения значения внутри процедуры не влияют на исходную переменную.
* **OUT:** Аргумент только для записи. Используется для возврата значения из процедуры.
* **INOUT:** Аргумент для чтения и записи. Значение передается в процедуру, может быть изменено внутри процедуры, и изменения влияют на исходную переменную.

Если тип аргумента не указан, по умолчанию используется тип **IN**.

### Возврат значений

Хранимые процедуры могут возвращать значения различными способами:

* **SELECT:** Процедура может выполнять один или несколько операторов `SELECT` для возврата наборов результатов.
* **OUT параметры:** Процедура может использовать `OUT` параметры для возврата одного или нескольких значений.
* **RETURN:** Процедура может использовать оператор `RETURN` для возврата одного значения.

#### Пример процедуры с OUT параметром:

```sql
CREATE PROCEDURE get_employee_salary(emp_id INT, OUT salary NUMERIC)
LANGUAGE plpgsql
AS $$
BEGIN
  SELECT emp_salary INTO salary
  FROM employees
  WHERE emp_id = get_employee_salary.emp_id;
END;
$$;
```

Эта процедура принимает идентификатор сотрудника (`emp_id`) и возвращает его зарплату (`salary`) через `OUT` параметр.

### Вызов хранимой процедуры

Для вызова хранимой процедуры используется команда `CALL`.

```sql
CALL имя_процедуры( [аргумент_1, ...] );
```

#### Пример вызова процедуры add_numbers:

```sql
CALL add_numbers(5, 7);
```

#### Пример вызова процедуры get_employee_salary:

```sql
CALL get_employee_salary(1, NULL);
```

В этом примере второй аргумент (`NULL`) является placeholder'ом для `OUT` параметра `salary`.

### Удаление хранимой процедуры

Для удаления хранимой процедуры используется команда `DROP PROCEDURE`.

```sql
DROP PROCEDURE имя_процедуры;
```

#### Пример удаления процедуры add_numbers:

```sql
DROP PROCEDURE add_numbers;
```

## Заключение

Хранимые процедуры являются мощным инструментом PostgreSQL, который позволяет создавать модульные, многократно используемые и безопасные блоки кода. Используя хранимые процедуры, можно упростить разработку, повысить производительность и улучшить безопасность базы данных. 

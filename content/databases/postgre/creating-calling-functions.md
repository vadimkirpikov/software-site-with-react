## Создание и вызов функций в PostgreSQL

Функции в PostgreSQL позволяют упаковывать логику SQL и многократно ее использовать. Функции могут принимать аргументы, выполнять вычисления, взаимодействовать с данными в таблицах и возвращать результаты различных типов, включая скалярные значения, наборы строк и даже другие функции.

### Создание функций

Базовый синтаксис создания функции в PostgreSQL выглядит следующим образом:

```sql
CREATE FUNCTION имя_функции ( [ аргумент1 тип_данных1, аргумент2 тип_данных2, ... ] )
RETURNS тип_возвращаемого_значения
AS $$
  -- Тело функции
$$
LANGUAGE язык_программирования;
```

- **CREATE FUNCTION** - ключевые слова, указывающие на создание новой функции.
- **имя_функции** - уникальное имя, по которому будет идентифицироваться функция.
- **аргумент** - необязательный список аргументов, передаваемых в функцию, с указанием их имен и типов данных.
- **RETURNS** - ключевое слово, указывающее на тип данных, возвращаемый функцией.
- **AS $$ ... $$** - блок кода, содержащий тело функции, заключенный в долларовые кавычки.
- **LANGUAGE** - ключевое слово, указывающее язык программирования, на котором написана функция (SQL, PL/pgSQL, Python, etc.).

**Пример:**

```sql
-- Функция для вычисления площади прямоугольника
CREATE FUNCTION calculate_area (length INTEGER, width INTEGER)
RETURNS INTEGER
AS $$
  BEGIN
    RETURN length * width;
  END;
$$
LANGUAGE plpgsql;
```

В этом примере мы создаем функцию `calculate_area`, которая принимает два аргумента типа `INTEGER` (длина и ширина) и возвращает площадь прямоугольника как значение типа `INTEGER`. Тело функции написано на языке PL/pgSQL и заключено в блок `BEGIN ... END`.

### Вызов функций

После создания функции ее можно вызывать в различных контекстах SQL-запросов. Синтаксис вызова функции аналогичен вызову встроенных функций PostgreSQL:

```sql
SELECT имя_функции ( [ аргумент1, аргумент2, ... ] );
```

**Пример:**

```sql
-- Вычисление площади прямоугольника со сторонами 5 и 10
SELECT calculate_area(5, 10);

-- Результат: 50
```

Функции также можно использовать в выражениях `WHERE`, `HAVING`, `ORDER BY` и других частях SQL-запросов.

**Пример:**

```sql
-- Выбор всех заказов, общая стоимость которых превышает 1000
SELECT * FROM orders WHERE calculate_total_order_amount(order_id) > 1000;
```

### Типы возвращаемых значений

Функции могут возвращать значения различных типов данных, включая:

- Скалярные типы (INTEGER, TEXT, BOOLEAN, etc.)
- Составные типы (записи таблиц)
- Массивы
- Рефыкурсоры

**Пример функции, возвращающей набор строк:**

```sql
-- Функция для получения всех клиентов из определенного города
CREATE FUNCTION get_customers_by_city (city_name TEXT)
RETURNS TABLE (
  customer_id INTEGER,
  customer_name TEXT,
  customer_city TEXT
)
AS $$
  BEGIN
    RETURN QUERY SELECT id, name, city FROM customers WHERE city = city_name;
  END;
$$
LANGUAGE plpgsql;

-- Вызов функции и получение всех клиентов из Москвы
SELECT * FROM get_customers_by_city('Москва');
```

### Перегрузка функций

PostgreSQL поддерживает перегрузку функций, что позволяет создавать несколько функций с одинаковым именем, но с разным количеством или типами аргументов.

**Пример:**

```sql
-- Функция для вычисления площади квадрата
CREATE FUNCTION calculate_area (side INTEGER)
RETURNS INTEGER
AS $$
  BEGIN
    RETURN side * side;
  END;
$$
LANGUAGE plpgsql;
```

Теперь у нас есть две функции `calculate_area`: одна принимает два аргумента (длина и ширина), а другая - один (сторона квадрата). PostgreSQL автоматически выбирает правильную функцию для вызова, основываясь на количестве и типах переданных аргументов.

### Удаление функций

Для удаления функции используется ключевое слово `DROP FUNCTION`:

```sql
DROP FUNCTION имя_функции ( [ аргумент1 тип_данных1, аргумент2 тип_данных2, ... ] );
```

**Пример:**

```sql
DROP FUNCTION calculate_area(INTEGER, INTEGER);
```

### Заключение

Функции PostgreSQL - это мощный инструмент, позволяющий создавать многократно используемые блоки кода SQL. Они повышают гибкость и удобство разработки базы данных, а также позволяют создавать более читаемый и поддерживаемый код. 

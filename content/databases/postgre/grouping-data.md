## Группировка данных (GROUP BY) в PostgreSQL

В PostgreSQL оператор `GROUP BY` используется для группировки строк с одинаковыми значениями в одной или нескольких колонках. Это позволяет выполнять агрегатные функции, такие как `SUM`, `AVG`, `COUNT`, `MAX` и `MIN`, над каждой группой данных, а не над всей таблицей.

### Основы GROUP BY

Для использования `GROUP BY` нужно указать список колонок, по которым нужно сгруппировать данные, после предложения `GROUP BY`.  Базовый синтаксис выглядит так:

```sql
SELECT columnA, columnB, aggregate_function(columnC)
FROM table_name
WHERE condition
GROUP BY columnA, columnB
ORDER BY columnA, columnB;
```

* `columnA`, `columnB` - колонки, по которым производится группировка.
* `aggregate_function(columnC)` - агрегатная функция, применяемая к `columnC` для каждой группы.
* `condition` - необязательное условие для фильтрации строк.
* `ORDER BY` - необязательное предложение для сортировки результатов.

**Пример:**

Допустим, у нас есть таблица `orders` с информацией о заказах:

| order_id | customer_id | order_date  | total_amount |
| -------- | ----------- | ----------- | ----------- |
| 1        | 1           | 2023-10-26 | 150         |
| 2        | 2           | 2023-10-26 | 50          |
| 3        | 1           | 2023-10-27 | 100         |
| 4        | 3           | 2023-10-27 | 75          |
| 5        | 2           | 2023-10-28 | 25          |

Мы хотим узнать общую сумму заказов для каждого клиента:

```sql
SELECT customer_id, SUM(total_amount) AS total_spent
FROM orders
GROUP BY customer_id;
```

Результат:

| customer_id | total_spent |
| ----------- | ----------- |
| 1           | 250         |
| 2           | 75          |
| 3           | 75          |

### GROUP BY с несколькими колонками

Можно группировать данные по нескольким колонкам одновременно. 

**Пример:**

Хотим узнать общую сумму заказов для каждого клиента в каждый день:

```sql
SELECT customer_id, order_date, SUM(total_amount) AS daily_total
FROM orders
GROUP BY customer_id, order_date
ORDER BY customer_id, order_date;
```

Результат:

| customer_id | order_date  | daily_total |
| ----------- | ----------- | ----------- |
| 1           | 2023-10-26 | 150         |
| 1           | 2023-10-27 | 100         |
| 2           | 2023-10-26 | 50          |
| 2           | 2023-10-28 | 25          |
| 3           | 2023-10-27 | 75          |


### HAVING - фильтрация результатов GROUP BY

Предложение `HAVING` используется для фильтрации результатов **после** группировки данных оператором `GROUP BY`.  В отличие от предложения `WHERE`, которое фильтрует строки **до** группировки, `HAVING` применяется к уже сгруппированным результатам.

**Пример:**

Хотим найти клиентов, сделавших заказы на общую сумму более 100:

```sql
SELECT customer_id, SUM(total_amount) AS total_spent
FROM orders
GROUP BY customer_id
HAVING SUM(total_amount) > 100;
```

Результат:

| customer_id | total_spent |
| ----------- | ----------- |
| 1           | 250         |

### Дополнительные возможности GROUP BY

* **Группировка по выражениям:** Можно группировать не только по именам колонок, но и по результатам вычислений.
* **Использование GROUP BY в подзапросах:** `GROUP BY` можно использовать в подзапросах для выполнения агрегации перед 
  обработкой данных во внешнем запросе.
* **Комбинация с другими предложениями:** `GROUP BY` можно комбинировать с другими предложениями SQL, такими как `WHERE`, 
  `ORDER BY`, `LIMIT` и `OFFSET`, для создания сложных запросов. 

**Важно помнить:**

*  Все колонки в списке `SELECT`, не указанные в агрегатных функциях, должны быть указаны в `GROUP BY`.
*  Порядок колонок в `GROUP BY` влияет на порядок сортировки результатов.
*  `HAVING` можно использовать только с агрегатными функциями. 


Группировка данных с помощью `GROUP BY` - мощный инструмент для анализа данных в PostgreSQL. Понимание принципов его работы позволяет решать разнообразные задачи, связанные с агрегацией и анализом информации.

## Оконные функции

Оконные функции представляют собой мощный инструмент аналитической обработки данных в PostgreSQL, позволяющий выполнять вычисления на основе набора строк, связанных с текущей строкой. В отличие от агрегатных функций, оконные функции не группируют строки в результирующем наборе, а возвращают значение для каждой строки исходных данных.

### Принцип работы оконных функций

Оконные функции работают с понятием **окна** - набора строк, определяемого для каждой строки в запросе. Окно может включать в себя:

* Текущую строку.
* Строки до и после текущей строки.
* Все строки в разделе (partition).

Определение окна происходит с помощью предложения `OVER`. Внутри предложения `OVER` можно указать:

* **PARTITION BY**: Разделяет данные на группы (разделы), внутри которых вычисляется оконная функция.
* **ORDER BY**: Задает порядок строк внутри окна.
* **Ограничение строк**: Определяет границы окна относительно текущей строки.

### Синтаксис оконных функций

```sql
SELECT
  column1,
  column2,
  window_function(arguments) OVER (
    [PARTITION BY partition_expression]
    [ORDER BY sort_expression [ASC | DESC]]
    [frame_clause]
  ) AS window_function_alias
FROM
  table_name;
```

### Виды оконных функций

PostgreSQL предоставляет широкий набор встроенных оконных функций. Рассмотрим наиболее часто используемые:

#### 1. Ранжирующие функции

Ранжирующие функции позволяют присвоить ранг каждой строке в окне на основе заданного порядка.

**Функции:**

* **ROW_NUMBER()**: Возвращает порядковый номер строки в окне.
* **RANK()**: Возвращает ранг строки в окне. Одинаковые значения получают одинаковый ранг, при этом  происходит "пропуск" последующих рангов.
* **DENSE_RANK()**: Возвращает ранг строки в окне. Одинаковые значения получают одинаковый ранг, без "пропуска" последующих рангов.
* **PERCENT_RANK()**: Возвращает относительный ранг строки в окне (от 0 до 1).
* **NTILE(n)**: Разбивает строки на n групп (равных, насколько это возможно) и возвращает номер группы, к которой принадлежит строка.

**Пример:** 
Вывести список сотрудников с указанием их зарплаты и ранга внутри отдела, упорядоченного по зарплате в порядке убывания.

```sql
SELECT
  department,
  employee_name,
  salary,
  RANK() OVER (PARTITION BY department ORDER BY salary DESC) AS rank_in_department
FROM employees;
```

#### 2. Агрегирующие функции

Оконные агрегатные функции позволяют вычислять агрегатные значения (сумму, среднее, минимум, максимум и т.д.) для набора строк, определенных окном.

**Пример:**
Вывести список заказов с указанием суммы заказов по каждому клиенту.

```sql
SELECT
  customer_id,
  order_id,
  order_date,
  SUM(order_amount) OVER (PARTITION BY customer_id) AS total_customer_orders
FROM orders;
```

#### 3. Функции смещения

Функции смещения позволяют получать значения из строк, смещенных относительно текущей строки на заданное количество позиций.

**Функции:**

* **LAG(expression, offset, default_value)**: Возвращает значение `expression` из строки, расположенной на `offset` строк **выше** текущей строки.
* **LEAD(expression, offset, default_value)**: Возвращает значение `expression` из строки, расположенной на `offset` строк **ниже** текущей строки.
* **FIRST_VALUE(expression)**: Возвращает первое значение `expression` в окне.
* **LAST_VALUE(expression)**: Возвращает последнее значение `expression` в окне.

**Пример:**
Вывести список продаж с указанием разницы в продажах по сравнению с предыдущим днем.

```sql
SELECT
  date,
  sales,
  sales - LAG(sales, 1, 0) OVER (ORDER BY date) AS sales_difference
FROM daily_sales;
```

### Управление границами окна

По умолчанию, если не указано ограничение строк, окно включает все строки от начала раздела до текущей строки (включительно), если определен `PARTITION BY` и порядок сортировки `ORDER BY`. В противном случае, окно включает все строки в результирующем наборе. 

Для управления границами окна можно использовать следующие конструкции:

* **ROWS BETWEEN**: Позволяет задать границы окна в терминах количества строк относительно текущей строки.

```sql
ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING -- Все строки раздела
ROWS BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING  -- От текущей строки до конца раздела
ROWS BETWEEN 2 PRECEDING AND 1 FOLLOWING -- Две строки до текущей и одна после 
```

* **RANGE BETWEEN**: Позволяет задать границы окна в терминах значений, вычисленных для каждой строки.

```sql
RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING -- Все строки раздела
RANGE BETWEEN CURRENT ROW AND UNBOUNDED FOLLOWING -- От текущей строки до конца раздела
RANGE BETWEEN 10 PRECEDING AND 10 FOLLOWING -- Строки, значения которых находятся в пределах 10 от текущей строки
```

### Пример использования оконных функций с ограничением строк

Вывести список студентов с указанием их среднего балла за последние 3 экзамена.

```sql
SELECT
  student_id,
  exam_date,
  score,
  AVG(score) OVER (PARTITION BY student_id ORDER BY exam_date DESC ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING) AS avg_score_last_3_exams
FROM student_scores;
```

В этом примере `ROWS BETWEEN CURRENT ROW AND 2 FOLLOWING` ограничивает окно тремя последними экзаменами для каждого студента.

### Заключение

Оконные функции - мощный инструмент аналитической обработки данных в PostgreSQL. Они позволяют выполнять сложные вычисления на наборах строк, связанных с текущей строкой, без необходимости использования подзапросов или соединений.  Умение эффективно использовать оконные функции значительно расширяет ваши возможности по анализу данных. 

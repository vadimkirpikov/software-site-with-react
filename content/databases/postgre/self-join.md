## Самосоединение таблицы (Self-join) в PostgreSQL

Самосоединение (self-join) - это разновидность соединения таблиц, в которой таблица соединяется сама с собой. Такой прием может оказаться полезным, когда нужно сравнить строки одной таблицы между собой на основе значений в разных столбцах. 

### Как работает самосоединение

При самосоединении создается временная копия таблицы, после чего выполняется обычное соединение между оригинальной таблицей и ее копией.  Для различения копий таблицы в запросе им назначаются **псевдонимы (aliases)**.

### Пример использования самосоединения

Рассмотрим пример. Допустим, у нас есть таблица `employees`, в которой хранятся данные о сотрудниках:

| id | name | department_id | manager_id |
|---|---|---|---|
| 1 | Иван | 1 | NULL |
| 2 | Мария | 1 | 1 |
| 3 | Петр | 2 | 1 |
| 4 | Елена | 2 | 3 |
| 5 | Андрей | 1 | 2 |

Предположим, нам нужно получить список всех сотрудников вместе с именем их менеджера.  

В этой ситуации мы можем использовать самосоединение. 

1. **Назначаем псевдонимы таблицам:**

    ```sql
    SELECT e.name AS employee_name, m.name AS manager_name
    FROM employees e, employees m -- 'e' для сотрудников, 'm' для менеджеров
    -- ...
    ```
2. **Устанавливаем условие соединения:**

    ```sql
    SELECT e.name AS employee_name, m.name AS manager_name
    FROM employees e, employees m
    WHERE e.manager_id = m.id -- Соединяем по id менеджера и id сотрудника
    -- ...
    ```

    В данном случае мы соединяем таблицу `employees` саму с собой по полю `manager_id` в первой копии (`e`) и полю `id` во второй копии (`m`). 
3. **Дополняем запрос необходимыми полями:**

    ```sql
    SELECT 
        e.id AS employee_id, 
        e.name AS employee_name, 
        m.id AS manager_id,
        m.name AS manager_name
    FROM employees e, employees m
    WHERE e.manager_id = m.id;
    ```

В результате выполнения запроса мы получим следующую таблицу:

| employee_id | employee_name | manager_id | manager_name |
|---|---|---|---|
| 2 | Мария | 1 | Иван |
| 3 | Петр | 1 | Иван |
| 4 | Елена | 3 | Петр |
| 5 | Андрей | 2 | Мария |

### Самосоединение с использованием JOIN

Вышеописанный запрос можно переписать с использованием конструкции `JOIN`:

```sql
SELECT 
    e.id AS employee_id, 
    e.name AS employee_name, 
    m.id AS manager_id,
    m.name AS manager_name
FROM employees e
JOIN employees m ON e.manager_id = m.id;
```

### Самосоединение с LEFT JOIN

Если мы хотим включить в результирующую таблицу всех сотрудников, в том числе и тех, у кого нет менеджера (значение `manager_id` равно `NULL`), можно использовать `LEFT JOIN`:

```sql
SELECT 
    e.id AS employee_id, 
    e.name AS employee_name, 
    m.id AS manager_id,
    m.name AS manager_name
FROM employees e
LEFT JOIN employees m ON e.manager_id = m.id;
```

В этом случае, если у сотрудника нет менеджера, в соответствующих полях `manager_id` и `manager_name` будут стоять значения `NULL`.

### Заключение

Самосоединение - мощный инструмент, который позволяет решать нетривиальные задачи, связанные со сравнением данных внутри одной таблицы. Используйте его с умом, чтобы извлекать максимум пользы из ваших данных. 

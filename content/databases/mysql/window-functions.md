## Оконные функции в MySQL

Оконные функции в MySQL, появившиеся в версии 8.0, представляют мощный инструмент для выполнения вычислений по набору строк, связанных определенным условием, которые называются "окном". В отличие от агрегатных функций, оконные функции не объединяют строки в одну, а возвращают вычисленное значение для каждой строки в окне.

### Основные понятия

* **Окно (Window):** набор строк, для которых выполняется оконная функция.
* **Функция разделения на разделы (Partition By):**  позволяет разбить набор данных на группы (разделы), для каждой из которых оконная функция будет выполняться независимо.
* **Порядок строк (Order By):**  определяет порядок строк в рамках окна.
* **Кадр (Frame):**  подмножество строк внутри окна, используемое для вычисления значения оконной функции.

### Синтаксис

```sql
SELECT 
    column1, 
    column2, 
    window_function(expression) OVER (
        [PARTITION BY partition_expression]
        [ORDER BY order_expression [ASC|DESC]]
        [frame_clause]
    ) AS alias
FROM table_name;
```

* **window_function(expression)**: оконная функция с выражением для вычисления.
* **PARTITION BY partition_expression**:  необязательное предложение, разделяющее строки на разделы.
* **ORDER BY order_expression [ASC|DESC]**:  необязательное предложение, задающее порядок строк в окне.
* **frame_clause**:  необязательное предложение, определяющее кадр.

### Типы оконных функций

MySQL 8.4 поддерживает следующие типы оконных функций:

* **Агрегирующие функции**: SUM(), AVG(), COUNT(), MIN(), MAX() и другие.
* **Ранжирующие функции**:  RANK(), DENSE_RANK(), ROW_NUMBER(), NTILE().
* **Функции смещения**: LEAD(), LAG(), FIRST_VALUE(), LAST_VALUE(), NTH_VALUE().

### Примеры использования

#### Пример 1: Расчет суммы продаж по категориям

Допустим, у нас есть таблица `orders` со столбцами `order_id`, `category` и `amount`. Необходимо получить для каждого заказа сумму продаж по его категории.

```sql
SELECT
    order_id,
    category,
    amount,
    SUM(amount) OVER (PARTITION BY category) AS total_category_amount
FROM orders;
```

В этом примере функция `SUM(amount)` вычисляет сумму значений в столбце `amount` для каждого раздела, определенного предложением `PARTITION BY category`. 

#### Пример 2:  Нахождение предыдущего значения

Допустим, нужно для каждого заказа вывести сумму предыдущего заказа в той же категории.

```sql
SELECT
    order_id,
    category,
    amount,
    LAG(amount, 1, 0) OVER (PARTITION BY category ORDER BY order_id) AS previous_amount
FROM orders;
```

Функция `LAG(amount, 1, 0)` возвращает значение столбца `amount` из предыдущей строки (смещение 1). Третий аргумент `0` указывает значение по умолчанию, если предыдущей строки нет.  

#### Пример 3:  Использование кадра

Допустим, нужно получить для каждого заказа сумму продаж в его категории за последние 3 дня, включая текущий.

```sql
SELECT
    order_date,
    category,
    amount,
    SUM(amount) OVER (PARTITION BY category ORDER BY order_date ASC ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS rolling_sum
FROM orders;
```

В этом примере предложение `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW` определяет кадр, включающий текущую строку и 2 строки перед ней.

### Заключение

Оконные функции в MySQL предоставляют широкие возможности для анализа данных и выполнения сложных вычислений.  Они позволяют избежать self-join и подзапросов, что может значительно улучшить производительность запросов.

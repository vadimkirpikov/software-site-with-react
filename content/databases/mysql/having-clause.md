## Фильтрация групп (HAVING) в MySQL

В языке SQL, предложение `HAVING` используется для фильтрации результатов после группировки строк с помощью предложения `GROUP BY`. В то время как предложение `WHERE` фильтрует строки **перед** группировкой, `HAVING` работает с уже **сгруппированными** данными.

### Зачем нужен HAVING?

Представьте, что у вас есть таблица с заказами, и вам нужно найти клиентов, которые сделали заказов на общую сумму более 1000 рублей. Вы можете использовать `GROUP BY`, чтобы сгруппировать заказы по клиентам, а затем использовать `HAVING` для фильтрации тех клиентов, сумма заказов которых превышает 1000.

### Синтаксис HAVING

Общий синтаксис предложения `HAVING`:

```sql
SELECT column1, column2, ...
FROM table_name
WHERE condition
GROUP BY column1, column2, ...
HAVING condition;
```

Разберем синтаксис по частям:

- **SELECT column1, column2, ...:**  Список столбцов, которые вы хотите получить в результате.
- **FROM table_name:** Имя таблицы, из которой выбираются данные.
- **WHERE condition:**  (опционально) Условие для фильтрации строк **перед** группировкой.
- **GROUP BY column1, column2, ...:** Список столбцов, по которым будут группироваться данные.
- **HAVING condition:** Условие для фильтрации **сгруппированных** данных.

### Пример использования HAVING

Давайте рассмотрим пример, используя таблицу `orders` со следующими данными:

| order_id | customer_id | amount |
|---|---|---|
| 1 | 1 | 100 |
| 2 | 2 | 250 |
| 3 | 1 | 500 |
| 4 | 3 | 150 |
| 5 | 2 | 100 |

**Задача:**  Найти клиентов, общая сумма заказов которых превышает 200 рублей.

```sql
SELECT customer_id, SUM(amount) AS total_amount
FROM orders
GROUP BY customer_id
HAVING total_amount > 200;
```

**Разберем запрос по шагам:**

1. **SELECT customer_id, SUM(amount) AS total_amount:** Выбираем столбец `customer_id` и сумму по столбцу `amount` с алиасом `total_amount`.
2. **FROM orders:** Указываем таблицу `orders` как источник данных.
3. **GROUP BY customer_id:** Группируем заказы по `customer_id`.
4. **HAVING total_amount > 200:** Фильтруем сгруппированные данные, оставляя только те группы, где `total_amount` (сумма заказов) больше 200.

**Результат:**

| customer_id | total_amount |
|---|---|
| 1 | 600 |
| 2 | 350 |

### HAVING vs WHERE

Важно понимать разницу между `HAVING` и `WHERE`.  `WHERE` фильтрует строки **до** группировки, а `HAVING` фильтрует **уже сгруппированные** данные.  

**Пример:**

**Задача:** Найти клиентов, у которых есть заказы на сумму более 100 рублей **и** общая сумма заказов которых превышает 200 рублей.

```sql
SELECT customer_id, SUM(amount) AS total_amount
FROM orders
WHERE amount > 100 -- Фильтр на уровне строк
GROUP BY customer_id
HAVING total_amount > 200; -- Фильтр на уровне групп
```

В этом запросе:

- `WHERE amount > 100` отберет только те заказы, где сумма (`amount`) больше 100.
- `GROUP BY customer_id` сгруппирует отфильтрованные заказы по клиенту.
- `HAVING total_amount > 200` оставит только те группы, где общая сумма (`total_amount`) больше 200.

### Дополнительные возможности HAVING

- Вы можете использовать `HAVING` с агрегатными функциями, такими как `COUNT`, `AVG`, `MAX`, `MIN` и т.д. 
- Вы можете комбинировать несколько условий в `HAVING`, используя логические операторы `AND` и `OR`.

### Заключение

`HAVING` - это мощное предложение в SQL, которое позволяет вам фильтровать сгруппированные данные. Используйте его вместе с `GROUP BY` для выполнения сложного анализа и получения нужной информации из ваших данных. 

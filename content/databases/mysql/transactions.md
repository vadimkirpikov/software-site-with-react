## Транзакции в MySQL: BEGIN TRANSACTION, COMMIT, ROLLBACK

Транзакции являются неотъемлемой частью работы с реляционными базами данных, обеспечивая надежность и целостность данных. В MySQL транзакция представляет собой логическую единицу работы, состоящую из одного или нескольких SQL-запросов, которые выполняются как единое целое. Это означает, что либо все запросы в транзакции выполняются успешно, либо ни один из них не вносит изменений в базу данных.

### Основные понятия

* **ACID:** Транзакции в MySQL подчиняются свойствам ACID (Atomicity, Consistency, Isolation, Durability):
    * **Атомарность (Atomicity):** Транзакция представляет собой неделимую единицу работы. 
    * **Согласованность (Consistency):** Транзакция переводит базу данных из одного согласованного состояния в другое, сохраняя целостность данных.
    * **Изолированность (Isolation):** Транзакции изолированы друг от друга, что предотвращает конфликты данных.
    * **Долговечность (Durability):** После успешного завершения транзакции внесенные изменения сохраняются в базе данных, даже в случае сбоев.
* **Уровни изоляции транзакций:** MySQL поддерживает различные уровни изоляции транзакций, которые определяют степень изоляции транзакций друг от друга.

### Управление транзакциями

Для управления транзакциями в MySQL используются следующие операторы:

* **BEGIN TRANSACTION / START TRANSACTION:** Начало новой транзакции.
* **COMMIT:** Завершение транзакции и сохранение всех изменений.
* **ROLLBACK:** Откат транзакции и отмена всех изменений, сделанных с момента ее начала.

### Пример использования транзакций

Предположим, у нас есть таблица `accounts`, содержащая информацию о банковских счетах:

| account_id | balance |
|---|---|
| 1 | 1000 |
| 2 | 500 |

```sql
CREATE TABLE accounts (
  account_id INT PRIMARY KEY,
  balance INT
);

INSERT INTO accounts (account_id, balance) VALUES
(1, 1000),
(2, 500);
```

Необходимо перевести 200 единиц с счета 1 на счет 2. Без использования транзакций код может выглядеть следующим образом:

```sql
-- Списание средств со счета 1
UPDATE accounts SET balance = balance - 200 WHERE account_id = 1;

-- Зачисление средств на счет 2
UPDATE accounts SET balance = balance + 200 WHERE account_id = 2;
```

Если на этапе между этими двумя запросами произойдет сбой, средства будут списаны со счета 1, но не зачислены на счет 2. 

Использование транзакций позволяет гарантировать целостность данных:

```sql
-- Начало транзакции
START TRANSACTION;

-- Списание средств со счета 1
UPDATE accounts SET balance = balance - 200 WHERE account_id = 1;

-- Зачисление средств на счет 2
UPDATE accounts SET balance = balance + 200 WHERE account_id = 2;

-- Фиксация изменений
COMMIT;
```

В этом случае, если произойдет сбой до выполнения `COMMIT`, все изменения будут отменены. Если же `COMMIT` будет выполнен успешно, изменения будут сохранены в базе данных. 

### Откат транзакции

Для отката транзакции используется оператор `ROLLBACK`:

```sql
-- Начало транзакции
START TRANSACTION;

-- Списание средств со счета 1
UPDATE accounts SET balance = balance - 200 WHERE account_id = 1;

-- Откат изменений
ROLLBACK;
```

В этом примере изменения, сделанные первым запросом `UPDATE`, будут отменены.

### Автоматическое управление транзакциями

В MySQL 8.0 и выше по умолчанию включен режим `autocommit`. Это означает, что каждый запрос выполняется как отдельная транзакция. Для отключения этого режима и ручного управления транзакциями можно использовать команду:

```sql
SET autocommit = 0;
```

### Заключение

Транзакции являются важным инструментом для обеспечения целостности данных в MySQL. Использование транзакций позволяет группировать несколько SQL-запросов в единую логическую единицу работы, гарантируя, что все изменения будут выполнены успешно или не будут выполнены вовсе. 

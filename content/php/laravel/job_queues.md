## Создание и запуск очередей в Laravel 11

Очереди Laravel предоставляют механизм для отложенного выполнения ресурсоемких задач, тем самым ускоряя работу приложения для пользователей. Вместо ожидания завершения длительной операции, такой как отправка электронного письма или обработка изображений, приложение может поместить ее в очередь для фоновой обработки. 

### Настройка очередей

1. **Выбор драйвера очереди:** Laravel поддерживает различные драйверы очередей, такие как `database`, `redis`, `sqs` и другие. Настройка драйвера производится в файле `.env` с помощью переменной `QUEUE_CONNECTION`. Для простоты в этом примере будет использоваться драйвер `database`, который хранит задачи в базе данных.

```
QUEUE_CONNECTION=database
```

2. **Миграции:** При использовании драйвера `database` необходимо создать таблицу для хранения задач. Для этого выполните команду:

```
php artisan queue:table

php artisan migrate
```

### Создание задачи

Задачи в Laravel представляют собой классы, которые инкапсулируют логику для выполнения в фоне.

```
php artisan make:job ProcessImage
```

Эта команда создаст новый класс `ProcessImage` в директории `app/Jobs`.

### Определение логики задачи

Откройте файл `app/Jobs/ProcessImage.php` и определите логику задачи в методе `handle()`. 

```php
<?php

namespace App\Jobs;

use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Queue\SerializesModels;

class ProcessImage implements ShouldQueue
{
    use Dispatchable, InteractsWithQueue, Queueable, SerializesModels;

    /**
     * Путь к изображению.
     *
     * @var string
     */
    public $imagePath;

    /**
     * Создание нового экземпляра задачи.
     *
     * @param  string  $imagePath
     * @return void
     */
    public function __construct(string $imagePath)
    {
        $this->imagePath = $imagePath;
    }

    /**
     * Выполнение задачи.
     *
     * @return void
     */
    public function handle()
    {
        // Логика обработки изображения
        // Например, изменение размера, добавление водяного знака и т.д.
    }
}
```

### Добавление задачи в очередь

Для добавления задачи в очередь используйте метод `dispatch()`:

```php
use App\Jobs\ProcessImage;

// ...

ProcessImage::dispatch('/path/to/image.jpg');
```

### Запуск обработчика очереди

Laravel использует команду `queue:work` для запуска обработчика очереди, который будет извлекать и выполнять задачи из очереди. 

Запустите обработчик в фоне с помощью команды:

```
php artisan queue:work &
```

### Мониторинг очередей

Laravel предоставляет инструменты для мониторинга очередей, такие как:

- **queue:list**: Позволяет просмотреть список всех очередей и количество задач в каждой из них.

- **queue:failed**: Показывает список неудачных задач.

### Обработка ошибок

Laravel позволяет определить метод `failed()` в классе задачи, который будет вызван в случае возникновения ошибки во время выполнения задачи:

```php
// ...

public function failed(Throwable $exception)
{
    // Логирование ошибки, отправка уведомлений и т.д.
}
```

### Продвинутые возможности

Laravel предлагает множество дополнительных возможностей для работы с очередями, таких как:

- **Очереди с приоритетом**: Позволяют указать приоритет для каждой задачи, определяя порядок их обработки.

- **Отложенные очереди**: Позволяют запланировать запуск задачи на определенное время в будущем.

- **Цепочки задач**: Позволяют выполнять задачи последовательно, друг за другом.

- **Ограничение скорости**: Позволяет ограничить количество задач, выполняемых в секунду или минуту.

Изучив эти возможности, вы сможете создавать эффективные и масштабируемые приложения, используя асинхронную обработку задач с помощью очередей Laravel.

## Работа с индексами и внешними ключами в Laravel

Индексы и внешние ключи - важные инструменты в арсенале любого разработчика баз данных. Они обеспечивают целостность данных и повышают производительность запросов. В этой статье мы рассмотрим, как работать с индексами и внешними ключами в Laravel 11, используя миграции и Eloquent.

### Индексы: Ускорение поиска

Индексы можно сравнить с оглавлением книги. Они позволяют базе данных быстро находить нужные строки, не просматривая всю таблицу. Laravel поддерживает различные типы индексов:

* **PRIMARY KEY**:  Уникальный идентификатор строки.
* **UNIQUE**:  Гарантирует уникальность значения в столбце.
* **INDEX**:  Ускоряет поиск по столбцу.
* **FULLTEXT**:  Используется для полнотекстового поиска (MySQL, MariaDB).

#### Создание индексов в миграциях

Для добавления индекса к столбцу во время создания таблицы используйте следующие методы:

```php
public function up()
{
    Schema::create('posts', function (Blueprint $table) {
        $table->id(); // PRIMARY KEY
        $table->string('title')->index(); // INDEX
        $table->string('slug')->unique(); // UNIQUE
        $table->timestamps();
    });
}
```

Чтобы добавить индекс к существующей таблице, используйте метод `table`:

```php
public function up()
{
    Schema::table('posts', function (Blueprint $table) {
        $table->index('created_at'); // Добавляем индекс к столбцу 'created_at'
    });
}
```

#### Удаление индексов

Для удаления индексов используйте методы `dropPrimary`, `dropUnique`, `dropIndex` и `dropFulltext`. При указании имени индекса используйте формат `имя_таблицы_название_индекса`.

```php
public function down()
{
    Schema::table('posts', function (Blueprint $table) {
        $table->dropIndex('posts_created_at_index'); // Удаляем индекс 'posts_created_at_index'
    });
}
```

### Внешние ключи: Поддержание целостности данных

Внешние ключи гарантируют, что данные в одной таблице соответствуют данным в другой. Например, внешний ключ в таблице `comments`, ссылающийся на таблицу `posts`, гарантирует, что каждый комментарий привязан к существующему посту.

#### Создание внешних ключей

Для создания внешнего ключа используйте метод `foreign`.  Метод `references` указывает, на какой столбец в родительской таблице ссылается внешний ключ. Метод `on` указывает имя родительской таблицы.

```php
public function up()
{
    Schema::create('comments', function (Blueprint $table) {
        $table->id();
        $table->unsignedBigInteger('post_id');
        $table->text('content');
        $table->timestamps();
        
        $table->foreign('post_id') // Название столбца с внешним ключом
              ->references('id')  // Столбец в родительской таблице
              ->on('posts'); // Имя родительской таблицы
    });
}
```

####  Дополнительные опции внешних ключей

*  `onDelete`:  Определяет действие при удалении записи из родительской таблицы. Возможные значения: `cascade` (удалить связанные записи), `restrict` (запретить удаление), `set null` (установить значение столбца в NULL), `no action` (не предпринимать никаких действий).

* `onUpdate`: Определяет действие при обновлении записи в родительской таблице.  

Пример использования дополнительных опций:

```php
 $table->foreign('post_id')
              ->references('id')
              ->on('posts')
              ->onDelete('cascade')
              ->onUpdate('cascade');
```

#### Удаление внешних ключей

Для удаления внешнего ключа используйте метод `dropForeign`.  Имя ключа формируется по шаблону `имя_таблицы_название_столбца_foreign`.

```php
public function down()
{
    Schema::table('comments', function (Blueprint $table) {
        $table->dropForeign('comments_post_id_foreign');
    });
}
```


### Работа с индексами и внешними ключами в Eloquent

Eloquent автоматически обрабатывает внешние ключи при работе с отношениями. Например, для получения всех комментариев к посту:

```php
$comments = Post::find(1)->comments; 
```

При удалении модели с отношением `hasMany`  с опцией `onDelete('cascade')`, связанные записи будут автоматически удалены. 

### Заключение

В этой статье мы рассмотрели основы работы с индексами и внешними ключами в Laravel 11.  Используйте эти знания для повышения производительности приложений и обеспечения целостности данных. 

## Запросы с использованием Query Builder

Вместо использования чистого SQL для взаимодействия с базой данных, Laravel предлагает мощный инструмент - Query Builder.  Он представляет собой интерфейс для создания SQL-запросов на PHP, что делает код более читабельным и переносимым.

### Основы Query Builder

Каждый запрос с использованием Query Builder начинается с получения экземпляра объекта запроса. Laravel предоставляет несколько способов это сделать:

```php
use Illuminate\Support\Facades\DB;

// Получение всех записей из таблицы 'users'
$users = DB::table('users')->get();

// Получение первой записи из таблицы 'posts'
$post = DB::table('posts')->first();
```

В первом примере `DB::table('users')` создает запрос к таблице `users`. Метод `get()` выполняет запрос и возвращает коллекцию всех записей. Во втором примере `first()` возвращает только первую найденную запись.

### Выборка определенных столбцов

Для выбора определенных столбцов используется метод `select()`:

```php
// Выборка столбцов 'name' и 'email' из таблицы 'users'
$users = DB::table('users')->select('name', 'email')->get();
```

### Условия выборки

Для добавления условий выборки используются методы `where()`, `orWhere()`, `whereIn()`, `whereNotIn()` и другие.

```php
// Выборка пользователей с email 'john@example.com'
$user = DB::table('users')->where('email', '=', 'john@example.com')->first();

// Выборка пользователей с id 1 или 2
$users = DB::table('users')->whereIn('id', [1, 2])->get();

// Выборка пользователей с ролью 'admin'
$admins = DB::table('users')
    ->where('role', 'admin')
    ->get();
```

### Сортировка результатов

Сортировка результатов осуществляется с помощью метода `orderBy()`:

```php
// Выборка пользователей, отсортированных по имени в алфавитном порядке
$users = DB::table('users')->orderBy('name')->get();

// Выборка пользователей, отсортированных по дате регистрации в обратном порядке
$users = DB::table('users')->orderBy('created_at', 'desc')->get();
```

### Ограничение количества результатов

Ограничить количество возвращаемых записей можно с помощью методов `take()` и `skip()`:

```php
// Выборка 10 последних зарегистрированных пользователей
$users = DB::table('users')
    ->orderBy('created_at', 'desc')
    ->take(10)
    ->get();

// Выборка пользователей, начиная с 11-го, с лимитом 10
$users = DB::table('users')
    ->orderBy('created_at', 'desc')
    ->skip(10)
    ->take(10)
    ->get();
```

### Агрегатные функции

Query Builder поддерживает агрегатные функции, такие как `count()`, `max()`, `min()`, `avg()` и `sum()`:

```php
// Подсчет количества пользователей
$count = DB::table('users')->count();

// Получение максимального значения возраста пользователей
$maxAge = DB::table('users')->max('age');
```

### Объединение таблиц

Для выполнения запросов с объединением таблиц используются методы `join()`, `leftJoin()`, `rightJoin()` и `crossJoin()`.

```php
// Выборка всех постов и их авторов
$posts = DB::table('posts')
    ->join('users', 'posts.user_id', '=', 'users.id')
    ->select('posts.*', 'users.name as author_name')
    ->get();
```

### Вставка данных

Для вставки данных используется метод `insert()`:

```php
// Вставка новой записи в таблицу 'users'
DB::table('users')->insert([
    'name' => 'John Doe',
    'email' => 'john@example.com',
    'password' => bcrypt('password'),
]);
```

### Обновление данных

Для обновления данных используется метод `update()`:

```php
// Обновление имени пользователя с id 1
DB::table('users')
    ->where('id', 1)
    ->update(['name' => 'Jane Doe']);
```

### Удаление данных

Для удаления данных используется метод `delete()`:

```php
// Удаление пользователя с id 1
DB::table('users')->where('id', 1)->delete();
```

### Сырые выражения

Иногда возникает необходимость использовать SQL-код напрямую. В этом случае можно воспользоваться методом `raw()`:

```php
// Выборка пользователей, зарегистрированных текущем месяце
$users = DB::table('users')
    ->whereRaw('MONTH(created_at) = ?', [date('m')])
    ->get();
```

Это лишь базовые возможности Query Builder. Он предоставляет множество других методов для работы с базой данных, делая процесс разработки более удобным и эффективным. 

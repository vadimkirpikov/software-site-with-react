## Запланированные задачи (Scheduler)

В современных веб-приложениях часто возникает необходимость выполнять определенные действия по расписанию. Это могут быть задачи резервного копирования, отправки уведомлений, обновления данных и многое другое. Laravel предоставляет удобный механизм для планирования и запуска таких задач - **Scheduler**.

### Настройка планировщика

Перед использованием Scheduler необходимо убедиться, что в системе настроен планировщик задач, такой как **cron** (для Linux/Unix) или **Task Scheduler** (для Windows). Планировщик задач отвечает за запуск команды `schedule:run`  Laravel, которая, в свою очередь, проверяет и запускает запланированные задачи.

#### Настройка cron

Для настройки cron откройте файл crontab для редактирования:

```bash
crontab -e
```

Добавьте следующую строку, чтобы запускать команду `schedule:run` каждую минуту:

```
* * * * * php /path/to/your/project/artisan schedule:run >> /dev/null 2>&1
```

Замените `/path/to/your/project` на фактический путь к вашему проекту Laravel. 

### Определение запланированных задач

Все запланированные задачи определяются в файле `app/Console/Kernel.php` внутри метода `schedule()`. 

```php
<?php

namespace App\Console;

use Illuminate\Console\Scheduling\Schedule;
use Illuminate\Foundation\Console\Kernel as ConsoleKernel;

class Kernel extends ConsoleKernel
{
    /**
     * Определите запланированные задачи для приложения.
     *
     * @param  \Illuminate\Console\Scheduling\Schedule  $schedule
     * @return void
     */
    protected function schedule(Schedule $schedule)
    {
        // $schedule->command('inspire')->hourly();
    }

    // ...
}
```

Метод `schedule()` получает объект `Schedule`, который предоставляет различные методы для определения расписания и запуска задач.

### Создание задачи

#### Запуск команд Artisan

Самый простой способ определить запланированную задачу - это запустить команду Artisan по расписанию. Например, для запуска команды `inspire` каждый час можно использовать следующий код:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('inspire')->hourly();
}
```

#### Запуск замыканий

Также можно определить задачу, выполнив произвольный код PHP в замыкании. Например, для отправки уведомлений пользователям каждый день в 9 утра можно использовать следующий код:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->call(function () {
        // Код для отправки уведомлений пользователям
    })->dailyAt('09:00');
}
```

#### Частота запуска

Laravel предоставляет множество методов для определения частоты запуска задач:

| Метод       | Описание                                  |
|-------------|-------------------------------------------|
| `everyMinute()` | Каждую минуту                           |
| `everyFiveMinutes()` | Каждые пять минут                      |
| `everyTenMinutes()` | Каждые десять минут                     |
| `everyThirtyMinutes()` | Каждые тридцать минут                  |
| `hourly()`     | Каждый час                              |
| `daily()`     | Каждый день                             |
| `weekly()`    | Каждую неделю                           |
| `monthly()`   | Каждый месяц                            |
| `quarterly()` | Каждый квартал                          |
| `yearly()`    | Каждый год                             |
| `cron('* * * * *')` | Использование выражения cron           |

#### Дополнительные настройки

Помимо частоты запуска, Laravel предоставляет множество других методов для настройки задач:

| Метод       | Описание                                  |
|-------------|-------------------------------------------|
| `between()` | Запуск задачи в определенном временном интервале |
| `unlessBetween()` | Не запускать задачу в определенном временном интервале |
| `when()` | Запуск задачи при выполнении условия   |
| `skip()` | Пропуск задачи при выполнении условия  |
| `environments()` | Запуск задачи только в определенных окружениях |
| `evenInMaintenanceMode()` | Запуск задачи даже в режиме обслуживания |
| `withoutOverlapping()` | Предотвращение параллельного запуска задачи |
| `onOneServer()` | Запуск задачи только на одном сервере  |
| `emailOnFailure()` | Отправка уведомления на email при ошибке |

### Пример: Очистка логов

Давайте создадим задачу, которая будет очищать логи приложения каждый день в полночь:

1. Откройте файл `app/Console/Kernel.php`.

2. Добавьте следующий код в метод `schedule()`:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('log:clear')->daily();
}
```

Этот код запускает команду Artisan `log:clear`, которая очищает логи приложения, каждый день в полночь.

### Запуск планировщика вручную

Для запуска планировщика задач вручную можно использовать команду `schedule:run`:

```bash
php artisan schedule:run
```

Эта команда проверит все запланированные задачи и запустит те, которые должны быть выполнены в данный момент. 

### Вывод

Планировщик задач Laravel - это мощный и удобный инструмент для автоматизации рутинных операций в веб-приложениях. Он предоставляет простой и гибкий способ определения и запуска задач по расписанию, что позволяет сосредоточиться на разработке основной функциональности приложения.

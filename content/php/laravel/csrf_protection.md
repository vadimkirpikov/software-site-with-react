## Защита от CSRF

Межсайтовая подделка запроса (CSRF) - это тип веб-атаки, при которой злоумышленник пытается заставить пользователя, находящегося в системе, выполнить нежелательное действие. Это возможно, если приложение не проверяет, действительно ли запрос отправлен пользователем, а не злоумышленником.

Представьте, что злоумышленник разместил на своем сайте скрытую форму, отправляющую запрос на удаление профиля пользователя на вашем сайте. Если пользователь, авторизованный на вашем сайте, случайно откроет страницу злоумышленника, форма отправится автоматически и профиль пользователя будет удален.

Laravel предоставляет простую и эффективную защиту от CSRF атак с помощью middleware `VerifyCsrfToken`.

### Как работает защита от CSRF в Laravel?

1. При каждом запросе, Laravel генерирует уникальный CSRF токен и сохраняет его в сессии пользователя.
2. Этот токен внедряется в формы на вашем сайте с помощью директивы `@csrf`.
3. При отправке формы, Laravel сравнивает токен, отправленный с формой, с токеном, хранящимся в сессии.
4. Если токены совпадают, запрос считается легитимным. В противном случае, запрос отклоняется.

### Внедрение защиты от CSRF

Middleware `VerifyCsrfToken` уже включен в глобальный middleware стек вашего приложения. Это означает, что защита от CSRF активирована по умолчанию.

### Исключение маршрутов из защиты от CSRF

В некоторых случаях вам может потребоваться исключить определенные маршруты из защиты от CSRF. Например, при интеграции с платежными системами, которые отправляют уведомления на ваш сервер.

Чтобы исключить маршруты, добавьте их в массив `$except` middleware `VerifyCsrfToken`:

```php
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken as Middleware;

class VerifyCsrfToken extends Middleware
{
    /**
     * Маршруты, исключенные из защиты CSRF.
     *
     * @var array<int, string>
     */
    protected $except = [
        'payment/webhook',
    ];
}
```

### Добавление CSRF токена в формы

Laravel предоставляет удобную директиву Blade `@csrf` для добавления CSRF токена в формы. Просто добавьте эту директиву внутрь тега `<form>`:

```html
<form method="POST" action="/profile">
    @csrf

    <!-- Поля формы -->
</form>
```

Директива `@csrf` сгенерирует скрытое поле с CSRF токеном:

```html
<input type="hidden" name="_token" value="your-csrf-token">
```

### Ручная проверка CSRF токена

В некоторых случаях, например, при обработке AJAX запросов, вам может потребоваться проверить CSRF токен вручную. 

Для этого используйте функцию `csrf_token()`:

```javascript
fetch('/profile', {
    method: 'POST',
    headers: {
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
    },
    body: JSON.stringify({
        // Данные запроса
    })
})
.then(response => {
    // Обработка ответа
});
```

### Рекомендации по безопасности

* Всегда используйте защиту от CSRF при разработке веб-приложений.
* Не отключайте защиту от CSRF без необходимости.
* Тщательно проверяйте все запросы, поступающие извне, на наличие CSRF токена.
* Регулярно обновляйте Laravel до последней версии, чтобы использовать актуальные исправления безопасности. 

## Подготовленные запросы и защита от SQL-инъекций

Работа с базами данных — неотъемлемая часть большинства веб-приложений. PHP предоставляет удобные инструменты для взаимодействия с СУБД, однако пренебрежение вопросами безопасности может привести к серьезным уязвимостям, таким как SQL-инъекции.

### Что такое SQL-инъекция?

SQL-инъекция — это тип атаки, при которой злоумышленник внедряет произвольный SQL-код в запрос к базе данных, изменяя его логику и получая доступ к конфиденциальной информации или нарушая целостность данных. 

Рассмотрим уязвимый код, который принимает ID пользователя из GET-запроса и выводит его имя из базы данных:

```php
<?php
$userId = $_GET['id'];
$sql = "SELECT name FROM users WHERE id = $userId";
// ... выполнение запроса и вывод имени
?>
```

Атакующий может передать в качестве `id` значение `1 OR 1=1`, что изменит запрос следующим образом:

```sql
SELECT name FROM users WHERE id = 1 OR 1=1
```

В результате будут выбраны данные всех пользователей, а не только пользователя с ID 1.

### Подготовленные запросы

**Подготовленные запросы** — это механизм, позволяющий отделить SQL-код от передаваемых данных. Сначала мы определяем шаблон запроса с использованием специальных маркеров-плейсхолдеров, а затем передаем данные для этих плейсхолдеров отдельно.  

PHP обрабатывает плейсхолдеры и данные независимо, предотвращая их интерпретацию как части SQL-кода.

### Использование подготовленных запросов с PDO

PDO (PHP Data Objects) — это расширение PHP, предоставляющее абстрактный интерфейс для работы с различными СУБД. 

#### Подключение к базе данных

```php
<?php
$dsn = 'mysql:host=localhost;dbname=testdb;charset=utf8mb4';
$username = 'user';
$password = 'password';

try {
    $pdo = new PDO($dsn, $username, $password);
} catch (PDOException $e) {
    die("Ошибка подключения: " . $e->getMessage());
}
?>
```

#### Создание подготовленного запроса

```php
<?php
$sql = "SELECT name FROM users WHERE id = ?"; // Используем плейсхолдер "?"

$stmt = $pdo->prepare($sql); // Подготавливаем запрос
?>
```

#### Передача данных и выполнение запроса

```php
<?php
$userId = $_GET['id'];

$stmt->execute([$userId]); // Передаем данные в виде массива
?>
```

#### Получение результатов

```php
<?php
$user = $stmt->fetch(PDO::FETCH_ASSOC); // Получаем первую строку результата

if ($user) {
    echo "Имя пользователя: " . $user['name'];
} else {
    echo "Пользователь не найден";
}
?>
```

###  Преимущества подготовленных запросов

- **Безопасность:**  Основное преимущество — защита от SQL-инъекций.
- **Производительность:** При многократном выполнении запроса с разными данными, подготовка выполняется только один раз, что может повысить производительность.
- **Читаемость:** Код становится более структурированным и понятным.

### Дополнительные меры безопасности

- **Валидация данных:** Всегда проверяйте данные, полученные от пользователя, на соответствие ожидаемому формату и типу.
- **Использование наименьших привилегий:**  Создавайте пользователей базы данных с минимально необходимыми правами доступа.
- **Регулярное обновление:**  Используйте последние версии PHP, СУБД и библиотек.
- **Экранирование вывода:**  Используйте функции `htmlspecialchars()` или `htmlentities()` для экранирования данных перед выводом на страницу, чтобы предотвратить XSS-атаки.

###  Заключение

Использование подготовленных запросов — это простой и эффективный способ защитить ваше приложение от SQL-инъекций. Не пренебрегайте вопросами безопасности при работе с базами данных. 

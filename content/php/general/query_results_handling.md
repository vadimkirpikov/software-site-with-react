## Обработка результатов запросов

Работа с базами данных в PHP подразумевает не только отправку запросов, но и обработку полученных результатов. В этой статье мы рассмотрим, как получать, обрабатывать и использовать данные, полученные в результате выполнения SQL-запросов к базе данных.

### Подключение к базе данных

Прежде чем приступить к обработке результатов, необходимо установить соединение с базой данных. Для этого используем расширение PDO (PHP Data Objects).

```php
<?php
// Параметры подключения
$host = 'localhost';
$dbname = 'my_database';
$username = 'username';
$password = 'password';

try {
  // Создание объекта PDO
  $pdo = new PDO("mysql:host=$host;dbname=$dbname", $username, $password);
  // Установка режима обработки ошибок в PDO::ERRMODE_EXCEPTION
  $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

  // Здесь будет выполняться ваш запрос
} catch (PDOException $e) {
  // Обработка ошибок подключения
  echo "Ошибка подключения: " . $e->getMessage();
}
?>
```

В этом примере мы создаем объект PDO, передавая ему параметры подключения к базе данных. Важно установить атрибут `PDO::ATTR_ERRMODE` в значение `PDO::ERRMODE_EXCEPTION` для обработки ошибок подключения через механизм исключений. 

### Выполнение запроса

После установления соединения можно выполнять SQL-запросы. Для примера, получим список пользователей из таблицы `users`:

```php
<?php
// SQL-запрос
$sql = "SELECT * FROM users";

// Подготовка запроса
$statement = $pdo->prepare($sql);

// Выполнение запроса
$statement->execute();
?>
```

В этом коде мы:

1. Определяем SQL-запрос для получения всех записей из таблицы `users`.
2. Подготавливаем запрос с помощью метода `prepare()`. Это создает объект `PDOStatement`, который будет использоваться для выполнения запроса.
3. Выполняем подготовленный запрос с помощью метода `execute()`.

### Получение результатов

Существует несколько способов получить результаты запроса в PHP. Рассмотрим наиболее распространенные:

**1. `fetchAll()`:**  

Возвращает массив, содержащий все строки результата запроса. 

```php
<?php
// Выполнение запроса (продолжение предыдущего примера)

// Получение всех строк результата
$users = $statement->fetchAll(PDO::FETCH_ASSOC);

// Вывод данных
foreach ($users as $user) {
  echo "ID: " . $user['id'] . ", Имя: " . $user['name'] . "<br>";
}
?>
```

В этом примере мы используем `fetchAll(PDO::FETCH_ASSOC)`, чтобы получить все строки результата в виде ассоциативного массива.

**2. `fetch()`:** 

Возвращает одну строку результата запроса. 

```php
<?php
// Выполнение запроса (продолжение предыдущего примера)

// Получение строк по одной
while ($user = $statement->fetch(PDO::FETCH_ASSOC)) {
  echo "ID: " . $user['id'] . ", Имя: " . $user['name'] . "<br>";
}
?>
```

Здесь мы используем цикл `while` и метод `fetch(PDO::FETCH_ASSOC)`, чтобы получать и обрабатывать строки результата по одной.

**3. `fetchColumn()`:** 

Возвращает значение из одного столбца текущей строки результата.

```php
<?php
// Выполнение запроса (продолжение предыдущего примера)

// Получение значения первого столбца (индекс 0)
while ($name = $statement->fetchColumn(0)) {
  echo "Имя: " . $name . "<br>";
}
?>
```

В этом примере мы получаем только значения имен пользователей из первого столбца (`индекс 0`).

### Параметры `fetch()`

Методы `fetchAll()` и `fetch()` могут принимать необязательный параметр `fetch_style`, который определяет формат возвращаемых данных. Вот некоторые из возможных значений:

| Значение | Описание |
|---|---|
| `PDO::FETCH_ASSOC` | Возвращает ассоциативный массив, где ключи - имена столбцов. |
| `PDO::FETCH_NUM` | Возвращает индексированный массив, где ключи - номера столбцов (начиная с 0). |
| `PDO::FETCH_BOTH` | Возвращает массив, содержащий как ассоциативные, так и числовые ключи. |
| `PDO::FETCH_OBJ` | Возвращает объект, где свойства соответствуют именам столбцов. |

### Обработка ошибок

Важно обрабатывать возможные ошибки при выполнении запросов. Для этого можно использовать блок `try...catch`:

```php
<?php
try {
  // ... код выполнения запроса ...
} catch (PDOException $e) {
  echo "Ошибка запроса: " . $e->getMessage();
}
?>
```

### Закрытие соединения

После завершения работы с базой данных рекомендуется закрыть соединение:

```php
<?php
// ... код выполнения запросов ...

// Закрытие соединения
$pdo = null;
?>
```

### Заключение

В этой статье мы рассмотрели основные методы обработки результатов запросов к базе данных в PHP. Вы научились получать данные различными способами, выбирать формат результата и обрабатывать возможные ошибки. 

Дальнейшее изучение документации PDO позволит вам освоить более сложные методы работы с базой данных, включая использование подготовленных запросов с параметрами, транзакции и многое другое. 

## Работа с транзакциями в PHP 8.3

Транзакции играют ключевую роль в обеспечении целостности данных в приложениях, работающих с базами данных. Они позволяют объединить несколько операций с базой данных в единицу работы, которая будет либо выполнена полностью и успешно, либо полностью отменена, если произойдет ошибка на каком-либо этапе.

В PHP работа с транзакциями обычно реализуется с помощью расширений для работы с базами данных, таких как PDO (PHP Data Objects). Рассмотрим основные принципы работы с транзакциями на примере PDO.

### Подключение к базе данных и подготовка к работе с транзакциями

Перед началом работы с транзакциями необходимо установить соединение с базой данных. Используйте PDO для создания нового объекта соединения, указав необходимые параметры, такие как имя базы данных, имя пользователя и пароль:

```php
<?php

try {
  $dsn = 'mysql:host=localhost;dbname=testdb';
  $username = 'user';
  $password = 'password';
  $options = [
    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
  ];

  $pdo = new PDO($dsn, $username, $password, $options);
} catch (PDOException $e) {
  die("Ошибка подключения к базе данных: " . $e->getMessage());
}
```

### Начало транзакции

Для начала транзакции используйте метод `beginTransaction()`:

```php
<?php
$pdo->beginTransaction(); 
```

С этого момента все последующие операции с базой данных будут выполняться в рамках текущей транзакции.

### Выполнение операций внутри транзакции

После начала транзакции вы можете выполнять любые SQL-запросы, как и в обычном режиме:

```php
<?php

try {
  // Добавляем нового пользователя
  $stmt = $pdo->prepare("INSERT INTO users (name, email) VALUES (?, ?)");
  $stmt->execute(['Иван', 'ivan@example.com']);

  // Получаем ID добавленного пользователя
  $userId = $pdo->lastInsertId();

  // Добавляем заказ для нового пользователя
  $stmt = $pdo->prepare("INSERT INTO orders (user_id, total) VALUES (?, ?)");
  $stmt->execute([$userId, 100]);

} catch (PDOException $e) {
  // Обработка ошибки
  echo "Произошла ошибка: " . $e->getMessage();
}
```

### Завершение транзакции

После выполнения всех необходимых операций транзакцию необходимо завершить. Для этого используйте один из двух методов:

* **`commit()`**: сохраняет все изменения, сделанные в рамках транзакции, в базе данных.
* **`rollback()`**: отменяет все изменения, сделанные в рамках транзакции.

Пример успешного завершения транзакции:

```php
<?php
// Все операции выполнены успешно, подтверждаем транзакцию
$pdo->commit(); 
echo "Транзакция успешно завершена!";
```

Пример отката транзакции при возникновении ошибки:

```php
<?php
try {
  // ... операции с базой данных ...

} catch (PDOException $e) {
  // Произошла ошибка, откатываем транзакцию
  $pdo->rollback(); 
  echo "Произошла ошибка, транзакция отменена.";
}
```

### Обработка ошибок и управление состоянием транзакции

Важно предусмотреть обработку ошибок и управлять состоянием транзакции. 

* Используйте блок `try...catch` для перехвата исключений `PDOException`, которые могут возникнуть при работе с базой данных.
* Проверяйте успешность выполнения запросов с помощью метода `execute()`, который возвращает `true` в случае успеха и `false` в случае ошибки.
* Используйте метод `inTransaction()` для проверки, активна ли транзакция в данный момент.

### Пример использования транзакций

Представим, что вам необходимо перевести деньги с одного счета на другой. Эта операция должна быть атомарной, то есть либо обе операции (снятие денег с одного счета и зачисление на другой) должны быть выполнены успешно, либо ни одна из них.

```php
<?php

try {
  $pdo->beginTransaction();

  // Снимаем деньги с первого счета
  $stmt = $pdo->prepare("UPDATE accounts SET balance = balance - :amount WHERE id = :from_account");
  $stmt->execute(['amount' => 100, 'from_account' => 1]);

  // Зачисляем деньги на второй счет
  $stmt = $pdo->prepare("UPDATE accounts SET balance = balance + :amount WHERE id = :to_account");
  $stmt->execute(['amount' => 100, 'to_account' => 2]);

  // Подтверждаем транзакцию
  $pdo->commit();

  echo "Перевод успешно выполнен!";
} catch (PDOException $e) {
  // Откатываем транзакцию в случае ошибки
  $pdo->rollback();
  echo "Ошибка при переводе средств: " . $e->getMessage();
}
```

### Заключение

Транзакции являются мощным инструментом для обеспечения целостности данных. Используйте их при работе с операциями, которые должны быть выполнены атомарно, чтобы гарантировать согласованность данных в вашей базе данных. 

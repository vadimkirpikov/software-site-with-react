## Фабрики и сидеры: ускоряем тестирование в Next.js

Тестирование – неотъемлемая часть разработки качественных приложений. В Next.js, особенно при работе с базами данных или API, часто возникает потребность в создании реалистичных данных для тестирования компонентов и функций. В этом нам помогают фабрики и сидеры.

**Фабрики**: функции, генерирующие объекты с предопределенными или случайными данными. Они позволяют быстро создавать множество объектов с разными характеристиками, идеально подходящих для тестирования различных сценариев.

**Сидеры**: функции, заполняющие базу данных или хранилище тестовыми данными, сгенерированными с помощью фабрик. Это позволяет запускать тесты в изолированной среде с предсказуемыми данными, не затрагивая реальную базу данных.

Рассмотрим использование фабрик и сидеров на примере блога на Next.js с использованием Prisma ORM.

### Установка зависимостей

Убедимся, что установлены все необходимые пакеты:

```bash
npm install @prisma/client prisma --save-dev
```

### Создание фабрики

Создадим фабрику для генерации тестовых данных для модели "Post":

```typescript
// prisma/factories/post.factory.ts
import { define } from "prisma-factory";
import { faker } from "@faker-js/faker";

define("post", {
  id: faker.database.mongodbObjectId,
  title: faker.lorem.sentence,
  content: faker.lorem.paragraphs,
  published: faker.datatype.boolean,
  createdAt: faker.date.past,
  updatedAt: faker.date.recent,
});
```

В этом примере мы используем библиотеку `prisma-factory` для определения фабрики `post`. С помощью `faker` генерируем случайные данные для каждого поля модели.

### Написание сидера

Создадим сидер для заполнения базы данных тестовыми постами:

```typescript
// prisma/seed.ts
import { prisma } from "../lib/prisma";
import { define } from "prisma-factory";

async function main() {
  console.log(`Start seeding ...`);

  for (let i = 0; i < 10; i++) {
    await prisma.post.create({
      data: define("post"), // Используем фабрику для генерации данных
    });
  }

  console.log(`Seeding finished.`);
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

Этот скрипт создает 10 тестовых постов, используя фабрику `post` для генерации данных.

### Запуск сидера

Запустите скрипт для заполнения базы данных:

```bash
npx prisma db seed
```

### Использование фабрик в тестах

Теперь мы можем использовать фабрики для создания тестовых данных непосредственно в тестах компонентов или функций:

```typescript
// __tests__/components/PostList.test.tsx
import { render, screen } from "@testing-library/react";
import PostList from "../../components/PostList";
import { define } from "prisma-factory";

describe("PostList", () => {
  it("renders a list of posts", async () => {
    const posts = [define("post"), define("post"), define("post")];

    render(<PostList posts={posts} />);

    // Проверяем, что каждый пост отображается
    posts.forEach((post) => {
      expect(screen.getByText(post.title)).toBeInTheDocument();
    });
  });
});
```

В этом примере мы используем `define("post")` для создания трех тестовых постов и передаем их в компонент `PostList`. 

### Преимущества использования фабрик и сидеров:

* **Ускорение написания тестов:** быстрая генерация реалистичных данных без необходимости создавать их вручную.
* **Повышение читаемости кода:** код тестов становится короче и понятнее.
* **Улучшение поддерживаемости:** изменения в структуре данных легко вносятся в фабрику, а не в каждый тест отдельно.
* **Изоляция тестовой среды:**  сидеры позволяют запускать тесты в контролируемой среде с предсказуемыми данными.

Использование фабрик и сидеров значительно упрощает написание тестов в Next.js, делая их более быстрыми, читаемыми и поддерживаемыми. 

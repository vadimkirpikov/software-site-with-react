## Настройка базы данных в Next.js проекте

Современные веб-приложения редко обходятся без базы данных для хранения информации. Next.js, будучи фреймворком для создания универсальных React-приложений, предоставляет широкие возможности для интеграции с различными базами данных.

В этом разделе мы рассмотрим основные принципы настройки базы данных в вашем Next.js проекте на примере популярной реляционной базы данных PostgreSQL. 

### Выбор подходящей библиотеки

Первым шагом в настройке базы данных является выбор библиотеки для взаимодействия с ней. Для PostgreSQL существует несколько популярных библиотек, таких как:

* **Prisma:**  Современный ORM (Object-Relational Mapper) с удобным API и мощными возможностями миграции схемы.
* **TypeORM:**  Еще один популярный ORM, предлагающий гибкие возможности настройки и поддержку различных баз данных.
* **pg:**  Низкоуровневый драйвер для PostgreSQL, предоставляющий прямой доступ к API базы данных.

Выбор библиотеки зависит от ваших потребностей и предпочтений. Для простоты в данном руководстве мы будем использовать Prisma.

### Установка Prisma

Для начала установите Prisma CLI и необходимые пакеты:

```bash
npm install prisma --save-dev
npm install @prisma/client postgresql
```

### Инициализация Prisma

После установки Prisma необходимо инициализировать его в проекте:

```bash
npx prisma init
```

Эта команда создаст файл `prisma/schema.prisma`, в котором будет храниться схема вашей базы данных.

### Определение модели данных

Откройте файл `prisma/schema.prisma` и определите модель данных для вашего приложения. Например, для хранения информации о пользователях можно определить следующую модель:

```prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

В этом примере мы определяем модель `User` с полями `id`, `email`, `name`, `createdAt` и `updatedAt`. 

### Генерация клиента Prisma

После определения модели данных необходимо сгенерировать клиент Prisma, который будет использоваться для взаимодействия с базой данных:

```bash
npx prisma generate
```

### Подключение к базе данных

Создайте файл `lib/db.js` в корне вашего проекта и добавьте следующий код:

```javascript
// lib/db.js

import { PrismaClient } from '@prisma/client'

// Проверка на наличие существующего подключения 
// для предотвращения создания множественных экземпляров Prisma
// в режиме разработки Next.js
let db;

if (process.env.NODE_ENV === 'production') {
  db = new PrismaClient();
} else {
  if (!global.db) {
    global.db = new PrismaClient();
  }
  db = global.db;
}

export { db };
```

Этот код создает экземпляр клиента Prisma и экспортирует его для использования в других частях приложения.

### Выполнение запросов к базе данных

Теперь вы можете использовать клиент Prisma для выполнения запросов к базе данных. Например, для создания нового пользователя:

```javascript
// pages/api/users/create.js

import { db } from '../../lib/db';

export default async function handler(req, res) {
  if (req.method === 'POST') {
    const { email, name } = req.body;

    try {
      const user = await db.user.create({
        data: {
          email,
          name,
        },
      });

      res.status(201).json(user);
    } catch (error) {
      console.error(error);
      res.status(500).json({ message: 'Ошибка при создании пользователя' });
    }
  } else {
    res.status(405).end();
  }
}
```

Этот код определяет обработчик API, который принимает POST-запросы и создает новых пользователей в базе данных.

### Заключение

В этом разделе мы рассмотрели основные принципы настройки базы данных в Next.js проекте на примере PostgreSQL и Prisma. Вы познакомились с выбором библиотеки, определением модели данных, генерацией клиента и выполнением простых запросов.  

## Создание и выполнение миграций

Миграции в разработке программного обеспечения – это способ внесения изменений в схему базы данных контролируемым и инкрементным образом. Вместо прямого изменения структуры таблиц в базе данных, миграции позволяют определить эти изменения в коде, что упрощает отслеживание, версионирование и откат изменений.

Next.js сам по себе не предоставляет встроенных инструментов для работы с миграциями. Однако, существует множество сторонних библиотек, которые интегрируются с Next.js и предоставляют подобный функционал. 

В данном разделе мы рассмотрим использование библиотеки **Prisma ORM** для управления миграциями в проекте Next.js. Prisma - это современный ORM (Object-Relational Mapping), который упрощает взаимодействие с базами данных.

### Настройка Prisma

1. **Установка Prisma:**

    ```bash
    npm install prisma --save-dev
    ```
2. **Инициализация Prisma:**

    ```bash
    npx prisma init
    ```

    Эта команда создаст файл `prisma/schema.prisma` – основной файл конфигурации Prisma, где определяется схема базы данных и другие настройки.
3. **Настройка подключения к базе данных:**

    Откройте файл `prisma/schema.prisma` и укажите параметры подключения к вашей базе данных:

    ```prisma
    generator client {
      provider = "prisma-client-js"
    }

    datasource db {
      provider = "postgresql" // Или другой провайдер, например, "mysql" или "sqlite"
      url      = env("DATABASE_URL")
    }
    ```

    Замените `postgresql` на нужный вам провайдер. 

    **Важно:** Создайте переменную окружения `DATABASE_URL` и укажите в ней строку подключения к вашей базе данных.
4. **Создание модели данных:**

    Определите модели данных в файле `prisma/schema.prisma`:

    ```prisma
    model User {
      id        Int      @id @default(autoincrement())
      email     String   @unique
      name      String?
      createdAt DateTime @default(now())
      updatedAt DateTime @updatedAt
    }
    ```

    В данном примере мы создали модель `User` с полями `id`, `email`, `name`, `createdAt` и `updatedAt`. 
5. **Генерация клиента Prisma:**

    ```bash
    npx prisma generate
    ```

    Эта команда сгенерирует клиент Prisma, который будет использоваться для взаимодействия с базой данных в вашем коде.

### Создание миграции

1. **Используйте команду `prisma migrate`:**

    ```bash
    npx prisma migrate dev --name=init
    ```

    Эта команда выполнит следующие действия:

    - Проанализирует изменения в файле `schema.prisma` по сравнению с текущей схемой базы данных.
    - Сгенерирует файл миграции с SQL-запросами, необходимыми для применения изменений.
    - Применит миграцию к базе данных.

    Флаг `--name` позволяет задать имя миграции (в данном случае, `init`). 

    Флаг `dev` использует базу данных, определенную в provider'е `db` в файле `schema.prisma`. Для production окружения рекомендуется использовать другой provider и флаг `--preview-feature`.

2. **Просмотр сгенерированной миграции:**

    После выполнения команды в папке `prisma/migrations` появится новый файл миграции. Вы можете открыть этот файл, чтобы просмотреть сгенерированные SQL-запросы.

### Выполнение миграций в production

Для выполнения миграций в production-окружении используйте команду:

```bash
npx prisma migrate deploy
```

Эта команда применит все невыполненные миграции к базе данных.

### Откат миграций

Для отката последней примененной миграции используйте команду:

```bash
npx prisma migrate reset
```

**Важно:** Откат миграций может привести к потере данных. Рекомендуется создавать резервные копии базы данных перед выполнением подобных операций.

### Заключение

Использование миграций – это важная практика при работе с базами данных, которая помогает обеспечить согласованность и управляемость изменений схемы. Prisma ORM значительно упрощает процесс создания и выполнения миграций в проектах Next.js, позволяя сосредоточиться на разработке приложения, а не на ручном управлении базой данных.

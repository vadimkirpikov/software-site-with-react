## Запланированные задачи в Next.js

Next.js, фреймворк для создания серверных приложений на React, позволяет выполнять задачи по расписанию с помощью API-маршрутов. Это может быть полезно для множества сценариев, таких как:

* Генерация отчетов
* Очистка кеша
* Обновление данных из внешних API
* Отправка уведомлений

### Создание API-маршрута для запланированной задачи

Для начала создадим простой API-маршрут, который будет выводить в консоль сообщение:

1. Создайте файл `pages/api/scheduled-task.js`:

```javascript
export default async function handler(req, res) {
  // Логика запланированной задачи
  console.log('Задача выполнена!', new Date());

  // Возвращаем успешный ответ
  res.status(200).json({ message: 'Задача выполнена!' });
}
```

Этот маршрут можно протестировать, перейдя по адресу `http://localhost:3000/api/scheduled-task` после запуска приложения Next.js. В консоли сервера должно появиться сообщение "Задача выполнена!".

### Использование внешнего сервиса для планирования

Для запуска задач по расписанию воспользуемся сервисом cron-job.org. 

1. Зарегистрируйтесь на сайте cron-job.org.
2. Создайте новое задание (cron job).
3. В поле "URL" укажите адрес вашего API-маршрута, например: `https://your-app.vercel.app/api/scheduled-task`.
4. Настройте расписание запуска задачи с помощью cron-выражения. Например, для запуска каждый час: `0 * * * *`.
5. Сохраните задание.

Cron-job.org будет отправлять HTTP-запрос на ваш API-маршрут по заданному расписанию, запуская выполнение кода задачи.

### Пример: отправка email-уведомления

Рассмотрим пример отправки email-уведомления пользователю каждый день в 9:00 утра. Для этого нам понадобится:

* Установить пакет `nodemailer`:

```bash
npm install nodemailer
```

* Настроить API-маршрут для отправки email:

```javascript
import nodemailer from 'nodemailer';

export default async function handler(req, res) {
  // Настройка почтового клиента
  const transporter = nodemailer.createTransport({
    service: 'your_email_service', // Например: 'gmail'
    auth: {
      user: 'your_email@example.com',
      pass: 'your_password',
    },
  });

  // Параметры email
  const mailOptions = {
    from: 'your_email@example.com',
    to: 'user@example.com',
    subject: 'Ежедневное уведомление',
    text: 'Привет! Это ваше ежедневное уведомление.',
  };

  try {
    // Отправка email
    await transporter.sendMail(mailOptions);
    console.log('Email отправлен!');
    res.status(200).json({ message: 'Email отправлен!' });
  } catch (error) {
    console.error('Ошибка при отправке email:', error);
    res.status(500).json({ message: 'Ошибка при отправке email' });
  }
}
```

* Заменить `your_email_service`, `your_email@example.com`, `your_password` и `user@example.com` на ваши данные.
* Настроить cron-задание на сайте cron-job.org для запуска этого маршрута каждый день в 9:00 утра (cron-выражение: `0 9 * * *`).

### Заключение

API-маршруты в Next.js предоставляют удобный способ выполнения запланированных задач. Используя внешние сервисы планирования, можно легко автоматизировать различные процессы в вашем приложении.

**Важно:** 

* Не храните конфиденциальные данные, такие как пароли, непосредственно в коде. Используйте переменные окружения.
* Будьте внимательны при настройке cron-выражений, чтобы избежать нежелательных последствий.
* Тщательно тестируйте ваши запланированные задачи перед запуском в production.

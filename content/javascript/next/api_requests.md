## Обработка запросов API в Next.js

Next.js, как фреймворк для построения серверных приложений, предоставляет широкие возможности для обработки запросов к API. В этой статье мы рассмотрим основные способы взаимодействия с API, начиная от простых GET-запросов и заканчивая обработкой ошибок и использованием middleware.

### API-маршруты

Next.js позволяет создавать API-маршруты непосредственно в директории `pages/api`. Каждый файл в этой директории будет преобразован в отдельный API-эндпоинт, соответствующий пути к файлу. Например, файл `pages/api/users.js` будет доступен по адресу `/api/users`.

Рассмотрим простой пример:

```javascript
// pages/api/hello.js

export default function handler(req, res) {
  res.status(200).json({ message: 'Привет, мир!' });
}
```

Этот код определяет API-маршрут `/api/hello`, который возвращает JSON-объект с сообщением "Привет, мир!" при обращении к нему.

### HTTP-методы

Next.js автоматически обрабатывает HTTP-методы запроса. В зависимости от метода, используемого клиентом, функция-обработчик в API-маршруте может выполнять различные действия. 

Например, мы можем изменить предыдущий пример, чтобы обрабатывать запросы GET и POST:

```javascript
// pages/api/hello.js

export default function handler(req, res) {
  if (req.method === 'GET') {
    res.status(200).json({ message: 'Привет, мир!' });
  } else if (req.method === 'POST') {
    const { name } = req.body;
    res.status(201).json({ message: `Привет, ${name}!` });
  } else {
    res.status(405).end(); // Метод не разрешен
  }
}
```

В этом примере мы используем свойство `req.method` для определения метода запроса. Если это GET-запрос, то возвращается то же самое сообщение, что и раньше. Если это POST-запрос, то мы извлекаем имя из тела запроса и возвращаем персонализированное приветствие. Для всех остальных методов возвращается ошибка 405 (Метод не разрешен).

### Работа с данными запроса

Next.js предоставляет удобные способы доступа к данным запроса, таким как параметры запроса, тело запроса и заголовки.

#### Параметры запроса

Для доступа к параметрам запроса используется объект `req.query`. Например, если к API-маршруту `/api/users` обратились с запросом `/api/users?id=123`, то получить значение параметра `id` можно следующим образом:

```javascript
const userId = req.query.id; // userId = '123'
```

#### Тело запроса

Для доступа к телу запроса используется объект `req.body`. Однако, чтобы прочитать тело запроса, необходимо использовать парсер. Next.js не включает в себя встроенный парсер тела, но вы можете использовать любой понравившийся вам парсер, например, `body-parser`.

```javascript
// pages/api/users.js

import bodyParser from 'body-parser';

export const config = {
  api: {
    bodyParser: {
      sizeLimit: '1mb', // Ограничение размера тела запроса
    },
  },
};

export default async function handler(req, res) {
  await bodyParser.json()(req, res, () => {
    if (req.method === 'POST') {
      const { name, email } = req.body;
      // ...
    }
  });
}
```

#### Заголовки

Для доступа к заголовкам запроса используется объект `req.headers`. Например, получить значение заголовка `Authorization` можно следующим образом:

```javascript
const authHeader = req.headers.authorization;
```

### Ответы на запросы

Next.js предоставляет гибкие возможности для формирования ответов на запросы. Вы можете использовать встроенные методы объекта `res` для отправки различных типов данных и установки статуса ответа.

#### Отправка JSON

Для отправки JSON-данных используется метод `res.json()`.

```javascript
res.status(200).json({ message: 'Данные успешно сохранены!' });
```

#### Отправка текста

Для отправки текстовых данных используется метод `res.send()`.

```javascript
res.status(200).send('Привет, мир!');
```

#### Установка статуса ответа

Для установки статуса ответа используется метод `res.status()`.

```javascript
res.status(404).send('Ресурс не найден!');
```

### Обработка ошибок

Для обработки ошибок в API-маршрутах можно использовать блоки `try...catch`. 

```javascript
try {
  // ...
} catch (error) {
  console.error(error);
  res.status(500).json({ message: 'Произошла ошибка на сервере!' });
}
```

### Использование Middleware

Next.js позволяет использовать middleware в API-маршрутах. Middleware - это функции, которые выполняются до основного обработчика запроса. Они могут использоваться для выполнения различных задач, таких как аутентификация, авторизация, логирование и т.д.

Чтобы использовать middleware в API-маршруте, необходимо определить функцию, принимающую три аргумента: `req`, `res` и `next`. Функция `next` используется для передачи управления следующему middleware или основному обработчику запроса.

```javascript
// pages/api/middleware/auth.js

export default function authMiddleware(req, res, next) {
  // Проверка авторизации
  const authHeader = req.headers.authorization;
  if (!authHeader) {
    return res.status(401).json({ message: 'Необходимо авторизоваться!' });
  }

  // ...

  next(); // Передача управления следующему middleware или основному обработчику
}
```

Чтобы подключить middleware к API-маршруту, необходимо экспортировать массив `middleware` из файла маршрута:

```javascript
// pages/api/users.js

import authMiddleware from '../middleware/auth';

export const middleware = [authMiddleware];

export default function handler(req, res) {
  // ...
}
```

## Заключение

Next.js предоставляет все необходимые инструменты для создания мощных и гибких API.  В этой статье мы рассмотрели основные концепции обработки запросов к API в Next.js.  С помощью API-маршрутов, обработки HTTP-методов, работы с данными запроса, формирования ответов и использования middleware, вы можете создавать полноценные API для своих приложений.

## Формирование ответов API JSON в Next.js

Next.js предоставляет мощные инструменты для создания API-маршрутов и формирования ответов в формате JSON. Эти маршруты располагаются в директории `app/api` (или `pages/api` в более ранних версиях) вашего проекта и автоматически обрабатываются Next.js для обеспечения быстрой и эффективной работы.

### Создание простого API-маршрута

Создайте файл `app/api/hello.js` (или `pages/api/hello.js`) со следующим кодом:

```javascript
// app/api/hello.js
export default function handler(req, res) {
  res.status(200).json({ message: 'Привет из Next.js API!' });
}
```

Этот код определяет функцию-обработчик `handler`, которая принимает два аргумента: `req` (объект запроса) и `res` (объект ответа). Внутри функции мы используем метод `res.status(200)` для установки кода состояния HTTP 200 (OK) и `res.json()` для отправки JSON-ответа с объектом, содержащим свойство `message`.

Теперь, если вы запустите ваш проект Next.js и перейдете по адресу `http://localhost:3000/api/hello` в браузере, вы увидите JSON-ответ:

```json
{
  "message": "Привет из Next.js API!"
}
```

### Обработка данных запроса

Объект запроса `req` содержит информацию о поступающем запросе, такую как метод запроса (GET, POST, PUT и т.д.), заголовки и тело запроса. 

Рассмотрим пример обработки данных из тела POST-запроса. Создайте файл `app/api/submit.js` со следующим кодом:

```javascript
// app/api/submit.js
export default async function handler(req, res) {
  if (req.method === 'POST') {
    const { name, email } = req.body;
    // Здесь вы можете выполнить необходимые действия с полученными данными, 
    // например, сохранить их в базе данных.
    
    res.status(200).json({ message: `Данные получены: ${name}, ${email}` });
  } else {
    res.status(405).end(); // Метод не разрешен
  }
}
```

В этом примере мы сначала проверяем, является ли метод запроса POST. Если да, мы извлекаем данные `name` и `email` из тела запроса `req.body` и отправляем JSON-ответ, подтверждающий получение данных. Если метод запроса не POST, мы отправляем код состояния 405 (Method Not Allowed).

Обратите внимание на использование `async`/`await`. Это позволяет нам использовать асинхронные операции, такие как взаимодействие с базой данных, внутри функции-обработчика.

### Отправка различных типов данных

Помимо JSON, вы можете отправлять другие типы данных в ответах API. Вот несколько примеров:

**1. Текст:**

```javascript
res.status(200).send('Это текстовый ответ');
```

**2. HTML:**

```javascript
res.status(200).send('<h1>Привет из Next.js API!</h1>');
```

**3. Перенаправление:**

```javascript
res.redirect(302, '/');
```

### Обработка ошибок

Важно обрабатывать ошибки в ваших API-маршрутах, чтобы предоставлять пользователям информативные сообщения об ошибках. Вы можете использовать блок `try...catch` для перехвата ошибок и отправки соответствующего ответа:

```javascript
// app/api/users/[id].js
export default async function handler(req, res) {
  const { id } = req.query;

  try {
    // Попытка получить пользователя из базы данных по ID
    const user = await getUserById(id); 

    if (!user) {
      return res.status(404).json({ message: 'Пользователь не найден' });
    }

    res.status(200).json({ user });
  } catch (error) {
    console.error(error);
    res.status(500).json({ message: 'Ошибка сервера' });
  }
}
```

В этом примере мы пытаемся получить пользователя из базы данных по ID. Если пользователь не найден, мы отправляем код состояния 404 (Not Found). Если возникает другая ошибка, мы регистрируем ее в консоли и отправляем код состояния 500 (Internal Server Error).

### Динамические маршруты API

Next.js поддерживает динамические маршруты API, которые позволяют создавать гибкие API-интерфейсы. Вы можете определить динамический маршрут, заключив имя файла или имя папки в квадратные скобки (`[]`). Например, маршрут `app/api/users/[id].js` будет соответствовать любому URL-адресу, начинающемуся с `/api/users/`, где `[id]` может быть любым значением.

Внутри функции-обработчика вы можете получить доступ к динамическим параметрам маршрута из объекта `req.query`. 

Пример динамического маршрута для получения пользователя по ID:

```javascript
// app/api/users/[id].js
export default function handler(req, res) {
  const { id } = req.query;
  res.status(200).json({ id });
}
```

Если вы перейдете по адресу `/api/users/123`, вы увидите JSON-ответ:

```json
{
  "id": "123"
}
```

### Заключение

Next.js предоставляет простой и мощный способ создания API-маршрутов и формирования ответов JSON. Вы можете обрабатывать данные запросов, отправлять различные типы данных, обрабатывать ошибки и создавать динамические маршруты API для создания гибких и эффективных API-интерфейсов.
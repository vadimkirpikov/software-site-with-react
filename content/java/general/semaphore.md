## Семафоры

В многопоточных приложениях на Java часто возникает необходимость контролировать доступ к общим ресурсам. Один из инструментов для этого - семафор.

### Что такое семафор?

Семафор - это структура данных, которая поддерживает счетчик и предоставляет операции для его изменения и ожидания. Счетчик семафора ограничивает количество потоков, которые могут одновременно получить доступ к определенному ресурсу.

### Класс Semaphore

В Java семафоры реализованы классом `java.util.concurrent.Semaphore`. Конструктор этого класса принимает два аргумента:

* **permits:** Начальное значение счетчика семафора. 
* **fair (опционально):** Определяет, будет ли семафор работать по принципу "первым пришел - первым обслужен". Значение по умолчанию - `false`.

### Основные операции

Класс `Semaphore` предоставляет два основных метода:

* **acquire():** Этот метод пытается уменьшить счетчик семафора на 1. Если значение счетчика больше 0, операция выполняется немедленно. Если значение счетчика равно 0, поток блокируется до тех пор, пока счетчик не станет больше 0.
* **release():** Этот метод увеличивает счетчик семафора на 1. Если есть потоки, ожидающие доступ к ресурсу, один из них разблокируется.

### Пример использования: Ограничение доступа к базе данных

Представим, у нас есть приложение, которое работает с базой данных.  Одновременно может быть открыто не более 10 соединений. С помощью семафора можно реализовать это ограничение:

```java
import java.util.concurrent.Semaphore;

public class DatabasePool {

    private static final int MAX_CONNECTIONS = 10;
    private final Semaphore semaphore = new Semaphore(MAX_CONNECTIONS);

    public Connection getConnection() throws InterruptedException {
        semaphore.acquire(); // Запрашиваем разрешение на соединение
        return new Connection(); // Возвращаем объект соединения
    }

    public void releaseConnection(Connection connection) {
        // Освобождаем ресурсы соединения
        semaphore.release(); // Освобождаем разрешение
    }
}

class Connection {
    // Реализация класса Connection
}
```

В этом примере мы создаем объект `Semaphore` с начальным значением счетчика 10. Метод `getConnection()` пытается получить разрешение на соединение с помощью `semaphore.acquire()`. Если доступно меньше 10 соединений, поток получает разрешение и продолжает выполнение. В противном случае поток блокируется, пока не освободится соединение. Метод `releaseConnection()` освобождает соединение и увеличивает счетчик семафора.

### Пример: Реализация барьера

Семафоры можно использовать для реализации барьера - точки синхронизации, где потоки блокируются, пока не достигнут ее определенное количество потоков.

```java
import java.util.concurrent.Semaphore;

public class Barrier {
    private final int parties;
    private final Semaphore barrier = new Semaphore(0);
    private final Semaphore mutex = new Semaphore(1);
    private int count = 0;

    public Barrier(int parties) {
        this.parties = parties;
    }

    public void await() throws InterruptedException {
        mutex.acquire();
        count++;
        if (count == parties) {
            barrier.release(parties); // Разрешаем всем потокам пройти барьер
        }
        mutex.release();
        barrier.acquire(); // Ожидаем разрешения на проход
        barrier.release(); // Освобождаем разрешение для других потоков
    }
}
```

В этом примере мы используем два семафора. `barrier` используется для блокировки потоков на барьере, а `mutex` - для синхронизации доступа к переменной `count`. 

### Заключение

Семафоры - это мощный инструмент для управления доступом к ресурсам в многопоточных приложениях Java.  Они предоставляют гибкий способ координации работы потоков и предотвращения состояний гонки. 

## Управление ресурсами Docker

Docker позволяет управлять ресурсами, которые контейнеры могут использовать на хост-системе. Это позволяет эффективно использовать ресурсы и предотвращать нехватку ресурсов, которая может привести к сбоям в работе приложений. 

В этом разделе мы рассмотрим следующие аспекты управления ресурсами Docker:

* **Ограничение потребления ресурсов:** CPU, память, операции ввода-вывода.
* **Настройка приоритетов ресурсов** для контейнеров.
* **Использование Docker Compose** для управления ресурсами в мультиконтейнерных приложениях.

### Ограничение потребления ресурсов

Docker предоставляет несколько механизмов для ограничения ресурсов, доступных контейнерам.

#### Ограничение CPU

Вы можете ограничить количество ядер CPU, доступных для контейнера, используя следующие флаги при запуске контейнера:

* **`--cpus`: **  Указывает количество ядер CPU, доступных контейнеру. Например, `--cpus="2"` выделит 2 ядра CPU для контейнера.
* **`--cpu-shares`: **  Указывает относительный вес CPU, доступный контейнеру. Значение по умолчанию — 1024. Если два контейнера имеют `--cpu-shares="512"` и `--cpu-shares="1024"`, то второй контейнер получит вдвое больше ресурсов CPU.
* **`--cpu-period`: **  Устанавливает период времени (в микросекундах), в течение которого планировщик CPU будет распределять доступное время CPU между контейнерами. Используется в сочетании с `--cpu-quota`.
* **`--cpu-quota`: **  Устанавливает максимальное время CPU (в микросекундах), которое контейнер может использовать в течение каждого периода, указанного в `--cpu-period`.

**Пример:**

```
docker run -it --cpus="1.5" --cpu-period="100000" --cpu-quota="200000" ubuntu:latest /bin/bash
```

В этом примере запускается контейнер `ubuntu:latest`, которому выделено 1.5 ядра CPU. Параметры `--cpu-period` и `--cpu-quota` ограничивают потребление CPU до 200000 микросекунд (0.2 секунды) на каждые 100000 микросекунд (0.1 секунды).

#### Ограничение памяти

Ограничить потребление памяти контейнером можно с помощью следующих флагов:

* **`-m` или `--memory`: **  Устанавливает жесткий лимит потребления памяти для контейнера. Если контейнер попытается превысить этот лимит, он будет остановлен. 
* **`--memory-swap`: **  Устанавливает лимит памяти подкачки для контейнера. Значение `-1` позволяет использовать всю доступную память подкачки.
* **`--memory-reservation`: **  Устанавливает "мягкий" лимит памяти для контейнера. Docker постарается не выделять больше памяти контейнеру, чем указано в этом параметре, но если системе не хватает свободной памяти, контейнер сможет использовать больше памяти, чем указано в `--memory-reservation`.

**Пример:**

```
docker run -it -m="512m" --memory-swap="1g" ubuntu:latest /bin/bash
```

В этом примере запускается контейнер `ubuntu:latest` с ограничением памяти 512 мегабайт и ограничением памяти подкачки 1 гигабайт.

#### Ограничение операций ввода-вывода

Docker также позволяет ограничивать скорость операций чтения/записи на диск для контейнеров. Для этого используются следующие флаги:

* **`--blkio-weight`: **  Устанавливает относительный вес операций ввода-вывода для контейнера. Значение по умолчанию — 500. Диапазон значений — от 10 до 1000.
* **`--blkio-weight-device`: **  Позволяет установить отдельный вес для конкретного устройства.

**Пример:**

```
docker run -it --blkio-weight="200" ubuntu:latest /bin/bash
```

В этом примере запускается контейнер `ubuntu:latest` с относительным весом операций ввода-вывода 200.

### Настройка приоритетов ресурсов

Docker позволяет задавать приоритеты доступа к ресурсам для разных контейнеров. Это делается с помощью флагов `--oom-kill-disable` и `--oom-score-adj`.

* **`--oom-kill-disable`: **  Если этот флаг установлен, Docker не будет останавливать контейнер, если на хост-системе закончится память (OOM - Out Of Memory). Однако, это может привести к остановке других процессов на хост-системе.
* **`--oom-score-adj`: **  Позволяет настроить OOM-балл для контейнера. OOM-балл — это число, которое ядро Linux использует для определения, какой процесс остановить в случае нехватки памяти. Чем ниже OOM-балл, тем меньше вероятность того, что процесс будет остановлен. Диапазон значений — от -1000 до 1000.

**Пример:**

```
docker run -it --oom-kill-disable --oom-score-adj="-500" ubuntu:latest /bin/bash
```

В этом примере запускается контейнер `ubuntu:latest` с отключенной возможностью остановки при нехватке памяти и OOM-баллом -500.

### Использование Docker Compose для управления ресурсами

Docker Compose — это инструмент для определения и запуска многоконтейнерных Docker-приложений. Compose использует файлы YAML для конфигурации сервисов приложения, сетей и томов.

Вы можете управлять ресурсами контейнеров в файле `docker-compose.yml` с помощью раздела `resources`. 

**Пример:**

```yaml
version: "3.9"
services:
  web:
    image: nginx:latest
    ports:
      - "80:80"
    resources:
      limits:
        cpus: "0.5"
        memory: "512M"
      reservations:
        cpus: "0.25"
        memory: "256M"
```

В этом примере определяется сервис `web` с образом `nginx:latest`. Сервис имеет следующие ограничения ресурсов:

* **Лимиты:** 0.5 ядра CPU и 512 мегабайт памяти.
* **Резервация:** 0.25 ядра CPU и 256 мегабайт памяти.

### Заключение

В этом разделе мы рассмотрели основные аспекты управления ресурсами Docker. Вы узнали, как ограничивать потребление ресурсов контейнерами, настраивать приоритеты доступа к ресурсам и управлять ресурсами в многоконтейнерных приложениях с помощью Docker Compose. 

Подробную информацию о каждом флаге и опции можно найти в официальной документации Docker.

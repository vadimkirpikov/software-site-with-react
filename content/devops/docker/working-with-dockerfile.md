## Dockerfile: Создание собственных образов

Dockerfile – это текстовый файл, содержащий инструкции для автоматической сборки docker-образов. Он позволяет вам определить базовую операционную систему, зависимости, приложения и конфигурации, необходимые для запуска вашего программного обеспечения. 

### Основы Dockerfile

Каждый Dockerfile начинается с инструкции `FROM`, которая указывает на базовый образ, с которого начинается сборка. Далее следуют инструкции, определяющие шаги по настройке образа. Вот наиболее часто используемые:

| Инструкция | Описание |
|---|---|
| `FROM` | Указывает базовый образ |
| `RUN` | Выполняет команду в контексте образа |
| `COPY` | Копирует файлы/папки из контекста сборки в образ |
| `ADD` | Аналогично `COPY`, но может распаковывать архивы и загружать файлы по URL |
| `WORKDIR` | Устанавливает рабочую директорию для последующих инструкций |
| `ENV` | Устанавливает переменные окружения |
| `EXPOSE` | Информирует Docker о портах, которые будет использовать приложение |
| `CMD` | Устанавливает команду, которая будет выполнена при запуске контейнера |

**Пример Dockerfile:**

```dockerfile
# Используем образ Python 3.11
FROM python:3.11

# Устанавливаем рабочую директорию
WORKDIR /app

# Копируем файлы приложения
COPY . .

# Устанавливаем зависимости
RUN pip install -r requirements.txt

# Указываем порт приложения
EXPOSE 8000

# Команда запуска приложения
CMD ["python", "manage.py", "runserver", "0.0.0.0:8000"]
```

Этот Dockerfile:

1. Использует образ `python:3.11` в качестве основы.
2. Устанавливает рабочую директорию `/app`.
3. Копирует все файлы из текущего каталога в `/app`.
4. Устанавливает зависимости из файла `requirements.txt`.
5. Указывает, что приложение будет использовать порт 8000.
6. Запускает команду `python manage.py runserver 0.0.0.0:8000` при запуске контейнера.

### Сборка образа

Чтобы создать образ на основе Dockerfile, используйте команду `docker build`. 

```bash
docker build -t my-app .
```

* `-t my-app` задает имя тегу для создаваемого образа. 
* `.` указывает на текущий каталог, в котором находится Dockerfile.

### Запуск контейнера

Запустите контейнер из созданного образа:

```bash
docker run -d -p 8000:8000 my-app
```

* `-d` запускает контейнер в фоновом режиме.
* `-p 8000:8000` пробрасывает порт 8000 хоста на порт 8000 контейнера.

### Пример: Создание веб-сервера на Nginx

Создайте файл `Dockerfile` со следующим содержимым:

```dockerfile
FROM nginx:latest

# Копируем файлы сайта
COPY ./src /usr/share/nginx/html
```

Создайте папку `src` и поместите в нее файл `index.html`:

```html
<!DOCTYPE html>
<html>
<head>
  <title>Мой сайт</title>
</head>
<body>
  <h1>Привет, мир!</h1>
</body>
</html>
```

Соберите образ:

```bash
docker build -t my-web-server .
```

Запустите контейнер:

```bash
docker run -d -p 80:80 my-web-server
```

Теперь ваш веб-сервер доступен по адресу `http://localhost`.

### Лучшие практики

* **Один процесс на контейнер:** Разделяйте приложения на отдельные контейнеры для лучшей изоляции и масштабируемости.
* **Используйте `.dockerignore`:** Исключите ненужные файлы и папки из сборки, чтобы уменьшить размер образа.
* **Многоступенчатая сборка:** Используйте несколько `FROM` инструкций для разделения этапов сборки и уменьшения размера финального образа.

Dockerfile предоставляет мощный инструмент для автоматизации создания и развертывания приложений. Следуя этим рекомендациям, вы сможете создавать эффективные и переносимые образы Docker для ваших проектов. 

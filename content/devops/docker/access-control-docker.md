## Управление доступом и контроль прав в Docker

Безопасность является критически важным аспектом работы с контейнерами Docker. Неправильно настроенные права доступа могут привести к несанкционированному доступу к данным или даже к компрометации всей системы. В этом разделе мы рассмотрим основные механизмы управления доступом и контроля прав в Docker, которые позволят вам создавать безопасные и надежные контейнерные приложения.

### Linux Security Modules (LSM) и Docker

Docker, по умолчанию, полагается на механизмы безопасности ядра Linux, известные как Linux Security Modules (LSM), для контроля доступа к ресурсам системы. LSM представляют собой набор модулей ядра, реализующих различные политики безопасности, такие как SELinux, AppArmor и другие.

**SELinux** (Security-Enhanced Linux) - это система обязательного контроля доступа, которая ограничивает действия пользователей и процессов на основе политик безопасности. Docker может работать в режиме SELinux, обеспечивая дополнительный уровень защиты.

**AppArmor** - это система мандатного контроля доступа, которая ограничивает доступ приложений к системным ресурсам, таким как файлы, сетевые порты и другие. Docker также может работать в режиме AppArmor.

### Docker Rootless Mode

Docker Rootless Mode - это режим запуска Docker, который позволяет запускать Docker-демон и контейнеры от имени непривилегированного пользователя. Это значительно повышает безопасность, так как ограничивает доступ контейнеров к ресурсам системы.

#### Запуск Docker в режиме Rootless Mode:

1. **Установите необходимые пакеты:**

    ```bash
    sudo apt-get install -y slirp4netns fuse-overlayfs
    ```

2. **Создайте пользователя (если у вас его еще нет) и добавьте его в группу docker:**

    ```bash
    sudo useradd -m -G docker <username>
    ```

3. **Выйдите из системы и войдите снова от имени созданного пользователя.**

4. **Проверьте, что Docker работает в режиме Rootless Mode:**

    ```bash
    docker info | grep Rootless
    ```

    Вы должны увидеть вывод, подобный этому:

    ```
    Rootless: true
    ```

### Docker Content Trust

Docker Content Trust позволяет верифицировать издателя и целостность образов Docker, используя цифровые подписи. При включенном Docker Content Trust, Docker Engine проверяет подпись образа перед его скачиванием или запуском.

#### Включение Docker Content Trust:

1. **Откройте файл конфигурации Docker (`daemon.json`):**

    ```bash
    sudo nano /etc/docker/daemon.json
    ```

2. **Добавьте следующие строки в файл конфигурации:**

    ```json
    {
      "dtr-registry-name": {
        "mirrors": ["example.com:5000"]
      }
    }
    ```

    Замените `example.com:5000` на адрес вашего Docker Registry.

3. **Сохраните файл и перезапустите Docker-демон:**

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl restart docker
    ```

### Docker Secrets

Docker Secrets - это механизм безопасного хранения и передачи конфиденциальных данных, таких как пароли, ключи API и другие, в контейнеры Docker. Секреты монтируются в контейнеры как файлы, что предотвращает их попадание в образы Docker и историю команд.

#### Создание и использование Docker Secrets:

1. **Создайте секрет:**

    ```bash
    echo "my_secret_password" | docker secret create my_secret -
    ```

2. **Запустите контейнер с доступом к секрету:**

    ```bash
    docker run -d \
      --name my_container \
      --mount type=secret,source=my_secret,target=/run/secrets/my_secret \
      <image_name>
    ```

    Секрет будет доступен в контейнере в файле `/run/secrets/my_secret`.

### Заключение

В этом разделе мы рассмотрели базовые механизмы управления доступом и контроля прав в Docker. Правильное использование этих механизмов позволит вам создавать безопасные и надежные контейнерные приложения, защищенные от несанкционированного доступа. 

Важно помнить, что безопасность - это непрерывный процесс, требующий постоянного внимания. Регулярно обновляйте Docker и следите за новостями безопасности, чтобы быть в курсе последних угроз и уязвимостей.
## Мультистадийные сборки в Docker

Мультистадийные сборки — это мощная функциональность Docker, позволяющая оптимизировать размер конечного образа и ускорить процесс сборки. Вместо создания одного образа со всем необходимым для сборки и запуска приложения, вы можете использовать несколько этапов (stages), каждый из которых представляет собой отдельный контейнер с определенной целью. 

### Преимущества мультистадийных сборок

* **Уменьшение размера образа:**  В процессе сборки приложения часто используются инструменты и зависимости, которые не нужны во время его работы. Мультистадийные сборки позволяют отделить эти компоненты, скопировав только артефакты сборки на финальный этап, что значительно уменьшает размер конечного образа. 

* **Улучшение кеширования:** Docker кэширует каждый этап сборки. Если код или зависимости на ранних этапах не меняются, Docker будет использовать кеш, что значительно ускоряет процесс сборки.

* **Повышение безопасности:**  Мультистадийные сборки позволяют минимизировать количество компонентов, присутствующих в финальном образе. Это снижает риск уязвимостей, так как в образе отсутствуют ненужные инструменты и библиотеки.

### Пример использования

Рассмотрим пример создания простого веб-приложения на Go с использованием мультистадийной сборки.

**Dockerfile**

```dockerfile
# Этап 1: Сборка приложения
FROM golang:latest AS builder
WORKDIR /app
COPY go.mod go.sum ./
RUN go mod download
COPY . .
RUN go build -o main .

# Этап 2: Создание финального образа
FROM alpine:latest
WORKDIR /app
COPY --from=builder /app/main .
EXPOSE 8080
CMD ["./main"]
```

**Описание этапов:**

1. **Этап 1 (builder):**
    * Используем образ `golang:latest` как основу для этапа сборки.
    * Устанавливаем рабочую директорию `/app`.
    * Копируем файлы `go.mod` и `go.sum` для управления зависимостями.
    * Выполняем `go mod download` для загрузки зависимостей.
    * Копируем остальной код приложения.
    * С помощью `go build` собираем исполняемый файл `main`.

2. **Этап 2 (финальный образ):**
    * Используем минималистичный образ `alpine:latest` как основу для финального образа.
    * Устанавливаем рабочую директорию `/app`.
    * Копируем с этапа `builder` только исполняемый файл `main`.
    * Открываем порт `8080` для доступа к приложению.
    * Задаем команду запуска `CMD ["./main"]`.

**Сборка и запуск образа:**

```bash
docker build -t my-go-app .
docker run -d -p 8080:8080 my-go-app
```

### Использование именованных этапов

В примере выше мы обращались к этапу сборки с помощью ключевого слова `AS builder`. Это пример использования именованных этапов. Вы можете давать этапам осмысленные имена, что улучшает читаемость Dockerfile и облегчает поддержку. 

### Копирование файлов и директорий

Для копирования файлов и директорий между этапами используется инструкция `COPY`.  С помощью флага `--from` мы указываем, с какого этапа необходимо скопировать данные. 

### Заключение

Мультистадийные сборки — это важный инструмент для оптимизации образов Docker. Используя  их, вы можете создавать более компактные, быстрые и безопасные образы. 

## Управление ресурсами кластера

Kubernetes предоставляет механизмы управления ресурсами, позволяющие эффективно распределять вычислительные ресурсы (CPU, память) между подами и контейнерами. Это позволяет избежать конкуренции за ресурсы и обеспечивает предсказуемую работу приложений.

### Запросы и лимиты ресурсов

Каждый контейнер в Kubernetes может запрашивать определенное количество ресурсов и иметь ограничения на их использование. 

* **Запросы (requests)**: минимальное количество ресурса, гарантированно выделяемое контейнеру. Планировщик Kubernetes использует запросы для размещения подов на узлах с достаточным количеством свободных ресурсов.
* **Лимиты (limits)**: максимальное количество ресурса, которое контейнер может использовать. Лимиты предотвращают чрезмерное потребление ресурсов одним контейнером и защищают другие поды от нехватки ресурсов.

Запросы и лимиты задаются в файлах манифеста пода с помощью полей `resources.requests` и `resources.limits`. 

**Пример:**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: my-pod
spec:
  containers:
  - name: my-container
    image: my-image
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 200m
        memory: 512Mi
```

В этом примере контейнер `my-container`:

* **Запрашивает:** 100 миллиядер CPU (1/10 ядра) и 256 мебибайт памяти.
* **Ограничен:** 200 миллиядер CPU (1/5 ядра) и 512 мебибайт памяти.

**Единицы измерения:**

* **CPU:** миллиядра (m) - 1/1000 ядра.
* **Память:** 
    * Мибибайты (Mi) - 1024 * 1024 байт.
    * Гибибайты (Gi) - 1024 * 1024 * 1024 байт.

### Рекомендации по установке запросов и лимитов

* **Всегда устанавливайте лимиты ресурсов.** Это предотвратит неконтролируемое потребление ресурсов и защитит ваш кластер от перегрузки.
* **Устанавливайте реалистичные запросы ресурсов.** Запросы должны отражать реальные потребности приложения в ресурсах. 
* **Мониторьте потребление ресурсов.**  Используйте инструменты мониторинга для отслеживания использования ресурсов вашими подами и корректируйте запросы и лимиты при необходимости.

### Механизмы управления ресурсами

Kubernetes использует два основных механизма для управления ресурсами:

#### 1. Планирование подов

Планировщик Kubernetes использует запросы ресурсов для выбора узла, на котором будет запущен под. Планировщик учитывает доступные ресурсы на каждом узле и старается разместить под на узле с достаточным количеством свободных ресурсов.

#### 2. Контроль ресурсов (cgroups)

Kubernetes использует Linux cgroups для ограничения использования ресурсов контейнерами. Cgroups позволяют ограничивать использование CPU, памяти, диска и сети для каждого контейнера.

### Quality of Service (QoS)

Kubernetes использует QoS (качество обслуживания) для определения приоритета подов при нехватке ресурсов. Существует три класса QoS:

| Класс QoS   | Описание                                                                 | Пример использования       |
|--------------|-----------------------------------------------------------------------------|----------------------------|
| Guaranteed   | Поды с установленными и равными запросами и лимитами для всех контейнеров. | Критически важные сервисы |
| Burstable    | Поды, у которых хотя бы один контейнер имеет запрос, отличный от лимита.  | Приложения                |
| BestEffort   | Поды без указанных запросов и лимитов.                                   | Вспомогательные задачи    |

**Приоритеты при нехватке ресурсов:**

1. **Guaranteed:** получают ресурсы в первую очередь.
2. **Burstable:** получают ресурсы после подов Guaranteed.
3. **BestEffort:** получают ресурсы последними и могут быть вытеснены при нехватке ресурсов.

### Управление ресурсами на уровне Namespace

Вы можете управлять ресурсами на уровне Namespace с помощью **ResourceQuota**. ResourceQuota позволяет ограничить общее количество ресурсов, которые могут быть использованы подами в данном Namespace.

**Пример:**

```yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: my-resource-quota
spec:
  limits:
    requests.cpu: "2" # Ограничение на общие CPU запросы в namespace
    requests.memory: "1Gi" # Ограничение на общие запросы памяти в namespace
  scopes:
  - NotTerminating # Применяется к подам, не находящимся в состоянии завершения
```

### Заключение

Управление ресурсами - важная часть работы с Kubernetes. Правильное использование запросов, лимитов, QoS и ResourceQuota поможет вам обеспечить стабильность и эффективность вашего кластера. 

## Основы отладки в Kubernetes

Отладка - неотъемлемая часть работы с Kubernetes. В этой статье мы рассмотрим базовые техники отладки, которые помогут вам быстро находить и исправлять проблемы в ваших приложениях и кластере.

### Логи

Просмотр логов - это первое, с чего стоит начать отладку. Kubernetes предоставляет несколько способов доступа к логам ваших приложений:

**1. Логи пода:**

Самый простой способ - просмотреть логи конкретного пода. Используйте команду `kubectl logs`:

```bash
kubectl logs <имя-пода>
```

Для просмотра логов определенного контейнера в поде:

```bash
kubectl logs <имя-пода> -c <имя-контейнера>
```

**2. Логи с учетом истории:**

Для просмотра логов с учетом предыдущих запусков пода используйте флаг `--previous` (или `-p`):

```bash
kubectl logs <имя-пода> --previous
```

**3. Потоковая передача логов:**

Для просмотра логов в режиме реального времени используйте флаг `-f` (или `--follow`):

```bash
kubectl logs <имя-пода> -f
```

**4. Фильтрация логов:**

Kubernetes не предоставляет встроенных инструментов для фильтрации логов.  Для этого рекомендуется использовать инструменты, подобные `stern` или настраивать сбор и анализ логов с помощью Fluentd, Elasticsearch и Kibana (EFK) или подобных систем.

### Использование команды `kubectl describe`

Команда `kubectl describe` предоставляет подробную информацию об объектах Kubernetes, таких как поды, сервисы, ноды и деплойменты.  Эта информация может быть полезна при отладке:

```bash
kubectl describe pod <имя-пода>
```

```bash
kubectl describe service <имя-сервиса>
```

`kubectl describe` выводит информацию о состоянии объекта, его конфигурации, событиях и другую полезную информацию, которая поможет выявить причину проблемы.

### Использование команды `kubectl exec`

Команда `kubectl exec` позволяет выполнять команды в запущенном контейнере. Это может быть полезно для:

* **Проверки доступности сети:** 
    ```bash
    kubectl exec <имя-пода> -- ping google.com
    ```

* **Анализа файловой системы:**
    ```bash
    kubectl exec <имя-пода> -- ls -l /var/log
    ```

* **Запуска отладчика:**
    ```bash
    kubectl exec -it <имя-пода> -- bash
    ```

    **Важно:** Убедитесь, что ваш образ контейнера содержит необходимые инструменты для отладки.

### Использование портативного отладчика

Иногда простых команд недостаточно для поиска сложных ошибок. В таких случаях можно использовать отладчик.

**Пример:** Отладка приложения на Go с использованием Delve:

1. **Запустите ваш pod с включенным режимом отладки:**

    ```yaml
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: my-app
    spec:
      replicas: 1
      selector:
        matchLabels:
          app: my-app
      template:
        metadata:
          labels:
            app: my-app
        spec:
          containers:
          - name: my-app
            image: my-app:latest
            ports:
            - containerPort: 8080
            command: ["dlv"]
            args: ["--listen=:40000", "--headless=true", "--api-version=2", "exec", "/app", "--"]
    ```

    В данном примере мы:
    - Добавляем `command` и `args` для запуска приложения с помощью `dlv`.
    - Прослушиваем порт `40000` для подключения отладчика.
    - Запускаем приложение с помощью `exec /app`.

2. **Создайте port-forward для доступа к порту отладчика:**

    ```bash
    kubectl port-forward deployment/my-app 40000:40000
    ```

3. **Подключитесь к отладчику с вашего локального компьютера:**

    ```bash
    dlv connect localhost:40000
    ```

    Теперь вы можете использовать команды отладчика, такие как `break`, `continue`, `step`, для поиска и исправления ошибок.


### Заключение

В этой статье мы рассмотрели базовые техники отладки в Kubernetes. 
Для получения более подробной информации о техниках отладки, обратитесь к официальной документации Kubernetes. 

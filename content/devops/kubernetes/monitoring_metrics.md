## Настройка мониторинга и метрик в Kubernetes

Мониторинг и сбор метрик - критически важные аспекты управления кластером Kubernetes.  Они обеспечивают понимание состояния и производительности приложений и инфраструктуры, а также позволяют выявлять и устранять проблемы.  В этой статье мы рассмотрим базовые принципы настройки мониторинга и метрик в Kubernetes версии 1.28.

### Типы метрик

В Kubernetes доступны следующие типы метрик:

* **Метрики ресурсов**:  отслеживают использование ресурсов, таких как CPU, память, хранилище и сеть.  Эти метрики собираются компонентами kubelet и cAdvisor.
* **Метрики kubelet**:  предоставляют информацию о состоянии и производительности kubelet,  например,  количество запущенных подов и время отклика API сервера.
* **Метрики контроллеров**:  характеризуют работу контроллеров Kubernetes,  таких как Deployment, ReplicaSet,  и DaemonSet.
* **Пользовательские метрики**:  разработчики могут внедрять собственные метрики для сбора данных о приложениях.

### Инструменты мониторинга

Для сбора, хранения и визуализации метрик можно использовать различные инструменты:

* **Prometheus**:  популярная система мониторинга с открытым исходным кодом,  разработанная в  Cloud Native Computing Foundation (CNCF).  Prometheus использует модель pull-based для сбора метрик.
* **Metrics Server**:  легковесный инструмент,  входящий в состав Kubernetes,  предназначенный для сбора метрик ресурсов.  Metrics Server предоставляет данные API  Kubernetes.
* **Grafana**:  платформа для визуализации и анализа данных.  Grafana интегрируется с различными источниками данных,  включая Prometheus.

### Установка и настройка Prometheus и Grafana

#### Шаг 1.  Развертывание Prometheus

Для развертывания Prometheus в Kubernetes можно использовать Helm.  Выполните следующую команду:

```bash
helm repo add prometheus https://prometheus-community.github.io/helm-charts
helm install prometheus prometheus/prometheus --version 15.12.7
```

#### Шаг 2.  Развертывание Grafana

```bash
helm repo add grafana https://grafana.github.io/helm-charts
helm install grafana grafana/grafana --version 6.53.0
```

#### Шаг 3.  Настройка доступа к Grafana

Получите пароль для доступа к Grafana:

```bash
kubectl get secret --namespace default grafana-password -o jsonpath="{.data.admin-password}" | base64 --decode
```

Для доступа к  web-интерфейсу Grafana выполните команду:

```bash
kubectl port-forward service/grafana -n default 3000:80
```

Затем откройте браузер и перейдите по адресу `http://localhost:3000`,  используя имя пользователя `admin`  и полученный ранее пароль.

#### Шаг 4.  Добавление источника данных Prometheus в Grafana

1. В  web-интерфейсе Grafana нажмите на кнопку `Add your first data source`.
2. Выберите `Prometheus`  из списка доступных источников данных.
3. В поле  `URL`  укажите адрес сервиса Prometheus: `http://prometheus-server.default.svc.cluster.local`.
4. Нажмите кнопку  `Save & test`.

### Создание дашборда в Grafana

Grafana позволяет создавать дашборды для визуализации метрик.  

#### Шаг 1.  Импорт шаблона дашборда

Для импорта готового шаблона дашборда Kubernetes перейдите по ссылке:  https://grafana.com/grafana/dashboards/11823.

#### Шаг 2.  Настройка дашборда

После импорта шаблона настройте его в соответствии с конфигурацией вашего кластера.  Например,  вы можете изменить интервал времени или выбрать другие метрики для отображения.

### Заключение

В этой статье мы рассмотрели основы настройки мониторинга и сбора метрик в Kubernetes.  Мы изучили различные типы метрик,  ознакомились с популярными инструментами мониторинга,  а также  научились устанавливать и настраивать Prometheus и Grafana.  Полученные знания помогут вам эффективно отслеживать состояние и производительность вашего кластера Kubernetes. 

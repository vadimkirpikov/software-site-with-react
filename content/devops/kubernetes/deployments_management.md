## Создание и управление деплойментами

Деплойменты – это один из основных инструментов Kubernetes, который позволяет управлять развертыванием и обновлением приложений. Деплоймент представляет собой желаемое состояние приложения: сколько реплик должно быть запущено, какие образы контейнеров использовать и какие ресурсы им доступны. Kubernetes следит за состоянием деплоймента и автоматически вносит необходимые изменения, чтобы текущее состояние соответствовало желаемому.

### Создание деплоймента

Для создания деплоймента используется файл манифеста в формате YAML или JSON. В этом файле описывается конфигурация деплоймента, включая:

* **Имя деплоймента**: уникальное имя, по которому Kubernetes будет идентифицировать деплоймент.
* **Количество реплик**: количество одновременно работающих экземпляров приложения (подов).
* **Шаблон пода**: описание пода, который будет использоваться для запуска приложения. В шаблоне указывается используемый образ контейнера, необходимые ресурсы, переменные окружения и другие параметры.
* **Стратегия обновления**: определяет, как Kubernetes будет обновлять приложение при изменении образа контейнера или других параметров деплоймента.


#### Пример файла манифеста деплоймента:
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
replicas: 3
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.23.3
        ports:
        - containerPort: 80
```

#### Пошаговая инструкция по созданию деплоймента:

1. **Создайте файл манифеста деплоймента:**
    Создайте файл с именем `deployment.yaml` и скопируйте в него код примера манифеста, изменив имя деплоймента и другие параметры при необходимости.
2. **Создайте деплоймент:**
    Выполните следующую команду в терминале:

    ```bash
    kubectl apply -f deployment.yaml
    ```

    Kubernetes создаст деплоймент и запустит указанное количество реплик пода.
3. **Проверьте состояние деплоймента:**
    Выполните следующую команду, чтобы проверить состояние деплоймента:

    ```bash
    kubectl get deployments
    ```

    Вы должны увидеть созданный деплоймент в списке.


### Управление деплойментом

#### Масштабирование деплоймента

Для масштабирования деплоймента, т.е. изменения количества реплик, можно использовать команду `kubectl scale`:

```bash
# Увеличить количество реплик до 5
kubectl scale deployment nginx-deployment --replicas=5

# Уменьшить количество реплик до 2
kubectl scale deployment nginx-deployment --replicas=2
```

#### Обновление деплоймента

Для обновления приложения, например, для использования новой версии образа контейнера, необходимо изменить файл манифеста деплоймента и применить изменения:

1. **Измените файл манифеста:**
    Откройте файл `deployment.yaml` и измените необходимый параметр, например, версию образа контейнера.
2. **Примените изменения:**
    Выполните команду `kubectl apply -f deployment.yaml`, чтобы применить изменения.

    Kubernetes автоматически обновит приложение, используя указанную в манифесте стратегию обновления.

#### Стратегии обновления

Kubernetes поддерживает несколько стратегий обновления:

* **RollingUpdate (по умолчанию):**
    Постепенное обновление подов. Kubernetes будет создавать новые поды с обновленным приложением и удалять старые, пока все поды не будут обновлены.
* **Recreate:**
    Kubernetes удалит все старые поды и создаст новые с обновленным приложением. Эта стратегия может привести к временному простою приложения.

Стратегию обновления можно указать в файле манифеста деплоймента:

```yaml
spec:
  strategy:
    type: RollingUpdate
    # Параметры стратегии RollingUpdate
    rollingUpdate:
      maxSurge: 2 # Максимальное количество новых подов, которые могут быть созданы сверх желаемого количества реплик
      maxUnavailable: 1 # Максимальное количество подов, которые могут быть недоступны во время обновления
```

#### Откат деплоймента

Если после обновления приложения возникли проблемы, можно откатить деплоймент к предыдущей версии:

```bash
kubectl rollout undo deployment nginx-deployment
```

Эта команда вернет деплоймент к предыдущей стабильной версии.

#### Удаление деплоймента

Для удаления деплоймента и всех связанных с ним ресурсов используйте команду `kubectl delete`:

```bash
kubectl delete deployment nginx-deployment
```

### Заключение

Деплойменты – это мощный инструмент Kubernetes, который позволяет легко управлять развертыванием и обновлением приложений. 

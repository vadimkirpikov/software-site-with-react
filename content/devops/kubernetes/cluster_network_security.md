## Защита кластеров и сетей

Безопасность кластера Kubernetes — критически важный аспект его работы. Незащищенный кластер уязвим для различных угроз, таких как несанкционированный доступ, кража данных и прерывание работы сервисов. В этой части руководства мы рассмотрим базовые принципы и лучшие практики по защите кластеров Kubernetes версии 1.28 и сетей, в которых они развернуты.

### Управление доступом и аутентификация

#### RBAC (Role-Based Access Control)

RBAC — это механизм управления доступом, основанный на ролях. Он позволяет вам определить, кто и к каким ресурсам кластера имеет доступ и какие действия может выполнять. RBAC использует следующие сущности:

* **Role:** Определяет набор разрешений для доступа к ресурсам в пределах одного namespace.
* **ClusterRole:** Определяет набор разрешений для доступа к ресурсам во всех namespace или к кластерным ресурсам.
* **RoleBinding:** Связывает **Role** с пользователем, группой или сервисным аккаунтом, предоставляя им доступ к ресурсам в пределах namespace.
* **ClusterRoleBinding:** Связывает **ClusterRole** с пользователем, группой или сервисным аккаунтом, предоставляя им доступ к ресурсам во всех namespace или к кластерным ресурсам.

**Пример создания Role и RoleBinding:**

```yaml
# role.yaml
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: development
  name: pod-reader
rules:
- apiGroups: [""] # "" indicates the core API group
  resources: ["pods"]
  verbs: ["get", "list", "watch"]

---
# rolebinding.yaml
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
  namespace: development
subjects:
- kind: User
  name: jane # Пользователь "jane" будет иметь доступ к чтению Pod в namespace "development"
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io
```

#### Сервисные аккаунты (Service Accounts)

Сервисные аккаунты предоставляют идентификационные данные для приложений, работающих в кластере. Приложения могут использовать эти учетные данные для аутентификации в API Kubernetes и доступа к другим ресурсам.

**Пример создания сервисного аккаунта:**

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: my-service-account
```

#### Secrets

Secrets используются для хранения конфиденциальной информации, такой как пароли, токены доступа, ключи шифрования.

**Пример создания Secret:**

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: my-secret
type: Opaque
data:
  username: YWRtaW4= # base64 encoded value of "admin"
  password: cGFzc3dvcmQ= # base64 encoded value of "password"
```

### Защита сети

#### Network Policies

Network Policies позволяют контролировать сетевой трафик между подами, namespace и внешним миром. Вы можете использовать Network Policies для:

* Разрешения или запрета трафика на основе IP-адресов, портов и протоколов.
* Сегментации сети кластера на изолированные друг от друга части.
* Ограничения доступа к сервисам.

**Пример Network Policy, разрешающей трафик только из namespace "development":**

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-from-development
spec:
  podSelector: {} # Применяется ко всем подам в namespace
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          env: development
```

#### Использование Ingress контроллеров и SSL/TLS

Ingress контроллеры перенаправляют HTTP и HTTPS трафик извне кластера к сервисам внутри него. Использование Ingress контроллеров совместно с SSL/TLS сертификатами обеспечивает безопасность трафика между клиентами и вашим приложением.

#### Firewall

Firewall — это программное или аппаратное обеспечение, которое фильтрует сетевой трафик на основе набора правил. Настройка Firewall для кластера Kubernetes позволяет блокировать нежелательный трафик и повысить безопасность.

### Безопасность образов контейнеров

#### Сканирование образов на уязвимости

Регулярное сканирование образов контейнеров на наличие известных уязвимостей помогает предотвратить использование вредоносных образов в вашем кластере. Существует множество инструментов, которые могут автоматизировать этот процесс, например, Clair, Trivy, Anchore Engine.

#### Использование доверенных registry

Храните образы контейнеров в доверенных registry, таких как Docker Hub, Google Container Registry, Amazon Elastic Container Registry. Убедитесь, что registry использует HTTPS для защиты данных во время передачи.

### Аудит и мониторинг

#### Аудит событий

Аудит событий позволяет отслеживать действия, выполняемые в кластере, такие как создание, изменение или удаление ресурсов, аутентификация пользователей и т.д. Информация о событиях хранится в логах и может быть использована для анализа инцидентов безопасности и расследований.

#### Мониторинг состояния кластера

Постоянный мониторинг состояния кластера, включая использование ресурсов, производительность приложений, состояние сети, позволяет выявлять аномалии, которые могут указывать на проблемы безопасности или атаки.

### Дополнительные рекомендации

* Регулярно обновляйте Kubernetes и используемые вами плагины до последних версий, чтобы исправлять уязвимости безопасности.
* Ограничьте доступ к API Kubernetes, используя аутентификацию и авторизацию.
* Используйте сильные пароли и управляйте ими с помощью менеджера паролей.
* Обучайте своих сотрудников основам безопасности Kubernetes и лучшим практикам.

Следование этим рекомендациям поможет вам создать защищенный кластер Kubernetes и обеспечить безопасность ваших приложений и данных.

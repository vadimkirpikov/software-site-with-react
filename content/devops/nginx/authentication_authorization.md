## Аутентификация и авторизация в Nginx

Безопасность веб-приложений - критически важный аспект, который нельзя игнорировать. В этом разделе мы рассмотрим, как реализовать аутентификацию и авторизацию в Nginx, защищая доступ к вашему контенту.

### Аутентификация

Аутентификация - это процесс проверки подлинности пользователя, подтверждающий, что он является тем, за кого себя выдает. Nginx поддерживает различные методы аутентификации, включая:

* **HTTP Basic Authentication:** Простой и широко распространенный метод, использующий имя пользователя и пароль, передаваемые в заголовке Authorization. 
* **Внешние модули аутентификации:** Nginx может интегрироваться с внешними серверами аутентификации, такими как LDAP или OAuth2.

#### HTTP Basic Authentication

**1. Создание файла паролей:**

Для использования HTTP Basic Authentication необходимо создать файл с зашифрованными паролями. Используйте утилиту `htpasswd`:

```bash
sudo htpasswd -c /etc/nginx/htpasswd.users username
```

Замените `username` на желаемое имя пользователя. Вам будет предложено ввести и подтвердить пароль. Файл `htpasswd.users` будет создан (или перезаписан с флагом `-c`) в директории `/etc/nginx/`.

**2. Настройка Nginx:**

Добавьте следующие директивы в конфигурационный файл вашего сайта Nginx (обычно расположенный в `/etc/nginx/sites-available/`):

```nginx
location /protected/ {
    auth_basic "Restricted Area";
    auth_basic_user_file /etc/nginx/htpasswd.users;
}
```

* `auth_basic "Restricted Area";` - задает текст, который будет отображаться в окне аутентификации браузера.
* `auth_basic_user_file /etc/nginx/htpasswd.users;` - указывает путь к файлу с зашифрованными паролями.

**3. Перезагрузка Nginx:**

```bash
sudo systemctl reload nginx
```

Теперь при попытке доступа к `/protected/`  будет запрошено имя пользователя и пароль.

#### Внешние модули аутентификации

Nginx поддерживает интеграцию с различными внешними модулями аутентификации. Например, модуль `auth_request` позволяет перенаправлять запросы аутентификации на внешний сервер.

**Пример конфигурации с `auth_request`:**

```nginx
location /protected/ {
    auth_request /auth;
    # ... другие директивы 
}

location /auth {
    internal;
    proxy_pass http://your_auth_server;
}
```

Этот пример демонстрирует перенаправление запросов на `/protected/` к `/auth`. Локация `/auth` настроена как `internal`, что означает, что она доступна только внутри Nginx, и использует `proxy_pass` для пересылки запросов на внешний сервер аутентификации.

### Авторизация

Авторизация - это процесс проверки, имеет ли аутентифицированный пользователь доступ к запрошенному ресурсу. Nginx предоставляет несколько механизмов авторизации:

* **Директивы доступа:**  Позволяют ограничивать доступ по IP-адресам, имени хоста и другим параметрам.
* **Внешние модули авторизации:**  Аналогично аутентификации, Nginx может интегрироваться с внешними серверами авторизации.

#### Директивы доступа

Nginx предоставляет следующие директивы для управления доступом:

* **`allow`:** Разрешает доступ с указанных IP-адресов или сетей.
* **`deny`:** Запрещает доступ с указанных IP-адресов или сетей.

**Пример ограничения доступа по IP-адресу:**

```nginx
location /admin/ {
    allow 192.168.1.0/24; # Разрешить доступ только с подсети 192.168.1.0/24
    deny all; # Запретить доступ всем остальным
}
```

#### Внешние модули авторизации

Модуль `auth_request`  также может быть использован для авторизации. После успешной аутентификации внешний сервер может вернуть Nginx информацию о разрешениях пользователя. Nginx, в свою очередь, может использовать эту информацию для принятия решения о доступе.

**Пример использования `auth_request` для авторизации:**

```nginx
location /premium/ {
    auth_request /auth;
    auth_request_set $auth_status $upstream_http_x_auth_status; 
    
    if ($auth_status != "authorized") {
        return 403;
    }
}

location /auth {
    internal;
    proxy_pass http://your_auth_server;
    proxy_set_header X-User $remote_user; 
}
```

В этом примере:

*  `auth_request_set` сохраняет значение заголовка `X-auth-status`, полученного от сервера авторизации, в переменной `$auth_status`.
*  Блок `if` проверяет значение `$auth_status` и возвращает ошибку 403 (Forbidden), если пользователь не авторизован.

**Заключение**

В этом разделе мы рассмотрели базовые принципы аутентификации и авторизации в Nginx. Выбор конкретного метода зависит от ваших потребностей и архитектуры приложения.  Nginx предлагает гибкие инструменты для реализации различных сценариев безопасности, позволяя вам защитить ваши веб-приложения от несанкционированного доступа.

<h2>Конфигурация кэширования запросов в Nginx</h2>

Кэширование запросов в Nginx — мощный механизм для повышения производительности веб-сервера и снижения нагрузки на бэкенд. Он позволяет сохранять копии ответов от сервера и отдавать их клиентам напрямую, минуя обращение к бэкенду. 

В этой статье мы подробно рассмотрим, как настроить кэширование запросов в Nginx.

### Основы кэширования в Nginx

Nginx использует трехуровневую иерархию для кэширования:

1. **proxy_cache_path:** Директива, определяющая расположение и параметры кэша на диске. 
2. **proxy_cache:** Директива, активирующая кэш для определенного location или группы location'ов. 
3. **proxy_cache_key:** Директива, определяющая ключ кэша, по которому Nginx будет искать и хранить запросы.

### Настройка кэша на диске

Первым шагом необходимо определить местоположение и параметры кэша на диске с помощью директивы `proxy_cache_path`:

```nginx
http {
    ... 
    proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;
    ...
}
```

Разберем параметры директивы:

* **/var/cache/nginx/cache:** Путь к директории кэша.
* **levels=1:2:** Структура подпапок кэша. В данном случае создается двухуровневая структура, где первый уровень содержит 1 каталог, а второй - 2 каталога.
* **keys_zone=my_cache:10m:** Имя и размер зоны памяти для хранения метаданных кэша. В данном случае зона называется "my_cache" и имеет размер 10 мегабайт.
* **max_size=1g:** Максимальный размер кэша на диске (1 гигабайт).
* **inactive=60m:** Время жизни неиспользуемых файлов кэша (60 минут).
* **use_temp_path=off:** Отключает использование временной директории для записи файлов кэша.

### Активация кэша для location

Далее необходимо активировать кэш для определенного location или группы location'ов с помощью директивы `proxy_cache`:

```nginx
server {
    ...
    location /images/ {
        proxy_pass http://backend;
        proxy_cache my_cache; # Используем созданную ранее зону кэша
        proxy_cache_valid 200 1h; # Кэшируем ответы с кодом 200 на 1 час
    }
    ...
}
```

В этом примере мы активируем кэш для всех запросов к `/images/` и указываем, что ответы с кодом 200 должны кэшироваться в течение 1 часа.

### Определение ключа кэша

Директива `proxy_cache_key` определяет, как формируется ключ кэша. По умолчанию ключ формируется из следующих элементов:

```
$scheme$request_method$host$request_uri
```

* **$scheme:** Протокол запроса (http или https).
* **$request_method:** Метод HTTP-запроса (GET, POST и т.д.).
* **$host:** Имя хоста, на который был отправлен запрос.
* **$request_uri:** Запрашиваемый URI, включая аргументы запроса.

Вы можете изменить ключ кэша, добавив или удалив переменные. Например, чтобы исключить аргументы запроса из ключа, используйте следующий код:

```nginx
proxy_cache_key "$scheme$request_method$host$uri";
```

### Управление кэшированием

Nginx предоставляет ряд директив для управления кэшированием:

* **proxy_cache_valid:**  Определяет время жизни кэшированных ответов в зависимости от кода ответа сервера.
* **proxy_cache_revalidate:**  Включает валидацию устаревших ответов на стороне origin-сервера.
* **proxy_cache_bypass:**  Определяет условия, при которых запрос не будет кэшироваться.
* **proxy_no_cache:**  Определяет условия, при которых ответ не будет кэшироваться.
* **proxy_cache_min_uses:**  Указывает, сколько раз ответ должен быть запрошен, прежде чем он будет сохранен в кэше.

### Пример комплексной конфигурации

```nginx
http {
    ...
    proxy_cache_path /var/cache/nginx/cache levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;
    
    server {
        ...
        location /images/ {
            proxy_pass http://backend;
            proxy_cache my_cache;
            proxy_cache_valid 200 1h;
            proxy_cache_valid 404 1m; # Кэшируем 404 ошибки на 1 минуту
            proxy_cache_key "$scheme$request_method$host$uri"; 
        }
        
        location /api/ {
            proxy_pass http://backend;
            proxy_cache_bypass $http_user_agent ~* "curl"; # Не кэшируем запросы от curl
        }
        ...
    }
}
```

В этом примере мы настроили кэширование для изображений, 404 ошибок и добавили условие для обхода кэша при запросах от curl. 

Это лишь базовые сведения о конфигурации кэширования запросов в Nginx. 

## Маршрутизация запросов в Nginx

Nginx — это не просто веб-сервер, но и мощный инструмент для маршрутизации запросов. С помощью директив Nginx можно гибко управлять трафиком, направляя его на разные серверы, приложения или обрабатывая его особым образом в зависимости от множества факторов.

### Базовая маршрутизация

В основе маршрутизации запросов в Nginx лежат блоки `server`, определённые в конфигурационном файле. Каждый блок `server` обычно привязан к определённому IP-адресу и/или порту, а также может обрабатывать запросы к определённым доменным именам.

Пример блока `server`:

```nginx
server {
    listen 80;
    server_name example.com;

    location / {
        root /var/www/example.com;
        index index.html;
    }
}
```

В этом примере:

- `listen 80`: блок `server` будет обрабатывать запросы, поступающие на порт 80.
- `server_name example.com`: блок `server` будет обрабатывать запросы к домену `example.com`.
- `location /`: блок `location` определяет, как обрабатывать запросы к корневому пути сайта (`/`).
- `root /var/www/example.com`: указывает корневую директорию сайта, где хранятся файлы.
- `index index.html`: указывает файл по умолчанию (`index.html`), который будет отдан клиенту при запросе к корневому пути сайта.

### Директива `location`

Директива `location` позволяет задавать правила обработки запросов в зависимости от указанного в URL пути. 

Существует два основных типа блоков `location`:

1. **С префиксным совпадением:** 
    - Путь в директиве `location` указывается как префикс URL.
    - Например, `location /images/` будет обрабатывать все запросы, начинающиеся с `/images/`.
2. **С регулярным выражением:**
    - Путь в директиве `location` указывается как регулярное выражение, заключённое в символы `~`. 
    - Например, `location ~ \.jpg$` будет обрабатывать все запросы, заканчивающиеся на `.jpg`.

Nginx проверяет блоки `location` в определённом порядке и выбирает первый подходящий:

1. Блоки с префиксным совпадением, указанные с модификатором `=`.
2. Блоки с префиксным совпадением в порядке их следования в конфигурационном файле.
3. Блоки с регулярными выражениями в порядке их следования в конфигурационном файле.
4. Блок `location /`, если ни один из предыдущих блоков не подошёл.

### Перенаправление и проксирование запросов

#### Перенаправление

Nginx позволяет перенаправлять запросы с одного URL на другой. Это делается с помощью директив `return` и `rewrite`:

```nginx
# Перенаправление с http на https
server {
    listen 80;
    server_name example.com;
    return 301 https://$host$request_uri;
}

# Перенаправление с www на домен без www
server {
    listen 443 ssl;
    server_name www.example.com;
    return 301 https://example.com$request_uri;
}
```

#### Проксирование

Nginx может выступать в роли обратного прокси-сервера, перенаправляя запросы на другие серверы или приложения.

Пример конфигурации проксирования:

```nginx
server {
    listen 80;
    server_name example.com;

    location /api/ {
        proxy_pass http://backend_server:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

В этом примере все запросы к `/api/` будут проксироваться на сервер `backend_server:8080`.

### Обработка статических файлов

Nginx может эффективно обрабатывать статические файлы (изображения, CSS, JavaScript), разгружая тем самым backend-серверы. 

Для этого необходимо сконфигурировать блок `location` с указанием пути к директории со статическими файлами:

```nginx
server {
    listen 80;
    server_name example.com;

    location /static/ {
        root /var/www/example.com;
        expires 30d;
        add_header Cache-Control "public";
    }
}
```

В этом примере:

- `expires 30d`: файлы будут кэшироваться браузером в течение 30 дней.
- `add_header Cache-Control "public"`: указывает, что файлы можно кэшировать.

### Заключение

Это лишь базовые возможности маршрутизации запросов в Nginx. 
Изучение документации и эксперименты с различными конфигурациями помогут вам максимально эффективно использовать Nginx для управления трафиком и оптимизации работы ваших веб-приложений. 

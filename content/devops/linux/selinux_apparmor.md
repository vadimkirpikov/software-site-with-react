## Защита приложений с помощью SELinux и AppArmor

SELinux (Security-Enhanced Linux) и AppArmor — это модули безопасности ядра Linux, реализующие принцип обязательного контроля доступа (MAC). Они ограничивают действия, которые могут выполнять процессы, даже если система скомпрометирована.

### SELinux: Гибкий контроль на основе политик

SELinux использует политики безопасности для определения того, какие ресурсы могут использовать процессы. Политика состоит из правил, определяющих разрешения для субъектов (процессов) на объекты (файлы, порты и т. д.).

#### Режимы работы SELinux:

* **Enforcing:** Применяет политику безопасности, блокируя запрещенные действия.
* **Permissive:** Не блокирует действия, но регистрирует нарушения политики в лог-файлах.
* **Disabled:** Отключает SELinux.

#### Управление SELinux:

1. **Проверка статуса:**
    ```bash
    sestatus
    ```
2. **Временное изменение режима (перезагрузка отменит изменения):**
    ```bash
    # Переключение в permissive mode
    sudo setenforce 0 
    # Переключение в enforcing mode
    sudo setenforce 1
    ```
3. **Постоянное изменение режима:**
   Отредактируйте файл `/etc/selinux/config` и установите значение `SELINUX` на нужный режим.

#### Пример настройки SELinux:

Допустим, нужно разрешить веб-серверу Nginx доступ к директории `/srv/www/example.com`.

1. **Определение контекста безопасности директории:**
    ```bash
    ls -dZ /srv/www/example.com
    ```
   В выводе команды будет указан контекст безопасности, например, `system_u:object_r:httpd_sys_content_t:s0`.
2. **Создание правила политики SELinux:**
    ```bash
    sudo semanage fcontext -a -t httpd_sys_content_t "/srv/www/example.com(/.*)?"
    sudo semanage fcontext -m -t httpd_sys_content_t "/srv/www/example.com(/.*)?"
    ```
   Эти команды задают контекст `httpd_sys_content_t` для директории `/srv/www/example.com` и всех ее поддиректорий.
3. **Применение изменений:**
    ```bash
    sudo restorecon -Rv /srv/www/example.com
    ```

### AppArmor: Простой и понятный контроль доступа

AppArmor использует профили безопасности, определяющие разрешения для каждого приложения. Профиль представляет собой список правил, описывающих доступные приложению операции с файлами, сетевыми ресурсами и т. д.

#### Управление AppArmor:

1. **Проверка статуса:**
    ```bash
    sudo systemctl status apparmor
    ```
2. **Просмотр доступных профилей:**
    ```bash
    sudo apparmor_status
    ```
3. **Загрузка/выгрузка профиля:**
    ```bash
    sudo apparmor_parser -a /path/to/profile.apparmor
    sudo apparmor_parser -R /path/to/profile.apparmor
    ```

#### Создание профиля AppArmor:

Создадим профиль для ограничения доступа к файловой системе для приложения `myapp`.

1. **Генерируем шаблон профиля:**
    ```bash
    sudo aa-genprof /path/to/myapp
    ```
2. **Редактируем сгенерированный файл профиля (`/etc/apparmor.d/usr.bin.myapp`):**
    ```
    # Название профиля
    profile usr.bin.myapp flags=(attach_disconnected) {
      # Разрешаем чтение и выполнение файлов в /usr/bin
      /usr/bin/** rxl,
      
      # Разрешаем чтение и запись в /var/log/myapp.log
      /var/log/myapp.log rw,
      
      # Запрещаем любые другие действия
      deny others,
    }
    ```
3. **Загружаем профиль:**
    ```bash
    sudo apparmor_parser -a /etc/apparmor.d/usr.bin.myapp
    ```

### Выбор между SELinux и AppArmor

| Характеристика | SELinux                             | AppArmor                        |
|-----------------|--------------------------------------|-----------------------------------|
| Сложность        | Сложнее в настройке                   | Проще в настройке                |
| Гибкость          | Более гибкая система политик         | Ограниченность в некоторых аспектах |
| Распространенность | Широко используется в RHEL-системах | Популярен в Debian-системах       |

Выбор между SELinux и AppArmor зависит от ваших потребностей и предпочтений.  SELinux предоставляет более детальный контроль над безопасностью, в то время как AppArmor проще в настройке и использовании.

## Миграции баз данных: Alembic

Разработка веб-приложений редко обходится без изменений в структуре базы данных. Новые функции могут требовать добавления таблиц, колонок или изменения отношений между ними. Вручную отслеживать эти изменения, особенно в команде разработчиков, быстро становится проблематично. На помощь приходят инструменты миграции, такие как Alembic, тесно интегрированный с Flask.

Alembic – это легковесная библиотека, позволяющая версионировать изменения в базе данных и применять их последовательно. 

### Установка Alembic

Прежде чем начать, убедитесь, что Alembic установлен. Используйте pip:

```bash
pip install alembic
```

### Интеграция с Flask

Для удобной работы с Alembic в контексте Flask приложения, настроим расширение Flask-Migrate:

```bash
pip install Flask-Migrate
```

Flask-Migrate выступает мостом между Flask и Alembic, упрощая инициализацию и выполнение миграций.

Теперь создадим простое Flask приложение с использованием SQLAlchemy для взаимодействия с базой данных:

```python
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///app.db'  # Используем SQLite для примера
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
db = SQLAlchemy(app)
migrate = Migrate(app, db)  # Инициализируем Flask-Migrate

# Определение модели
class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True, nullable=False)
    email = db.Column(db.String(120), unique=True, nullable=False)

    def __repr__(self):
        return f'<User {self.username}>'

if __name__ == '__main__':
    app.run(debug=True)
```

В этом примере мы:

1.  Импортировали необходимые классы из `flask`, `flask_sqlalchemy` и `flask_migrate`.
2.  Создали экземпляр Flask приложения.
3.  Настроили подключение к базе данных SQLite.
4.  Создали экземпляры `SQLAlchemy` и `Migrate`, связав их с приложением и базой данных.
5.  Определили простую модель `User` с полями `id`, `username` и `email`.

### Инициализация Alembic

После настройки приложения выполним команду для инициализации Alembic:

```bash
flask db init
```

Эта команда создаст папку `migrations` в корне вашего проекта. Внутри нее находятся файлы конфигурации Alembic и скрипты для управления миграциями.

### Создание миграции

Теперь, когда Alembic инициализирован, создадим первую миграцию.  Добавим новое поле `password_hash` в модель `User`:

```python
class User(db.Model):
    # ... (предыдущие поля)
    password_hash = db.Column(db.String(128))
```

Сохраните изменения и выполните команду:

```bash
flask db migrate -m "Add password hash to User model"
```

Alembic проанализирует изменения в моделях и сгенерирует файл миграции в папке `migrations/versions`. Файл содержит две функции: `upgrade` и `downgrade`, описывающие операции для применения и отката миграции соответственно.

### Применение миграции

Чтобы применить созданную миграцию к базе данных, выполните команду:

```bash
flask db upgrade
```

Alembic выполнит инструкции из функции `upgrade` в файле миграции, добавляя новое поле в таблицу `user`.

### Откат миграции

Если требуется отменить последнюю примененную миграцию, используйте команду:

```bash
flask db downgrade
```

Alembic выполнит инструкции из функции `downgrade`, возвращая базу данных к предыдущему состоянию.

### Работа с несколькими миграциями

По мере разработки приложения вы будете создавать множество миграций. Alembic хранит историю примененных миграций, позволяя легко перемещаться между версиями схемы базы данных.

Для просмотра истории миграций выполните:

```bash
flask db history
```

### Заключение

Использование Alembic значительно упрощает управление изменениями в базе данных, делая процесс разработки более прозрачным и контролируемым. Версионирование миграций позволяет легко делиться изменениями с коллегами, разворачивать приложение на разных окружениях и быть уверенным в целостности данных. 

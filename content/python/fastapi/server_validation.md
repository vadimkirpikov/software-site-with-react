## Валидация данных на стороне сервера

Валидация данных - критически важный этап разработки любого API. Она позволяет убедиться, что данные, поступающие от клиентов, соответствуют ожидаемому формату и содержат необходимую информацию. FastAPI предоставляет мощные инструменты для валидации данных на основе аннотаций типов из библиотеки Pydantic.

### Основы валидации с помощью Pydantic

Pydantic - библиотека для валидации данных и управления ими, которая тесно интегрирована с FastAPI. Используя аннотации типов, Pydantic позволяет описывать структуру данных и задавать правила валидации.

**Пример:**

```python
from fastapi import FastAPI
from pydantic import BaseModel

app = FastAPI()

class User(BaseModel):
    id: int
    name: str
    signup_ts: datetime = None
    friends: List[int] = []

@app.post("/users/")
async def create_user(user: User):
    return user
```

В этом примере мы определяем модель Pydantic `User` с четырьмя полями:

* `id`: Целое число, обязательное поле.
* `name`: Строка, обязательное поле.
* `signup_ts`: Объект `datetime`, необязательное поле (может быть `None`).
* `friends`: Список целых чисел, по умолчанию пустой список.

Аннотация типа `User` в функции `create_user`  автоматически выполняет валидацию:

1. Проверяет, что все обязательные поля присутствуют в запросе.
2. Преобразует данные к указанным типам (например, строку в `datetime`).
3. Если данные не проходят валидацию, генерируется информативное сообщение об ошибке.

### Стандартные типы данных и валидаторы

Pydantic поддерживает все стандартные типы данных Python, а также предоставляет дополнительные типы и валидаторы:

| Тип данных     | Описание                                                                       |
|-----------------|---------------------------------------------------------------------------------|
| `str`          | Строка                                                                         |
| `int`          | Целое число                                                                     |
| `float`        | Число с плавающей точкой                                                     |
| `bool`         | Логическое значение (True/False)                                            |
| `List`         | Список                                                                          |
| `Tuple`        | Кортеж                                                                          |
| `Dict`         | Словарь                                                                         |
| `datetime`     | Дата и время                                                                    |
| `EmailStr`     | Строка, содержащая валидный адрес электронной почты                             |
| `HttpUrl`      | Строка, содержащая валидный URL-адрес                                          |
| `UUID`         | Универсальный уникальный идентификатор (UUID)                                |
| `FilePath`     | Путь к файлу                                                                  |
| `conint`       | Ограниченное целое число (например, `conint(gt=0)` - положительное число)  |
| `constr`       | Ограниченная строка (например, `constr(max_length=50)`)                      |

**Пример использования ограниченных типов:**

```python
from pydantic import conint, constr

class Item(BaseModel):
    id: conint(gt=0)  # ID должно быть больше 0
    name: constr(max_length=50)  # Название не более 50 символов
```

### Пользовательские сообщения об ошибках

Pydantic позволяет нап

ользовательские сообщения об ошибках валидации, чтобы сделать API более информативным для клиентов. 

**Пример:**

```python
from fastapi import FastAPI, HTTPException
from pydantic import BaseModel, validator

app = FastAPI()

class Item(BaseModel):
    id: int
    name: str

    @validator("id")
    def id_must_be_positive(cls, value):
        if value <= 0:
            raise ValueError("ID must be positive")
        return value

@app.post("/items/")
async def create_item(item: Item):
    return item
```

В этом примере мы используем декоратор `@validator` для создания собственного валидатора для поля `id`. 
Если `id` меньше или равно 0, генерируется исключение `ValueError` с кастомным сообщением.

### Валидация на основе запроса

Иногда валидация может зависеть от данных, передаваемых в самом запросе. FastAPI позволяет получать доступ к объекту запроса `Request` внутри функций валидации.

**Пример:**

```python
from fastapi import FastAPI, Request
from pydantic import BaseModel

app = FastAPI()

class Item(BaseModel):
    id: int
    name: str

    @validator("name")
    def name_must_be_unique(cls, value, values, **kwargs):
        request: Request = kwargs["request"]
        # Проверка уникальности имени в базе данных
        # ...
        return value

@app.post("/items/")
async def create_item(request: Request, item: Item):
    return item
```

В этом примере мы получаем доступ к объекту `request` внутри функции `name_must_be_unique`. 
Это позволяет, например, выполнить проверку уникальности имени в базе данных.


### Заключение

Валидация данных - важный аспект разработки API с FastAPI. Использование аннотаций типов Pydantic позволяет легко и удобно выполнять валидацию данных на стороне сервера, обеспечивая целостность и корректность данных в вашем приложении.

В дальнейшем мы рассмотрим более продвинутые возможности валидации данных, такие как:

* Использование кастомных типов данных.
* Валидация с использованием внешних библиотек.
* Обработка ошибок валидации.

Освоив эти техники, вы сможете создавать надежные и безопасные API на основе FastAPI.

## Определение моделей с помощью Pydantic

FastAPI тесно интегрирован с Pydantic, мощной библиотекой для валидации данных и управления ими в Python. Pydantic позволяет легко определять модели данных, используя подсказки типов и предоставляя автоматическую валидацию, сериализацию и документирование.

### Основы Pydantic

Чтобы начать использовать Pydantic, импортируйте класс `BaseModel`:

```python
from pydantic import BaseModel
```

Для создания модели данных определите класс, наследуемый от `BaseModel`. Атрибуты модели определяются с использованием стандартных подсказок типов Python:

```python
class User(BaseModel):
    id: int
    name: str
    signup_ts: datetime = None  # Необязательное поле
    friends: list[int] = []  # Список друзей с дефолтным значением
```

В этом примере мы определили модель `User` с четырьмя атрибутами:

- `id`: Целочисленный идентификатор пользователя.
- `name`: Строка с именем пользователя.
- `signup_ts`: Необязательное поле типа `datetime`, представляющее дату и время регистрации.
- `friends`: Список целых чисел, представляющий идентификаторы друзей пользователя. По умолчанию - пустой список.

### Создание экземпляров модели

Для создания экземпляра модели просто передайте значения атрибутов в конструктор класса:

```python
user = User(id=1, name="John Doe", signup_ts="2023-11-13T12:00:00", friends=[2, 3])
```

Pydantic автоматически выполнит следующие действия:

- **Валидация данных:** Проверит, соответствуют ли переданные значения типам, указанным в модели.
- **Преобразование типов:** При необходимости преобразует данные в указанные типы. Например, строка `"2023-11-13T12:00:00"` будет автоматически преобразована в объект `datetime`.
- **Установку значений по умолчанию:** Если значение атрибута не передано, будет использовано значение по умолчанию, если оно определено.

### Доступ к атрибутам модели

Доступ к атрибутам модели осуществляется как к атрибутам обычного объекта Python:

```python
print(user.id)  # Выведет: 1
print(user.name)  # Выведет: John Doe
```

### Сериализация модели

Pydantic предоставляет встроенные методы для сериализации моделей в различные форматы, например JSON:

```python
user_json = user.json()
print(user_json)
```

Это выведет JSON-представление объекта `user`:

```json
{"id": 1, "name": "John Doe", "signup_ts": "2023-11-13T12:00:00", "friends": [2, 3]}
```

### Валидация данных

Одним из главных преимуществ Pydantic является автоматическая валидация данных. Если передать неверные данные в конструктор модели, Pydantic вызовет исключение `ValidationError`:

```python
try:
    user = User(id="not an integer", name=123)
except ValidationError as e:
    print(e.json())
```

### Пользовательские типы данных

Pydantic позволяет создавать собственные типы данных, расширяя базовый класс `BaseModel` или используя декоратор `@validator`:

```python
from pydantic import BaseModel, validator


class Email(BaseModel):
    address: str

    @validator("address")
    def validate_email(cls, value):
        if "@" not in value:
            raise ValueError("Invalid email address")
        return value


class User(BaseModel):
    email: Email
```

В этом примере мы определили пользовательский тип данных `Email` с валидатором, проверяющим наличие символа "@" в адресе электронной почты.

### Использование Pydantic с FastAPI

Pydantic идеально подходит для использования с FastAPI. Модели Pydantic можно использовать для определения структуры тела запроса, параметров пути и ответа:

```python
from fastapi import FastAPI
from pydantic import BaseModel


class Item(BaseModel):
    name: str
    description: str | None = None
    price: float
    tax: float | None = None


app = FastAPI()


@app.post("/items/")
async def create_item(item: Item):
    return item
```

В этом примере мы определили модель `Item` и использовали ее в качестве типа параметра `item` для обработчика маршрута `/items/`. FastAPI автоматически выполнит следующие действия:

- **Валидация данных:** Проверит, соответствует ли тело запроса структуре, определенной в модели `Item`.
- **Преобразование данных:** Преобразует данные из JSON в объекты Python, соответствующие модели `Item`.
- **Документирование API:** Автоматически сгенерирует интерактивную документацию OpenAPI, используя аннотации типов Pydantic.

### Заключение

Pydantic - мощная библиотека, которая значительно упрощает работу с данными в FastAPI. Используя Pydantic, можно легко определять модели данных, выполнять валидацию, сериализацию и документирование API. 

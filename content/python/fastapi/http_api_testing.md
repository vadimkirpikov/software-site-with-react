## Тестирование HTTP-запросов и API в FastAPI

Тестирование — неотъемлемая часть разработки надежных и стабильных приложений. FastAPI, благодаря своей асинхронной природе и тесной интеграции с `pytest`, предоставляет широкие возможности для тестирования HTTP-запросов и API. В этом разделе мы рассмотрим основные техники и инструменты для эффективного тестирования ваших FastAPI приложений.

### Инструменты для тестирования

#### pytest

`pytest` — это популярный фреймворк для тестирования Python кода, который мы будем использовать для написания и запуска тестов. `pytest` обладает гибкой системой плагинов и фикстур, что делает его мощным инструментом для тестирования различных аспектов вашего приложения.

#### TestClient

FastAPI предоставляет встроенный класс `TestClient`, который упрощает отправку тестовых HTTP-запросов к вашему приложению. `TestClient` работает поверх ASGI-сервера, запуская ваше приложение в тестовой среде.

#### Библиотеки для мокинга

В процессе тестирования часто возникает необходимость изолировать тестируемый код от внешних зависимостей, таких как базы данных, внешние API и т.д. В этом случае на помощь приходят библиотеки для мокинга, такие как `pytest-mock` или `unittest.mock`, которые позволяют заменить реальные зависимости на контролируемые имитации.

### Настройка тестовой среды

Для начала установим необходимые зависимости:

```bash
pip install pytest pytest-asyncio
```

### Базовый пример тестирования

Рассмотрим простой пример API, который возвращает сообщение "Hello, world!":

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def read_root():
    return {"message": "Hello, world!"}
```

Создадим файл `test_main.py` с тестом для этого API:

```python
from fastapi.testclient import TestClient

from main import app  # Импортируем наше FastAPI приложение

client = TestClient(app)

def test_read_root():
    response = client.get("/")
    assert response.status_code == 200
    assert response.json() == {"message": "Hello, world!"}
```

В этом тесте мы:

1. Создаем экземпляр `TestClient`, передавая ему наше FastAPI приложение.
2. Определяем тестовую функцию `test_read_root`.
3. Отправляем GET-запрос к корневому пути (`/`) с помощью `client.get("/")`.
4. Проверяем, что код ответа равен 200 (OK).
5. Проверяем, что тело ответа в формате JSON соответствует ожидаемому значению.

Запустим тест с помощью `pytest`:

```bash
pytest
```

`pytest` автоматически обнаружит и выполнит тестовую функцию, выводя результаты в консоль.

### Тестирование с параметрами

Рассмотрим пример API, который принимает имя в качестве параметра запроса и возвращает персонализированное приветствие:

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/greet/{name}")
async def greet_user(name: str):
    return {"message": f"Hello, {name}!"}
```

Тест для этого API:

```python
from fastapi.testclient import TestClient

from main import app

client = TestClient(app)

def test_greet_user():
    name = "Alice"
    response = client.get(f"/greet/{name}")
    assert response.status_code == 200
    assert response.json() == {"message": f"Hello, {name}!"}
```

В этом тесте мы передаем имя "Alice" в URL запроса и проверяем, что ответ содержит правильное приветствие.

### Тестирование POST-запросов

Для тестирования POST-запросов мы можем использовать метод `client.post()`, передавая данные в теле запроса.

```python
from fastapi import FastAPI

app = FastAPI()

@app.post("/items/")
async def create_item(item: dict):
    return item

# Тест
def test_create_item():
    response = client.post("/items/", json={"id": 1, "name": "Item 1"})
    assert response.status_code == 200
    assert response.json() == {"id": 1, "name": "Item 1"}
```

В этом примере мы отправляем POST-запрос с JSON-данными в теле запроса и проверяем, что сервер возвращает те же данные в ответе.

### Заключение

Мы рассмотрели базовые техники тестирования HTTP-запросов и API в FastAPI с использованием `pytest` и `TestClient`. 

В следующих разделах руководства мы рассмотрим более продвинутые техники тестирования, такие как:

*   Работа с базами данных в тестах
*   Мокинг внешних зависимостей
*   Написание интеграционных тестов
*   Использование фикстур `pytest` для организации тестового окружения

Освоив эти техники, вы сможете писать надежные и maintainable тесты для ваших FastAPI приложений, гарантируя их качество и стабильность.

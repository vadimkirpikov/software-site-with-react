## Внедрение зависимостей в FastAPI

Внедрение зависимостей (Dependency Injection, DI) – это мощный паттерн проектирования, который позволяет создавать более гибкие, тестируемые и легко поддерживаемые приложения. FastAPI предоставляет встроенную поддержку DI, что делает его использование простым и интуитивно понятным.

### Основы внедрения зависимостей

Вместо того чтобы создавать и управлять зависимостями внутри функций обработчиков запросов, DI позволяет нам объявить их как параметры функций. FastAPI автоматически разрешает эти зависимости и передает их в функции. 

**Преимущества использования DI:**

* **Повышение тестируемости:** Код становится более модульным, и зависимости можно легко подменять моками для тестирования.
* **Улучшение читаемости кода:**  Логика работы с зависимостями выносится из обработчиков, делая их более чистыми и понятными.
* **Упрощение повторного использования кода:** Зависимости можно легко использовать в различных частях приложения.

### Создание зависимостей

Зависимости в FastAPI определяются как функции, декорированные `@app.dependency` или `@router.dependency`. Эти функции могут принимать параметры, как и обычные функции, и возвращать любой объект Python.

**Пример:**

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
async def read_root():
    return {"message": "Hello World"}

@app.dependency
def get_database_connection():
    # Логика подключения к базе данных
    connection = "Подключение к базе данных"
    return connection

@app.get("/items/")
async def read_items(db: str = Depends(get_database_connection)):
    return {"items": ["Item 1", "Item 2"], "db": db}
```

В данном примере функция `get_database_connection` является зависимостью. Она имитирует подключение к базе данных и возвращает строку "Подключение к базе данных". Функция обработчика `read_items` объявляет зависимость от `get_database_connection` через `Depends(get_database_connection)`. FastAPI автоматически вызывает `get_database_connection`, получает возвращаемое значение и передает его в `read_items` как аргумент `db`. 

### Типы зависимостей

FastAPI поддерживает различные типы зависимостей:

**1. Простые зависимости:**

* Возвращают один объект.
* Определяются с помощью `@app.dependency` или `@router.dependency`.

**2. Зависимости с параметрами:**

* Принимают параметры из запроса (пути, строки запроса, тела).
* Используют классы параметров FastAPI (например, `Path`, `Query`, `Body`).

**Пример:**

```python
from fastapi import FastAPI, Path

app = FastAPI()

@app.dependency
def get_item_id(item_id: int = Path(...)):
    return item_id

@app.get("/items/{item_id}")
async def read_item(item_id: int = Depends(get_item_id)):
    return {"item_id": item_id}
```

В этом примере `get_item_id` получает параметр `item_id` из пути запроса и возвращает его.

**3. Асинхронные зависимости:**

* Используют ключевое слово `async` и возвращают awaitable объект.

**Пример:**

```python
from fastapi import FastAPI

app = FastAPI()

async def get_async_data():
    # Логика получения данных асинхронно
    data = await some_async_operation()
    return data

@app.get("/async")
async def read_async_data(data: dict = Depends(get_async_data)):
    return {"data": data}
```

Функция `get_async_data` симулирует асинхронное получение данных и возвращает их. Функция `read_async_data` объявляет зависимость от `get_async_data` и использует `await` для получения результата.

### Области видимости зависимостей

Зависимости могут быть определены на уровне приложения (`@app.dependency`) или роутера (`@router.dependency`). 

* **Зависимости уровня приложения** доступны для всех роутеров и их обработчиков. 
* **Зависимости уровня роутера** доступны только для обработчиков внутри этого роутера.

### Заключение

Внедрение зависимостей – это неотъемлемая часть разработки на FastAPI, которая помогает создавать чистый, тестируемый и поддерживаемый код. Используйте DI для управления зависимостями, повышения гибкости и улучшения структуры вашего приложения. 

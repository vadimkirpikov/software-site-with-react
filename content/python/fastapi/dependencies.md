## Зависимости в FastAPI

Зависимости в FastAPI - это функции, которые внедряются в ваши обработчики маршрутов. Они предоставляют способ повторного использования кода и добавления функциональности, такой как:

- Получение данных из базы данных
- Проверка авторизации пользователя
- Валидация данных
- Логирование

### Основы

Определение зависимости так же просто, как создание функции Python и декорирование ее с помощью `@app.dependency()`:

```python
from fastapi import FastAPI

app = FastAPI()

@app.dependency()
def get_database_connection():
    # Логика подключения к базе данных
    return connection
```

Чтобы использовать зависимость, просто укажите ее в качестве параметра обработчика маршрута:

```python
@app.get("/items/")
def get_items(connection=Depends(get_database_connection)):
    # Использование подключения к базе данных
    items = connection.execute("SELECT * FROM items")
    return items
```

FastAPI автоматически распознает зависимость и внедряет ее при каждом вызове маршрута `/items/`.

### Типы зависимостей

FastAPI поддерживает несколько типов зависимостей:

| Тип | Описание |
|---|---|
| Функции | Самый простой тип, просто функция, декорированная `@app.dependency()` |
| Классы | Могут быть использованы для более сложной логики и хранения состояния |
| Генераторы | Позволяют выполнять асинхронные операции |

### Пример: проверка авторизации

Давайте рассмотрим пример проверки JWT-токена для авторизации пользователя:

```python
from fastapi import FastAPI, Depends, HTTPException
from fastapi.security import OAuth2PasswordBearer

app = FastAPI()

oauth2_scheme = OAuth2PasswordBearer("/token")

@app.dependency()
def get_current_user(token: str = Depends(oauth2_scheme)):
    # Проверка токена
    user = verify_token(token)
    if not user:
        raise HTTPException(status_code=401, detail="Invalid token")
    return user

@app.get("/users/me")
def get_current_user_data(current_user: User = Depends(get_current_user)):
    return {"username": current_user.username, "email": current_user.email}
```

В этом примере:

1. `oauth2_scheme` определяет схему аутентификации OAuth2.
2. Зависимость `get_current_user` извлекает токен из заголовков запроса, проверяет его и возвращает данные пользователя.
3. Маршрут `/users/me` зависит от `get_current_user` и использует данные авторизованного пользователя.

### Преимущества использования зависимостей

- **Повторное использование кода:**  Избегайте дублирования кода, вынося общую логику в зависимости.
- **Улучшенная читаемость:**  Код становится чище и понятнее, так как обработчики маршрутов сосредоточены на своей основной логике.
- **Простое тестирование:**  Зависимости можно легко тестировать независимо от обработчиков маршрутов.
- **Расширяемость:**  Легко добавлять новые функции и middleware, не изменяя существующий код.

### Заключение

Использование зависимостей в FastAPI - это мощный способ писать чистый, многоразовый и легко поддерживаемый код. Понимание того, как определять и использовать зависимости, является важным шагом к созданию эффективных и масштабируемых API с помощью FastAPI. 

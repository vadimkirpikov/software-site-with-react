## Модульное тестирование FastAPI-приложения с помощью pytest

Модульное тестирование — это неотъемлемая часть разработки программного обеспечения, позволяющая проверить корректность работы отдельных компонентов приложения. В контексте FastAPI, модульные тесты помогают убедиться, что ваши обработчики запросов, функции валидации и другая бизнес-логика работают должным образом.

Pytest — это популярный фреймворк для написания тестов на Python. Он прост в использовании, гибок в настройке и обладает широкими возможностями, что делает его отличным выбором для тестирования FastAPI-приложений.

### Настройка тестовой среды

1. **Установка необходимых пакетов:**
    ```bash
    pip install pytest pytest-asyncio fastapi uvicorn
    ```

    - `pytest`: основной фреймворк для тестирования.
    - `pytest-asyncio`: плагин pytest для асинхронных тестов.
    - `fastapi`: фреймворк для создания API.
    - `uvicorn`: ASGI-сервер для запуска FastAPI-приложения.

2. **Создание тестового клиента:**

    Для взаимодействия с FastAPI-приложением во время тестов, нам понадобится тестовый клиент. FastAPI предоставляет встроенный клиент `TestClient`.

    ```python
    from fastapi.testclient import TestClient
    from your_app import app  # Импортируйте ваше FastAPI-приложение

    @pytest.fixture
    def client():
        with TestClient(app) as client:
            yield client
    ```

    Этот код создает фикстуру `client`, которая будет использоваться в наших тестах. Фикстура — это функция, которая выполняется перед каждым тестом и предоставляет доступ к определенным ресурсам. В данном случае фикстура создает экземпляр `TestClient` для вашего приложения и передает его в тестовые функции.

### Пример теста

Рассмотрим простой пример FastAPI-приложения:

```python
    from fastapi import FastAPI

    app = FastAPI()

    @app.get("/")
    async def root():
        return {"message": "Hello World"}
```

Напишем тест для проверки работоспособности обработчика запроса `root`:

```python
    from fastapi.testclient import TestClient
    from your_app import app 

    @pytest.fixture
    def client():
        with TestClient(app) as client:
            yield client
    
    def test_read_root(client: TestClient):
        response = client.get("/")
        assert response.status_code == 200
        assert response.json() == {"message": "Hello World"}
```

В этом тесте:

- Мы используем фикстуру `client`, чтобы получить доступ к тестовому клиенту.
- Выполняем GET-запрос к корневому пути "/" с помощью `client.get("/")`.
- Проверяем, что код ответа равен 200 (OK), используя `assert response.status_code == 200`.
- Проверяем, что тело ответа соответствует ожидаемому JSON, используя `assert response.json() == {"message": "Hello World"}`.

### Запуск тестов

Запустить тесты можно с помощью команды:

```bash
pytest
```

Pytest автоматически обнаружит тестовые функции (начинающиеся с `test_`) и выполнит их.

### Тестирование асинхронных функций

FastAPI активно использует асинхронность. Для тестирования асинхронных обработчиков запросов, используйте `pytest.mark.asyncio`:

```python
    @pytest.mark.asyncio
    async def test_async_route(client: TestClient):
        response = await client.get("/async") # обратите внимание на await
        assert response.status_code == 200
```

### Дополнительные возможности pytest

Pytest предоставляет множество других полезных функций:

- **Фикстуры для настройки базы данных, тестовых данных и других ресурсов.**
- **Параметризация для запуска одного теста с разными наборами данных.**
- **Моки для изоляции зависимостей и проверки взаимодействия с ними.**

### Заключение

Модульное тестирование с использованием pytest — это важная практика, которая поможет вам создавать надежные и легко поддерживаемые FastAPI-приложения. 

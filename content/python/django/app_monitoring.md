## Мониторинг приложений Django: Sentry и Prometheus

Мониторинг является неотъемлемой частью жизненного цикла любого приложения, особенно в production-среде. Он позволяет вовремя обнаруживать и устранять проблемы, повышая надежность и доступность вашего приложения. В этой статье мы рассмотрим два популярных инструмента мониторинга: Sentry для отслеживания ошибок и Prometheus для сбора и визуализации метрик.

### Sentry: Отслеживание ошибок и исключений

Sentry – это платформа для отслеживания ошибок в режиме реального времени, которая помогает находить и исправлять ошибки быстро и эффективно. Интеграция Sentry в ваше приложение Django позволит вам:

* Автоматически фиксировать исключения и ошибки.
* Получать уведомления о критических ошибках.
* Анализировать контекст возникновения ошибок, включая стек вызовов, данные пользователя и другую важную информацию.

**Шаг 1: Установка и настройка Sentry**

1. Создайте бесплатный аккаунт на сайте Sentry: [https://sentry.io/](https://sentry.io/)
2. Создайте новый проект для вашего Django приложения.
3. Установите необходимые пакеты Python:

```bash
pip install sentry-sdk
```

4. Добавьте настройки Sentry в ваш файл `settings.py`:

```python
import sentry_sdk
from sentry_sdk.integrations.django import DjangoIntegration

sentry_sdk.init(
    dsn="YOUR_SENTRY_DSN",  # Замените на DSN вашего проекта
    integrations=[DjangoIntegration()],
    traces_sample_rate=1.0,  # Отслеживать все запросы (по желанию)
)
```

**Шаг 2: Тестирование интеграции**

1. Создайте представление в вашем приложении Django, которое будет генерировать исключение:

```python
from django.shortcuts import render

def trigger_error(request):
    division_by_zero = 1 / 0
    return render(request, 'error.html')
```

2. Добавьте URL-адрес для этого представления в ваш файл `urls.py`:

```python
from django.urls import path
from . import views

urlpatterns = [
    path('trigger-error/', views.trigger_error, name='trigger_error'),
]
```

3. Запустите ваше приложение и перейдите по адресу `/trigger-error/`. Вы должны увидеть ошибку 500 в браузере.
4. Проверьте панель управления Sentry. Вы должны увидеть новую ошибку, зарегистрированную в вашем проекте.

**Дополнительные возможности Sentry:**

* Отслеживание производительности.
* Группировка похожих ошибок.
* Интеграция с различными сервисами, такими как Slack, Jira и GitHub.

### Prometheus: Сбор и визуализация метрик

Prometheus – это система мониторинга с открытым исходным кодом, которая собирает метрики с ваших приложений и предоставляет инструменты для их визуализации, анализа и оповещения.  

**Шаг 1: Установка и настройка Prometheus**

1. Скачайте и установите Prometheus с официального сайта: [https://prometheus.io/download/](https://prometheus.io/download/)
2. Запустите Prometheus и настройте его для сбора метрик с вашего Django приложения.

**Шаг 2: Экспортирование метрик из Django**

Для экспорта метрик из Django вам потребуется установить клиентскую библиотеку Prometheus:

```bash
pip install prometheus-client
```

Затем создайте файл `metrics.py` в вашем приложении Django и определите метрики, которые вы хотите отслеживать:

```python
from prometheus_client import Counter, Gauge

REQUEST_COUNT = Counter(
    'django_http_requests_total', 'Total number of HTTP requests',
    ['method', 'endpoint']
)
ACTIVE_USERS = Gauge(
    'django_active_users', 'Number of active users',
)
```

**Шаг 3: Инструментирование кода**

Добавьте код для обновления метрик в ваши представления или другие части кода, которые вы хотите отслеживать:

```python
from django.shortcuts import render
from .metrics import REQUEST_COUNT, ACTIVE_USERS

def my_view(request):
    REQUEST_COUNT.labels(request.method, request.path).inc()
    ACTIVE_USERS.inc()
    # ... ваш код ...
    ACTIVE_USERS.dec()
    return render(request, 'my_template.html')
```

**Шаг 4: Визуализация данных**

Prometheus предоставляет встроенный веб-интерфейс для визуализации метрик. Кроме того, вы можете использовать другие инструменты, такие как Grafana, для создания более сложных дашбордов.

**Дополнительные возможности Prometheus:**

* Настройка оповещений о превышении пороговых значений метрик.
* Использование PromQL для создания сложных запросов к метрикам.
* Интеграция с другими инструментами мониторинга и анализа данных.

### Завершение

В этой статье мы рассмотрели основы мониторинга приложений Django с помощью Sentry и Prometheus. Эти инструменты помогут вам повысить надежность и доступность вашего приложения, а также быстро реагировать на возникающие проблемы. Не забывайте изучать документацию Sentry и Prometheus, чтобы использовать их функциональность по максимуму. 

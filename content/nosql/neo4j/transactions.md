## Основы транзакций в Neo4j

Neo4j, как и большинство современных систем управления базами данных, предоставляет механизм транзакций для обеспечения целостности и согласованности данных. Транзакция в Neo4j - это логическая единица работы, которая состоит из последовательности операций, выполняемых над графом. 

Транзакции гарантируют, что все операции в рамках одной транзакции либо выполняются успешно, либо отменяются, если какая-либо из них завершается с ошибкой.  Это позволяет избежать несогласованных состояний данных и обеспечивает надежность операций.

### Типы транзакций

В Neo4j поддерживаются два основных типа транзакций:

1. **Автоматические транзакции**:  являются стандартным поведением Neo4j.  Каждая операция, выполняемая с помощью драйвера, автоматически выполняется в рамках транзакции. 
2. **Ручные транзакции**:  позволяют явно управлять началом и окончанием транзакции.  Это необходимо, если вы хотите группировать несколько операций в одну транзакцию, контролировать время ее жизни или иметь более гибкую обработку ошибок.

### Начало и завершение транзакций

**Автоматические транзакции**
  
   В Neo4j, по умолчанию, все операции выполняются в контексте автоматической транзакции.  Это означает, что вы не должны явно создавать транзакцию,  она создается автоматически при каждом соединении с базой данных.  Операции будут выполняться как атомарные действия.

**Ручные транзакции**

   Для управления ручными транзакциями в Neo4j используются следующие методы:

* **Начало транзакции:**
    ```python
    from neo4j import GraphDatabase

    driver = GraphDatabase.driver("bolt://localhost:7687", auth=("user", "password"))

    with driver.session() as session:
        transaction = session.begin_transaction() 
        # Операции, выполняемые в рамках транзакции
    ```

* **Завершение транзакции:**

    * **Успешное завершение:**

        ```python
        transaction.commit()  # Сохраняет все изменения в базе данных
        ```

    * **Отмена транзакции:**

        ```python
        transaction.rollback() # Отменяет все изменения в базе данных
        ```

### Атомарность и изоляция

Транзакции в Neo4j обладают свойствами атомарности (Atomicity), согласованности (Consistency), изоляции (Isolation) и долговечности (Durability), которые в совокупности известны как **ACID**-свойства.

* **Атомарность**: все операции внутри транзакции выполняются целиком или не выполняются вообще.  Если какая-либо операция в транзакции завершается с ошибкой, все предыдущие операции отменяются, а состояние базы данных остается неизменным.

* **Согласованность**: транзакции приводят базу данных из одного согласованного состояния в другое.  Транзакция гарантирует, что данные в базе данных всегда будут соответствовать установленным ограничениям и правилам.

* **Изоляция**: несколько транзакций выполняются независимо друг от друга.  Это означает, что операции, выполняемые в одной транзакции, не видны другим транзакциям, пока первая не будет завершена.  

* **Долговечность**:  изменения, внесенные в базу данных в рамках успешно завершенной транзакции, сохраняются постоянно, даже в случае сбоя системы.

### Примеры использования транзакций

**Пример 1: Создание нового узла и связи с существующим узлом в рамках одной транзакции**

```python
from neo4j import GraphDatabase

driver = GraphDatabase.driver("bolt://localhost:7687", auth=("user", "password"))

with driver.session() as session:
    with session.begin_transaction() as tx:
        # Создаем новый узел "Movie" 
        tx.run("CREATE (m:Movie {title: 'The Matrix'})")

        # Находим существующий узел "Person"
        result = tx.run("MATCH (p:Person {name: 'Keanu Reeves'}) RETURN p")
        person = result.single()

        # Создаем связь между узлами
        tx.run("MATCH (m:Movie {title: 'The Matrix'}), (p:Person {name: 'Keanu Reeves'}) CREATE (p)-[:ACTED_IN]->(m)")

    tx.commit() # Завершаем транзакцию
```

**Пример 2: Обновление данных в рамках транзакции**

```python
from neo4j import GraphDatabase

driver = GraphDatabase.driver("bolt://localhost:7687", auth=("user", "password"))

with driver.session() as session:
    with session.begin_transaction() as tx:
        # Обновляем название фильма
        tx.run("MATCH (m:Movie {title: 'The Matrix'}) SET m.title = 'The Matrix Reloaded'")
        
        # Обновляем рейтинг фильма
        tx.run("MATCH (m:Movie {title: 'The Matrix Reloaded'}) SET m.rating = 8.5") 
        
    tx.commit() # Завершаем транзакцию
```

### Резюме

Транзакции в Neo4j являются основой для обеспечения целостности и согласованности данных в графовой базе данных.  Они обеспечивают атомарность, согласованность, изоляцию и долговечность операций, гарантируя надежность и точность операций с графом.  Правильное использование транзакций в Neo4j является ключевым фактором для успешной работы с графовыми данными.

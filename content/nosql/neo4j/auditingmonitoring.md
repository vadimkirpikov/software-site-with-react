## Аудит и Мониторинг Neo4j

В этом разделе мы рассмотрим механизмы аудита и мониторинга в Neo4j, позволяющие отслеживать и контролировать работоспособность и использование вашей базы данных. 

**Аудит**

Аудит Neo4j предоставляет механизмы для отслеживания изменений в базе данных. Вы можете записать все операции, такие как создание, обновление и удаление узлов, ребер, свойств и т.д. Эти записи хранятся в специальных файлах аудита, предоставляя вам детальную информацию о событиях в базе данных.

**Включение аудита:**

1. **Настройка конфигурационного файла:** 
    В файле `neo4j.conf` найдите раздел `dbms.audit.enabled`, установите значение `true` для включения аудита.
    ```
    dbms.audit.enabled=true
    ```

2. **Указание настроек аудита:**
    Вы можете настроить следующие параметры в файле `neo4j.conf`:
    - `dbms.audit.log.file`: путь к файлу, в котором будут храниться записи аудита.
    - `dbms.audit.log.rotation.interval.seconds`: интервал в секундах для вращения файлов аудита.
    - `dbms.audit.log.rotation.max.files`: максимальное количество файлов аудита, которые будут храниться.

**Пример конфигурации:**

```
dbms.audit.enabled=true
dbms.audit.log.file=/var/log/neo4j/audit.log
dbms.audit.log.rotation.interval.seconds=3600
dbms.audit.log.rotation.max.files=5
```

**Интерпретация записей аудита:**

Записи аудита содержат информацию о дате и времени события, типе события, имени пользователя, выполняющего операцию, и других деталях. 

**Пример записи аудита:**

```
2023-10-27T12:00:00.000Z INFO  [audit] User 'admin' created node with id 1234.
2023-10-27T12:01:00.000Z INFO  [audit] User 'admin' deleted relationship with id 5678.
```

**Мониторинг**

Neo4j предоставляет инструменты для мониторинга различных аспектов базы данных, таких как:

- **Использование ресурсов:** мониторинг CPU, памяти, дискового пространства.
- **Производительность запросов:** отслеживание времени выполнения запросов, количества выполненных операций.
- **Статус сервера:** проверка доступности, состояния сервисов.

**Инструменты мониторинга:**

**1. Neo4j Browser:** 
   - Предоставляет базовый мониторинг основных показателей, доступный через веб-интерфейс.
   - Позволяет отслеживать использование CPU, памяти, дискового пространства, а также общее количество узлов и ребер в базе данных.

**2. Neo4j REST API:** 
   - Предоставляет доступ к более подробной информации о производительности запросов, ошибках и других показателях.
   - Позволяет программно получать данные мониторинга для автоматизации процесса.

**3. Neo4j APOC library:** 
   - Предоставляет набор процедур, которые могут быть использованы для мониторинга базы данных.
   - Например, вы можете использовать процедуры `apoc.monitor.currentMemoryUsage` и `apoc.monitor.currentCpuUsage` для получения данных о текущем использовании памяти и CPU.

**4. Профилирование запросов:**
   - Neo4j предоставляет возможность профилирования запросов для выявления узких мест и оптимизации производительности.
   - Для включения профилирования запросов добавьте параметр `PROFILE` в конец вашего запроса:
     ```cypher
     MATCH (n:Person)
     RETURN n
     PROFILE; 
     ```

**Пример использования REST API:**

```python
import requests

url = 'http://localhost:7474/db/data/transaction/1/commit'
headers = {'Accept': 'application/json', 'Content-Type': 'application/json'}
data = {
  "statements": [
    {
      "statement": "MATCH (n:Person) RETURN n",
      "resultDataContents": ["graph"],
      "includeStats": True
    }
  ]
}

response = requests.post(url, headers=headers, json=data)

# Обработка данных из ответа
print(response.json())
```

**Пример использования APOC library:**

```cypher
CALL apoc.monitor.currentMemoryUsage() YIELD usedMemory, maxMemory, totalMemory
RETURN usedMemory, maxMemory, totalMemory;
```

**Заключение:**

Аудит и мониторинг являются важными инструментами для управления и оптимизации базы данных Neo4j. Используя описанные механизмы, вы можете отслеживать изменения в базе данных, анализировать производительность запросов и выявлять потенциальные проблемы. 

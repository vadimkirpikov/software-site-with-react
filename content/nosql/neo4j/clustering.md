## Настройка кластера Neo4j

В предыдущих разделах мы рассмотрели основы работы с Neo4j в одноузловой конфигурации. Однако для обработки больших объемов данных и обеспечения высокой доступности требуется более сложная архитектура - кластер. 

Кластер Neo4j - это группа взаимосвязанных серверов, работающих вместе для обеспечения единого хранилища данных. Данные реплицируются между узлами, что обеспечивает отказоустойчивость. 

В данной статье мы рассмотрим настройку и управление кластером Neo4j версии 5.6.0.

### 1. Подготовка инфраструктуры

Для начала необходимо подготовить серверы, которые будут участвовать в кластере. 

**Требования к серверам:**

* **Операционная система:** Linux или macOS
* **Java:**  Версия 11 или выше
* **Neo4j:** Версия 5.6.0 или выше
* **Сеть:**  Все узлы должны иметь возможность общаться друг с другом по сети.

**Рекомендации:**

* **Процессор:**  Рекомендуется использовать серверы с достаточным количеством ядер процессора для обработки запросов.
* **Память:**  Большой объем оперативной памяти необходим для хранения данных в оперативной памяти и обеспечения высокой производительности.
* **Хранилище:**  Рекомендуется использовать быстрое хранилище с достаточным объемом для хранения данных.

### 2. Настройка узлов

**2.1. Установка Neo4j**

На каждом сервере необходимо установить Neo4j.  Процесс установки описан в документации Neo4j.

**2.2. Конфигурация кластера**

В директории `conf` необходимо создать файл `neo4j.conf`, который содержит настройки кластера.  

```
# Конфигурация кластера
dbms.cluster.enabled=true
dbms.cluster.addresses=localhost:5000,host2:5000,host3:5000
dbms.cluster.server_id=1 # Уникальный ID для каждого узла

# Конфигурация репликации
dbms.replication.role=FOLLOWER # Роль узла - follower
dbms.replication.master=host1:5000 # Адрес узла-мастера

# Параметры подключения
dbms.connector.bolt.advertised_address=localhost:7687
dbms.connector.bolt.enabled=true

# Параметры безопасности
dbms.security.auth_enabled=true
dbms.security.auth_provider=org.neo4j.server.security.auth.DatabaseAuth

# Параметры логирования
dbms.logs.file.path=/var/log/neo4j
```

**Описание параметров:**

* `dbms.cluster.enabled`: Включить режим кластера (true).
* `dbms.cluster.addresses`: Список адресов всех узлов кластера.
* `dbms.cluster.server_id`: Уникальный идентификатор узла в кластере.
* `dbms.replication.role`: Роль узла (FOLLOWER - подчиненный, LEADER - ведущий).
* `dbms.replication.master`:  Адрес узла-мастера для подчиненных узлов.
* `dbms.connector.bolt.advertised_address`:  Адрес узла для внешних подключений.
* `dbms.connector.bolt.enabled`:  Включить Bolt-соединение (true).
* `dbms.security.auth_enabled`: Включить аутентификацию (true).
* `dbms.security.auth_provider`: Провайдер аутентификации (в данном случае, аутентификация через базу данных).
* `dbms.logs.file.path`: Путь к файлам журналов.

**2.3. Запуск Neo4j**

Запустите Neo4j на каждом сервере.

### 3. Создание кластера

**3.1. Выбор ведущего узла**

Первый запущенный узел в кластере автоматически становится ведущим (LEADER).

**3.2. Подключение подчиненных узлов**

Подчиненные узлы должны подключиться к ведущему узлу. После запуска подчиненного узла, он автоматически присоединится к кластеру и начнет синхронизацию данных.

**3.3. Проверка состояния кластера**

Используйте оболочку Neo4j для проверки состояния кластера. 

```
:cluster status
```

**3.4. Перенос ведущего узла**

Ведущего узла можно перенести на другой сервер. 

```
:cluster leader node=<node_id>
```

### 4.  Управление кластером

**4.1.  Добавление узлов**

Для добавления нового узла в кластер необходимо:

1.  Установить Neo4j на новом сервере.
2.  Настроить файл `neo4j.conf`  нового узла, указав адреса всех узлов кластера и назначив ему роль FOLLOWER.
3.  Запустить Neo4j на новом сервере.

**4.2.  Удаление узлов**

Для удаления узла из кластера необходимо:

1.  Остановить Neo4j на удаляемом узле.
2.  Удалить каталог данных Neo4j.
3.  Обновить файл `neo4j.conf`  на остальных узлах кластера, удалив адрес удаляемого узла из списка `dbms.cluster.addresses`.

**4.3.  Мониторинг кластера**

Для мониторинга кластера можно использовать различные инструменты, такие как:

*   **Neo4j Browser:**  Встроенный браузер Neo4j позволяет просматривать состояние кластера.
*   **Neo4j Server Admin API:**  Предоставляет доступ к данным о состоянии кластера через REST API.
*   **Grafana:**  Позволяет создавать информационные панели для мониторинга кластера.

**4.4.  Безопасность**

Кластеры Neo4j обычно используют аутентификацию для доступа к данным.  Можно настроить различные механизмы аутентификации, такие как:

*   **Аутентификация на основе базы данных**
*   **LDAP-аутентификация**
*   **Самостоятельная аутентификация**

### 5.  Примеры кода

**5.1.  Создание графа в кластере**

```
// Подключение к кластеру через Bolt
CALL dbms.cluster.routing.getServers() YIELD addresses, role
RETURN addresses, role;

// Создание узла
CREATE (p:Person {name: 'Alice'})
CREATE (m:Movie {title: 'The Matrix'})
CREATE (p)-[:ACTED_IN]->(m);
```

**5.2.  Запросы к кластеру**

```
// Выполнить запрос к кластеру
CALL dbms.cluster.routing.getServers() YIELD addresses, role
RETURN addresses, role;

// Выполнить запрос к конкретному узлу
CALL dbms.cluster.routing.getServerByRole('LEADER') YIELD addresses
RETURN addresses;

// Выполнить запрос к узлу с конкретным идентификатором
CALL dbms.cluster.routing.getServerById(1) YIELD addresses
RETURN addresses;
```

### 6.  Заключение

Настройка кластера Neo4j -  это сложный процесс, требующий  определенных знаний и навыков.  В данной статье мы рассмотрели основные этапы настройки и управления кластером.  Важно помнить, что кластеры Neo4j -  это комплексная система, требующая  тщательной настройки и мониторинга для обеспечения высокой доступности и производительности. 

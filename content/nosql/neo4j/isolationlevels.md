## Уровни изоляции транзакций

В Neo4j, как и в большинстве систем управления базами данных (СУБД), транзакции используются для обеспечения атомарности, согласованности, изоляции и долговечности (ACID) операций с данными. Уровни изоляции транзакций определяют, как транзакции взаимодействуют друг с другом, и какие данные каждая из них может видеть во время выполнения.

### Понятие изоляции

Изоляция транзакций гарантирует, что одна транзакция не видит незавершенных изменений, внесенных другими транзакциями.  Другими словами, транзакции выполняются так, как будто они выполняются одна за другой, даже если они выполняются одновременно. 

### Уровни изоляции в Neo4j

Neo4j поддерживает следующие уровни изоляции транзакций, определяемые в соответствии с стандартом SQL:

| Уровень изоляции | Описание |
|---|---|
| `READ_UNCOMMITTED` | Самый низкий уровень изоляции. Транзакция может видеть незавершенные изменения, внесенные другими транзакциями (даже несохраненные).  **Не рекомендуется использовать**. |
| `READ_COMMITTED` |  Транзакция видит только подтвержденные изменения, внесенные другими транзакциями. Данные, которые были изменены, но еще не зафиксированы, не видны.  |
| `REPEATABLE_READ` | Транзакция видит те же данные, которые она видела в начале транзакции, даже если другие транзакции внесли изменения. |
| `SERIALIZABLE` |  Самый высокий уровень изоляции.  Транзакции выполняются последовательно, как будто они были запущены одна за другой.  **Рекомендованный уровень для большинства приложений**. |

### Практическое использование

#### `READ_COMMITTED`

При использовании уровня изоляции `READ_COMMITTED`  транзакция может видеть только подтвержденные изменения, внесенные другими транзакциями.  

**Пример:**

```cypher
// Транзакция 1
CREATE (p:Person { name: 'Alice' });
RETURN p; // Вернет узел с именем "Alice"

// Транзакция 2
MATCH (p:Person { name: 'Alice' })
SET p.age = 30;
// ... еще операции ...
COMMIT; 

// Транзакция 1
// ... другие операции ...
MATCH (p:Person { name: 'Alice' })
RETURN p.age; // Вернет NULL, так как изменение возраста не подтверждено
```

#### `REPEATABLE_READ`

При использовании уровня изоляции `REPEATABLE_READ`  транзакция видит те же данные, которые она видела в начале транзакции, даже если другие транзакции внесли изменения.

**Пример:**

```cypher
// Транзакция 1
MATCH (p:Person { name: 'Bob' })
RETURN p.age; // Вернет, например, 25

// Транзакция 2
MATCH (p:Person { name: 'Bob' })
SET p.age = 35;
COMMIT;

// Транзакция 1
// ... другие операции ...
MATCH (p:Person { name: 'Bob' })
RETURN p.age; // Вернет 25, так как транзакция "запомнила" значение в начале
```

#### `SERIALIZABLE`

При использовании уровня изоляции `SERIALIZABLE` транзакции выполняются последовательно, как будто они были запущены одна за другой.

**Пример:**

```cypher
// Транзакция 1
CREATE (p:Person { name: 'Charlie' });
RETURN p; // Вернет узел с именем "Charlie"

// Транзакция 2
MATCH (p:Person { name: 'Charlie' })
CREATE (p)-[:KNOWS]->(f:Person { name: 'David' });
COMMIT;

// Транзакция 1
// ... другие операции ...
MATCH (p:Person { name: 'Charlie' })-[:KNOWS]->(f)
RETURN f.name; // Вернет "David", так как транзакция 2 "выполнилась" раньше 
```

### Выбор уровня изоляции

Выбор уровня изоляции зависит от требований к  приложению:

* `READ_COMMITTED`  подходит для приложений, где не требуется точная изоляция, и где  приемлемо, чтобы транзакция видела только подтвержденные изменения.
* `REPEATABLE_READ` подходит для приложений, где требуется, чтобы транзакция видела одни и те же данные во время выполнения.
* `SERIALIZABLE`  подходит для приложений, где требуется  самый высокий уровень изоляции, например, для финансовых операций.

### Изменение уровня изоляции

По умолчанию уровень изоляции транзакций в Neo4j равен `READ_COMMITTED`.  Изменить уровень изоляции можно с помощью директивы `USING`  в Cypher:

```cypher
// Установка уровня изоляции на `REPEATABLE_READ`
USING READ_UNCOMMITTED
MATCH (p:Person { name: 'Alice' })
RETURN p;

// Установка уровня изоляции на `SERIALIZABLE`
USING SERIALIZABLE
MATCH (p:Person { name: 'Bob' })
RETURN p.age; 
```

**Важно:** Уровень изоляции `READ_UNCOMMITTED`  может привести к непредсказуемым результатам, поэтому его следует использовать с осторожностью.

### Заключение

Уровни изоляции транзакций играют важную роль в обеспечении корректности и надежности операций с данными в Neo4j.  Правильный выбор уровня изоляции зависит от требований к конкретному приложению.

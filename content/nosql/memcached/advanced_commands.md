## Расширенные команды и функции Memcached

В предыдущих разделах мы познакомились с основными функциями Memcached, такими как добавление, получение и удаление данных. В этой статье мы рассмотрим более продвинутые команды и функции, которые могут быть полезны при работе с Memcached.

### Команды управления состоянием сервера

Memcached предоставляет набор команд для управления состоянием сервера, таких как получение информации о версии, статистике и использовании памяти.

#### `stats`

Команда `stats` возвращает различные статистические данные о сервере Memcached.

**Пример использования:**

```
$ telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
stats
STAT pid 12345
STAT uptime 10000
STAT time 1677679200
STAT version 1.6.20
...
```

**Выводимые данные:**

* **pid:** Идентификатор процесса Memcached.
* **uptime:** Время работы сервера в секундах.
* **time:** Текущее время в секундах с начала эпохи Unix.
* **version:** Версия Memcached.
* **curr_connections:** Текущее количество подключений к серверу.
* **total_connections:** Общее количество подключений за время работы сервера.
* **connection_structures:** Количество выделенной памяти для хранения информации о подключениях.
* **cmd_get:** Количество команд `get`.
* **cmd_set:** Количество команд `set`.
* **cmd_flush:** Количество команд `flush_all`.
* **get_hits:** Количество успешных операций `get`.
* **get_misses:** Количество неудачных операций `get`.
* **delete_misses:** Количество неудачных операций `delete`.
* **evictions:** Количество удалений элементов из кэша из-за нехватки памяти.
* **rusage_user:** Время процессора, затраченное на выполнение пользовательского кода.
* **rusage_system:** Время процессора, затраченное на выполнение системного кода.
* **mem_allocated:** Общее количество выделенной памяти.
* **objects:** Количество хранимых элементов.
* **limit_maxbytes:** Максимальное количество памяти, которое может быть выделено для кэша.
* **accepting_conns:** Указывает, принимает ли сервер новые подключения.

#### `stats slabs`

Команда `stats slabs` выводит информацию о каждом Slab классе, который используется в Memcached для хранения данных.

**Пример использования:**

```
$ telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
stats slabs
STAT slabs 16
STAT slab_0:chunk_size 48
STAT slab_0:chunks 256
STAT slab_0:total_chunks 256
STAT slab_0:used_chunks 0
STAT slab_0:free_chunks 256
STAT slab_1:chunk_size 96
STAT slab_1:chunks 256
STAT slab_1:total_chunks 256
STAT slab_1:used_chunks 0
STAT slab_1:free_chunks 256
...
```

**Выводимые данные:**

* **slabs:** Общее количество Slab классов.
* **slab_X:chunk_size:** Размер куска (chunk) в байтах для данного Slab класса.
* **slab_X:chunks:** Количество кусков в данном Slab классе.
* **slab_X:total_chunks:** Общее количество кусков, выделенных для данного Slab класса.
* **slab_X:used_chunks:** Количество используемых кусков в данном Slab классе.
* **slab_X:free_chunks:** Количество свободных кусков в данном Slab классе.

#### `stats cachedump`

Команда `stats cachedump` позволяет получить список элементов, хранящихся в кэше Memcached.

**Пример использования:**

```
$ telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
stats cachedump 1 0
ITEM key1 0 10 1 1677679200 1 0
VALUE key1 0 8
key1_value
END
```

**Выводимые данные:**

* **ITEM key1 0 10 1 1677679200 1 0:** Информация об элементе. 
    * **key1:** Имя ключа.
    * **0:** Флаг элемента.
    * **10:** Размер элемента в байтах.
    * **1:** Время жизни элемента в секундах.
    * **1677679200:** Время последнего изменения элемента.
    * **1:** Количество обращений к элементу.
    * **0:** Признак удаления элемента (0 - не удален, 1 - удален).
* **VALUE key1 0 8:** Данные элемента.
    * **key1:** Имя ключа.
    * **0:** Флаг элемента.
    * **8:** Размер данных элемента.
* **key1_value:** Значение элемента.
* **END:** Конец вывода.

### Команды управления элементами кэша

#### `flush_all`

Команда `flush_all` очищает все элементы кэша.

**Пример использования:**

```
$ telnet localhost 11211
Trying 127.0.0.1...
Connected to localhost.
Escape character is '^]'.
flush_all
OK
```

#### `append`

Команда `append` добавляет данные в конец существующего элемента кэша.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Добавление элемента в кэш
mc.set('mykey', 'Hello')

# Добавление данных в конец элемента
mc.append('mykey', ' world!')

# Получение значения элемента
value = mc.get('mykey')
print(value) # Вывод: Hello world!
```

#### `prepend`

Команда `prepend` добавляет данные в начало существующего элемента кэша.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Добавление элемента в кэш
mc.set('mykey', 'world!')

# Добавление данных в начало элемента
mc.prepend('mykey', 'Hello ')

# Получение значения элемента
value = mc.get('mykey')
print(value) # Вывод: Hello world!
```

### Команды работы с ключами

#### `cas`

Команда `cas` позволяет обновить элемент кэша только в том случае, если его значение не было изменено с момента последнего получения.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Добавление элемента в кэш
mc.set('mykey', 'Hello')

# Получение значения элемента и CAS-токен
value, cas = mc.gets('mykey')

# Обновление элемента с помощью CAS-токен
mc.cas('mykey', 'Hello world!', cas)

# Попытка обновления элемента с устаревшим CAS-токен
mc.cas('mykey', 'Hello again!', cas) # Не удастся, т.к. CAS-токен устарел

# Получение значения элемента
value = mc.get('mykey')
print(value) # Вывод: Hello world!
```

#### `incr` и `decr`

Команды `incr` и `decr` позволяют инкрементировать или декрементировать значение элемента кэша.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Добавление элемента в кэш
mc.set('counter', 0)

# Инкремент значения элемента
mc.incr('counter')
print(mc.get('counter')) # Вывод: 1

# Декремент значения элемента
mc.decr('counter')
print(mc.get('counter')) # Вывод: 0
```

### Команды удаления

#### `delete`

Команда `delete` удаляет элемент из кэша.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Добавление элемента в кэш
mc.set('mykey', 'Hello')

# Удаление элемента из кэша
mc.delete('mykey')

# Попытка получения значения удаленного элемента
value = mc.get('mykey')
print(value) # Вывод: None
```

### Команды  `add` и `replace`

#### `add`

Команда `add` позволяет добавить элемент в кэш только в том случае, если он ещё не существует.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Попытка добавления элемента, который уже существует
mc.add('mykey', 'Hello') # Не удастся

# Попытка добавления нового элемента
mc.add('new_key', 'World') # Успешно
```

#### `replace`

Команда `replace` позволяет обновить элемент кэша только в том случае, если он уже существует.

**Пример использования:**

```python
import memcache

# Создание подключения к серверу Memcached
mc = memcache.Client(['127.0.0.1:11211'])

# Попытка обновления элемента, который не существует
mc.replace('mykey', 'Hello') # Не удастся

# Обновление элемента, который существует
mc.replace('new_key', 'New world!') # Успешно
```

### Заключение

В этой статье мы рассмотрели более продвинутые команды и функции Memcached. Использование этих команд позволит вам оптимизировать работу с кэшем и повысить производительность вашего приложения. В следующих разделах мы рассмотрим дополнительные возможности Memcached, такие как конфигурирование, мониторинг и безопасность.

<h2>Работа с вложенными документами</h2>

MongoDB позволяет хранить данные в гибкой, похожей на JSON структуре.  Это означает, что документ может содержать в себе другие документы, образуя иерархическую структуру данных. Такие документы называются **вложенными документами**. 

Вложенные документы предоставляют несколько преимуществ:

* **Естественное моделирование отношений:**  Вложенные документы позволяют моделировать отношения "один-ко-многим" непосредственно в документе, не прибегая к сложным схемам нормализации, как в реляционных базах данных.
* **Атомарность операций:** Обновления вложенных документов происходят атомарно, что гарантирует целостность данных.
* **Улучшение производительности:** Загрузка связанных данных в одном запросе может значительно повысить производительность по сравнению с несколькими запросами к разным таблицам.

### Создание документа с вложенными документами

Для создания документа с вложенным документом достаточно просто указать вложенный JSON-объект:

```javascript
db.users.insertOne({
  name: "Иван",
  age: 30,
  address: { // Вложенный документ для адреса
    street: "ул. Ленина",
    city: "Москва",
    zip: "123456"
  }
})
```

В этом примере мы создали документ "user" с вложенным документом "address".

### Доступ к данным во вложенных документах

Для доступа к данным во вложенных документах используется точечная нотация:

```javascript
// Найти пользователя по имени и получить его город
db.users.findOne({ name: "Иван" }).address.city 
```

### Запросы к вложенным документам

MongoDB позволяет выполнять запросы к полям внутри вложенных документов:

```javascript
// Найти всех пользователей из Москвы
db.users.find({ "address.city": "Москва" })
```

### Обновление вложенных документов

Для обновления полей внутри вложенных документов используются операторы обновления, такие как `$set`, `$inc`, `$push`:

```javascript
// Изменить улицу пользователя по имени
db.users.updateOne(
  { name: "Иван" }, 
  { $set: { "address.street": "пр. Мира" } }
)
```

### Массивы вложенных документов

Вложенные документы могут быть организованы в массивы:

```javascript
db.users.insertOne({
  name: "Петр",
  age: 25,
  orders: [ // Массив вложенных документов для заказов
    { id: 1, amount: 100 },
    { id: 2, amount: 250 }
  ]
})
```

### Запросы к массивам вложенных документов

Для запросов к массивам вложенных документов используются операторы, такие как `$elemMatch`, `$size`, `$all`:

```javascript
// Найти пользователей с заказом на сумму больше 200
db.users.find({ 
  orders: { $elemMatch: { amount: { $gt: 200 } } } 
})
```

### Обновление массивов вложенных документов

Обновление массивов вложенных документов осуществляется с помощью позиционного оператора `$` или оператора `$addToSet`:

```javascript
// Добавить новый заказ пользователю по имени
db.users.updateOne(
  { name: "Петр" },
  { $push: { orders: { id: 3, amount: 150 } } }
)
```

### Проекция вложенных документов

Для извлечения только необходимых полей из вложенных документов используется проекция:

```javascript
// Получить имена и города всех пользователей
db.users.find(
  {}, 
  { _id: 0, name: 1, "address.city": 1 }
)
```

В этом примере мы использовали проекцию, чтобы получить только поля "name" и "address.city", исключив поле "_id".

Вложенные документы – мощный инструмент MongoDB, позволяющий моделировать сложные структуры данных и эффективно с ними работать.  Понимание принципов работы с вложенными документами является важным шагом к использованию всех возможностей MongoDB.

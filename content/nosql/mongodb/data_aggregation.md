## Агрегация данных

MongoDB предлагает мощный механизм агрегации, позволяющий выполнять сложные операции обработки данных непосредственно на сервере.  Агрегация позволяет группировать документы по различным критериям, выполнять вычисления, фильтровать результаты и многое другое.

### Основы агрегации

Процесс агрегации в MongoDB основан на конвейерной обработке данных. Данные проходят через последовательность этапов (stages), каждый из которых выполняет определенную операцию. Результат каждого этапа передается на следующий, формируя конечный результат. 

Для выполнения агрегации используется метод `aggregate()`, которому передается массив этапов в виде документов. 

```javascript
db.collection.aggregate([
    { /* этап 1 */ },
    { /* этап 2 */ },
    // ...
    { /* этап N */ }
]);
```

### Основные этапы агрегации

MongoDB предоставляет богатый набор этапов агрегации. Рассмотрим некоторые из наиболее часто используемых:

#### `$match`: Фильтрация документов

Этап `$match` фильтрует документы на основе заданных критериев. Он принимает документ с условиями фильтрации, аналогичный используемому в методе `find()`.

**Пример:** Выбрать все заказы со статусом "выполнен":

```javascript
db.orders.aggregate([
    { $match: { status: "выполнен" } } 
]);
```

#### `$group`: Группировка документов

Этап `$group` группирует документы по заданным полям. Он позволяет выполнять агрегатные вычисления, такие как подсчет, суммирование, усреднение и др.

**Пример:** Подсчитать количество заказов для каждого статуса:

```javascript
db.orders.aggregate([
    {
        $group: {
            _id: "$status", 
            count: { $sum: 1 }
        }
    }
]);
```

В этом примере:

- `_id`: определяет поле группировки (статус заказа).
- `count`: вычисляемое поле, использующее оператор `$sum` для подсчета количества документов в каждой группе.

#### `$project`: Проекция полей

Этап `$project` используется для выбора, переименования и создания новых полей в результирующих документах.

**Пример:** Выбрать только поля `customerName` и `totalAmount` из заказов:

```javascript
db.orders.aggregate([
    {
        $project: {
            _id: 0, 
            customerName: 1,
            totalAmount: 1
        }
    }
]);
```

В этом примере:

- `_id: 0`: исключает поле `_id` из результата.
- `customerName: 1`, `totalAmount: 1`:  включает поля `customerName` and `totalAmount` в результат.

#### `$sort`: Сортировка документов

Этап `$sort` сортирует документы по одному или нескольким полям. 

**Пример:** Отсортировать заказы по дате в порядке убывания:

```javascript
db.orders.aggregate([
    { $sort: { orderDate: -1 } } 
]);
```

#### `$limit`: Ограничение количества документов

Этап `$limit` ограничивает количество обрабатываемых документов.

**Пример:** Выбрать первые 10 заказов:

```javascript
db.orders.aggregate([
    { $limit: 10 }
]);
```

### Сочетание этапов агрегации

Сила агрегации в MongoDB заключается в возможности комбинирования различных этапов для создания сложных запросов.

**Пример:** Выбрать 5 самых дорогих заказов, сгруппированных по клиенту:

```javascript
db.orders.aggregate([
  {
    $group: {
      _id: "$customerId",
      totalAmount: { $max: "$totalAmount" },
      orderId: { $first: "$_id" }
    }
  },
  { $sort: { totalAmount: -1 } },
  { $limit: 5 }
]);
```

В этом примере:

1. `$group`: Группирует заказы по клиенту (`customerId`), выбирая максимальную сумму заказа (`totalAmount`) и ID первого заказа (`orderId`) в каждой группе.
2. `$sort`: Сортирует группы по убыванию `totalAmount`.
3. `$limit`: Ограничивает вывод 5 первыми группами (клиентами с самыми дорогими заказами).

### Заключение

Агрегация в MongoDB - это мощный инструмент для обработки и анализа данных. Используя различные этапы и их комбинации, можно создавать сложные запросы, которые выполняются на стороне сервера, обеспечивая высокую производительность. Подробную информацию о всех доступных этапах и операторах агрегации можно найти в документации MongoDB. 

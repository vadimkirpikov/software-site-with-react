## Настройка шардинга в MongoDB 7.0

Шардинг — это метод горизонтального масштабирования базы данных, при котором данные распределяются по нескольким серверам (шардам). Это позволяет обрабатывать большие объемы данных и трафика, превосходящие возможности одного сервера. 

В этом разделе мы рассмотрим процесс настройки шардинга в MongoDB 7.0.

### Компоненты шардированной кластера MongoDB

Шардированный кластер MongoDB состоит из следующих компонентов:

| Компонент | Описание |
|---|---|
| **Shard** | Сервер MongoDB, хранящий часть данных. |
| **Mongos** | Маршрутизатор запросов, перенаправляющий запросы на соответствующие шарды. |
| **Config Server** | Серверы, хранящие метаданные кластера, такие как схема шардирования и расположение шардов. |

### Этапы настройки шардинга

Настройка шардинга в MongoDB 7.0 включает в себя следующие шаги:

1. **Развертывание серверов Config Server.**
2. **Запуск экземпляра Mongos.**
3. **Развертывание серверов Shard.**
4. **Добавление шардов в кластер.**
5. **Включение шардирования для коллекции.**

### 1. Развертывание серверов Config Server

Для начала необходимо развернуть как минимум три сервера Config Server.  

Запустите каждый сервер Config Server с опцией `--configsvr` и укажите путь к файлу конфигурации:

```bash
mongod --configsvr --replSet "cfg" --port 27019 --dbpath /data/mongodb/config1 --logpath /data/mongodb/config1/log/mongodb.log
```

Замените `27019`, `/data/mongodb/config1` и `/data/mongodb/config1/log/mongodb.log` на соответствующие значения для вашего окружения. 

Инициализируйте реплику Config Server:

```javascript
// Подключитесь к одному из серверов Config Server.
mongo --port 27019

// Выполните следующий код для инициализации реплики.
rs.initiate( {
   _id : "cfg",
   members: [
      { _id: 0, host: "localhost:27019" },
      { _id: 1, host: "localhost:27020" },
      { _id: 2, host: "localhost:27021" }
   ]
})
```

### 2. Запуск экземпляра Mongos

Запустите экземпляр Mongos с опцией `--configdb` и укажите реплику Config Server:

```bash
mongos --configdb cfg/localhost:27019,localhost:27020,localhost:27021 --port 27017 --logpath /data/mongodb/mongos/log/mongos.log
```

Замените `/data/mongodb/mongos/log/mongos.log` на соответствующее значение для вашего окружения.

### 3. Развертывание серверов Shard

Запустите каждый сервер Shard с опцией `--shardsvr` и укажите путь к файлу конфигурации:

```bash
mongod --shardsvr --port 27018 --dbpath /data/mongodb/shard1 --logpath /data/mongodb/shard1/log/mongodb.log
```

Замените `27018`, `/data/mongodb/shard1` и `/data/mongodb/shard1/log/mongodb.log` на соответствующие значения для вашего окружения.

### 4. Добавление шардов в кластер

Подключитесь к экземпляру Mongos:

```bash
mongo --port 27017
```

Добавьте каждый шард в кластер с помощью команды `sh.addShard()`:

```javascript
sh.addShard( "localhost:27018" )
```

Повторите команду `sh.addShard()` для каждого сервера Shard.

### 5. Включение шардирования для коллекции

Чтобы включить шардирование для коллекции, используйте команду `sh.enableSharding()`, указав имя базы данных:

```javascript
use mydb
sh.enableSharding( "mydb" )
```

Затем выберите ключ шардирования, по которому будут распределяться данные, и примените его к коллекции с помощью команды `sh.shardCollection()`:

```javascript
sh.shardCollection( "mydb.mycollection", { _id: "hashed" } )
```

В данном примере мы используем `hashed` шардирование по полю `_id`. 

### Заключение

Настройка шардинга в MongoDB 7.0 – важный этап масштабирования базы данных. Следуя описанным выше шагам, вы можете распределить данные по нескольким серверам и обеспечить высокую доступность и отказоустойчивость вашего приложения. 

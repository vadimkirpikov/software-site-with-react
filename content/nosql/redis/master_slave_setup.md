## Настройка мастера и слейва

В данной статье мы рассмотрим настройку мастер-слейв репликации в Redis 7.2.0. Репликация — это механизм, позволяющий создавать копии данных с одного сервера Redis (мастер) на другой (слейв). Это позволяет обеспечить высокую доступность данных и увеличить производительность при чтении.

**Преимущества репликации:**

* **Высокая доступность:** В случае сбоя мастера, слейв автоматически становится новым мастером, обеспечивая непрерывность работы.
* **Увеличенная производительность чтения:** Слейвы могут обрабатывать запросы на чтение, разгружая мастер и повышая его производительность.
* **Безопасность данных:** Репликация позволяет легко создавать резервные копии данных, что повышает их безопасность.

**Настройка репликации:**

1. **Запуск мастера:** 
    
    Запустите Redis на первом сервере, который будет выступать в роли мастера. Используйте стандартную конфигурацию. 
    
    ```bash
    redis-server
    ```
    
2. **Запуск слейва:**

    Запустите Redis на втором сервере, который будет выступать в роли слейва. Добавьте опцию `slaveof` в конфигурационном файле `redis.conf` или передайте ее как аргумент при запуске Redis. 
    
    ```bash
    redis-server --slaveof master_ip master_port
    ```
    
    * `master_ip` — IP-адрес сервера мастера.
    * `master_port` — Порт сервера мастера (по умолчанию 6379).
    
3. **Проверка подключения:**

    После запуска слейва, убедитесь, что он подключился к мастеру. Проверьте вывод команды `info replication` на слейве. В поле `master_link_status` должно быть значение `up`.
    
    ```bash
    redis-cli -h slave_ip -p slave_port info replication
    ```
    
    **Пример:**
    
    ```
    # Replication
    role:slave
    master_host:127.0.0.1
    master_port:6379
    master_link_status:up
    ```
    
4. **Настройка асинхронной репликации:**

    По умолчанию репликация в Redis выполняется синхронно, что означает, что мастер ждет подтверждения от слейва перед отправкой следующей операции. Это гарантирует согласованность данных, но может снизить производительность мастера. 
    
    Для повышения производительности можно использовать асинхронную репликацию, где мастер не ждет подтверждения от слейва.
    
    Для этого необходимо настроить параметр `repl-backlog-size` на мастере и `repl-backlog-timeout` на слейве.
    
    * `repl-backlog-size`: Размер буфера на мастере, который хранит необработанные данные для слейва. 
    * `repl-backlog-timeout`: Максимальное время, в течение которого слейв может находиться в отставании от мастера, прежде чем он будет отключен. 
    
    ```bash
    # master.conf
    repl-backlog-size 1024mb
    
    # slave.conf
    repl-backlog-timeout 60
    ```
    
5. **Настройка синхронной репликации:**

    Для обеспечения максимальной согласованности данных можно использовать синхронную репликацию с подтверждением от нескольких слейвов. В этом случае мастер ждет подтверждения от определенного количества слейвов перед отправкой следующей операции.
    
    Для настройки синхронной репликации необходимо добавить параметры `repl-min-slaves-to-write` и `repl-min-slaves-max-lag` в конфигурационный файл мастера. 
    
    * `repl-min-slaves-to-write`: Минимальное количество слейвов, которые должны быть подключены к мастеру, чтобы мастер мог принимать команды на запись. 
    * `repl-min-slaves-max-lag`: Максимальное время задержки (в секундах) между мастером и слейвом, которое допускается для синхронной репликации.
    
    ```bash
    # master.conf
    repl-min-slaves-to-write 1
    repl-min-slaves-max-lag 10
    ```
    
    В данном примере мастер будет принимать команды на запись только если к нему подключен хотя бы один слейв, и задержка между мастером и слейвом не превышает 10 секунд.
    
6. **Настройка отслеживания слейвов:**

    Redis позволяет отслеживать состояние слейвов, используя команду `info replication`.
    
    ```bash
    redis-cli -h master_ip -p master_port info replication
    ```
    
    В выводе команды отображается информация о подключенных слейвах, их ID, адресах, задержке и т.д.
    
    **Пример:**
    
    ```
    # Replication
    role:master
    connected_slaves:1
    slave0:ip=192.168.1.2,port=6380,state=online,offset=1000,lag=1
    ```
    
**Переключение мастера:**

В случае сбоя мастера, один из подключенных слейвов автоматически становится новым мастером. Этот процесс называется переключением мастера (failover).
    
**Дополнительные настройки:**

* **`slave-priority`:** Приоритет слейва при переключении мастера. Слейв с более высоким приоритетом становится новым мастером.
* **`slave-read-only`:** Запрещает выполнение команд на запись на слейве.
* **`slave-serve-stale-data`:** Позволяет слейву обслуживать запросы на чтение даже если он отстает от мастера.
* **`slave-announce-ip`:** IP-адрес, который слейв будет использовать для объявления себя новым мастером.
* **`slave-announce-port`:** Порт, который слейв будет использовать для объявления себя новым мастером.

**Заключение:**

Репликация Redis — это мощный инструмент, который позволяет обеспечить высокую доступность данных, увеличить производительность чтения и повысить безопасность данных. Настройка репликации проста и позволяет выбрать подходящий режим работы в зависимости от конкретных потребностей.

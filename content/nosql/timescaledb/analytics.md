## Агрегации и аналитика

TimeScaleDB оптимизирован для высокопроизводительной обработки больших объемов временных данных. Он предлагает ряд функций, которые позволяют эффективно выполнять агрегации и аналитику над этими данными. 

### Агрегационные функции

TimeScaleDB предоставляет набор встроенных агрегатных функций, которые можно использовать для группировки и суммирования данных. 

**Пример:**

Представьте, что у вас есть таблица `measurements`, в которой хранятся показания датчиков с временными метками:

```sql
CREATE TABLE measurements (
    time timestamptz NOT NULL,
    sensor_id INT,
    value DOUBLE PRECISION
);

CREATE EXTENSION IF NOT EXISTS timescaledb;

SELECT * FROM create_hypertable('measurements', 'time');
```

Чтобы получить среднее значение `value` для каждого датчика за последний час, вы можете использовать следующую агрегатную функцию:

```sql
SELECT sensor_id, AVG(value) 
FROM measurements 
WHERE time >= NOW() - INTERVAL '1 hour'
GROUP BY sensor_id;
```

### Агрегационные функции с оконными функциями

TimeScaleDB также поддерживает использование оконных функций с агрегатными функциями для вычисления агрегаций по группам данных. 

**Пример:**

Чтобы получить среднее значение `value` за последние 3 измерения для каждого датчика, можно использовать оконную функцию `LAG`:

```sql
SELECT 
  sensor_id, 
  time, 
  value, 
  AVG(value) OVER (PARTITION BY sensor_id ORDER BY time ASC ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS rolling_avg
FROM measurements
ORDER BY sensor_id, time;
```

**Описание:**

* `PARTITION BY sensor_id`: разбивает данные на отдельные группы для каждого датчика.
* `ORDER BY time ASC`: сортирует данные в каждой группе по времени в порядке возрастания.
* `ROWS BETWEEN 2 PRECEDING AND CURRENT ROW`: определяет "окно" для расчета среднего значения - текущая строка и две предыдущие строки.

### Индексы для агрегаций

TimeScaleDB предоставляет специализированные индексы, которые ускоряют операции агрегации. 

**Пример:**

Чтобы ускорить агрегацию по времени, вы можете использовать индекс `time_bucket`:

```sql
CREATE EXTENSION IF NOT EXISTS timescaledb;

SELECT create_hypertable('measurements', 'time');

CREATE INDEX measurements_time_bucket ON measurements USING btree (time_bucket('1 hour', time));
```

Этот индекс будет группировать данные по временным интервалам продолжительностью 1 час, что позволит быстрее находить записи для агрегации.

**Таблица с типами индексов:**

| Тип индекса | Описание |
|---|---|
| `time_bucket` | Индекс для агрегаций по временным интервалам |
| `time_chunk` | Индекс для агрегаций по частям гипертаблицы |
| `chunk_time` | Индекс для агрегаций по частям гипертаблицы и времени |

### Аналитические функции

TimeScaleDB включает аналитические функции, которые позволяют выполнять более сложные операции, такие как интерполяция, экстраполяция и прогнозирование. 

**Пример:**

Для прогнозирования значений `value` на основе исторических данных можно использовать функцию `linear_regression`:

```sql
SELECT 
  time, 
  linear_regression(time, value, time, 0.5) AS predicted_value
FROM measurements
WHERE time >= NOW() - INTERVAL '1 week';
```

**Описание:**

* `linear_regression(time, value, time, 0.5)`: выполняет линейную регрессию по данным `value` от времени `time` с использованием временного интервала `0.5`.

### Дополнительные возможности

TimeScaleDB предлагает дополнительные возможности для агрегации и аналитики:

* **Частичные агрегации**: позволяют выполнять агрегации по частям гипертаблицы для улучшения производительности.
* **Фильтрация данных**: позволяет фильтровать данные по определенным условиям перед агрегацией.
* **Использование SQL-функций**: позволяет использовать стандартные SQL-функции для выполнения более сложных агрегаций.

### Заключение

TimeScaleDB предоставляет богатый набор инструментов для выполнения агрегаций и аналитики над временными данными. Используя агрегационные функции, индексы и аналитические функции, вы можете эффективно анализировать и получать ценные сведения из ваших данных.

## Аудит и журналы

В современных системах хранения данных, таких как TimeScaleDB, важно иметь возможность отслеживать изменения данных и действия пользователей, чтобы обеспечить безопасность и целостность информации. Для этого используются механизмы аудита и ведения журналов.

### Аудит

Аудит в TimeScaleDB позволяет записывать информацию о действиях, которые выполняются с данными, таких как вставки, обновления, удаления, а также о доступе к данным. Это помогает отслеживать потенциальные угрозы безопасности, выявлять злоупотребления и анализировать поведение пользователей.

TimeScaleDB использует расширение PostgreSQL **pgaudit**, которое предоставляет гибкий механизм аудита. 

#### Настройка аудита

1. **Установите расширение pgaudit:**

```sql
CREATE EXTENSION pgaudit;
```

2. **Настройте политику аудита:**

```sql
CREATE OR REPLACE POLICY audit_policy AS
  ON INSERT, UPDATE, DELETE ON public.your_table
  AUDIT
    ACTION,
    USER,
    STATEMENT,
    OBJECT,
    BEFORE,
    AFTER;
```

**Пример:**

```sql
CREATE EXTENSION pgaudit;

CREATE TABLE measurements (
  time timestamptz NOT NULL,
  sensor_id INT,
  value FLOAT,
  PRIMARY KEY (time, sensor_id)
);

CREATE OR REPLACE POLICY audit_policy AS
  ON INSERT, UPDATE, DELETE ON public.measurements
  AUDIT
    ACTION,
    USER,
    STATEMENT,
    OBJECT,
    BEFORE,
    AFTER;
```

В этом примере мы создали политику `audit_policy`, которая будет записывать информацию о действиях `INSERT`, `UPDATE` и `DELETE` для таблицы `measurements`.  

**Параметры политики:**

* **ACTION:** Тип действия (INSERT, UPDATE, DELETE, SELECT).
* **USER:** Пользователь, который выполнил действие.
* **STATEMENT:** Текст SQL-запроса.
* **OBJECT:** Имя объекта, к которому было применено действие.
* **BEFORE:** Данные, которые существовали до выполнения действия.
* **AFTER:** Данные, которые возникли после выполнения действия.

3. **Включите политику:**

```sql
ALTER TABLE measurements ENABLE ROW LEVEL SECURITY;
ALTER TABLE measurements FORCE ROW LEVEL SECURITY;
```

**Важно:** Настройка аудита может повлиять на производительность базы данных, поэтому рекомендуется использовать ее с осторожностью и только для критических данных.

### Журналы

Журналы в TimeScaleDB позволяют записывать информацию о всех изменениях данных, которые произошли в базе данных. Эта информация хранится в виде отдельных записей, которые называются "событиями". 

#### Просмотр журнала

```sql
SELECT * FROM pg_log_replay;
```

**Результат:**

| **xid** | **timestamp** | **lsn** | **tli** | **prev** | **rel** | **block** | **pid** | **user** | **action** | **data** |
|---|---|---|---|---|---|---|---|---|---|---|
| 1234 | 2023-08-01 12:00:00 | 0/12345 | 1 | 0/12344 | 16384 | 1234 | 12345 | user1 | INSERT | данные |

**Описание полей:**

* **xid:** Идентификатор транзакции.
* **timestamp:** Время записи события.
* **lsn:** Log Sequence Number (номер последовательности журнала).
* **tli:** Transaction ID (идентификатор транзакции).
* **prev:** Предшествующий LSN.
* **rel:** Идентификатор отношения (таблицы).
* **block:** Номер блока данных.
* **pid:** Идентификатор процесса, который выполнил действие.
* **user:** Пользователь, который выполнил действие.
* **action:** Тип действия (INSERT, UPDATE, DELETE).
* **data:** Данные, которые были изменены.

#### Настройка журналов

Журналы по умолчанию включены в TimeScaleDB. 

**Важно:** Хранение журналов может занять значительное дисковое пространство. Рекомендуется периодически очищать журналы или настроить их архивирование.

### Использование аудита и журналов

Аудит и журналы могут использоваться для решения следующих задач:

* **Отслеживание изменений данных:** 
    * Выявление злоупотреблений.
    *  Анализ поведения пользователей.
    *  Восстановление данных в случае сбоя.
* **Проверка безопасности:** 
    * Обнаружение несанкционированного доступа.
    *  Проверка выполнения политик безопасности.
* **Отладка:** 
    * Поиск причин ошибок.
    *  Анализ производительности.

**Пример:**

```sql
-- Проверка, кто удалил запись из таблицы measurements 
SELECT user, timestamp, statement
FROM pg_log_replay
WHERE action = 'DELETE'
  AND rel = (SELECT oid FROM pg_class WHERE relname = 'measurements')
  AND timestamp BETWEEN '2023-08-01 10:00:00' AND '2023-08-01 12:00:00'
ORDER BY timestamp DESC;
```

### Заключение

Аудит и журналы являются важными инструментами для обеспечения безопасности и целостности данных в TimeScaleDB. Правильная настройка и использование этих механизмов позволяет отслеживать изменения данных, выявлять угрозы безопасности и анализировать поведение пользователей. 

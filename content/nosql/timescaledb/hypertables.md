## Создание гипертаблицы

В предыдущем разделе мы познакомились с основными концепциями TimeScaleDB. Теперь перейдем к практическому применению: созданию гипертаблицы. Гипертаблица - это ключевой элемент TimeScaleDB, позволяющий хранить и анализировать временные ряды данных. 

**Определение:**

Гипертаблица - это обычная таблица PostgreSQL, которая дополнительно оснащена расширением TimeScaleDB для оптимизации хранения и запросов временных данных. Она состоит из нескольких "частей", называемых "чёрными ящиками" (chunk), которые позволяют эффективно сжимать и хранить данные.

**Процесс создания гипертаблицы:**

1. **Создание таблицы PostgreSQL:**

   Прежде всего, нужно создать обычную таблицу PostgreSQL, которая будет служить основой для гипертаблицы. Например, для хранения данных о температуре:

   ```sql
   CREATE TABLE temperatures (
       time timestamptz NOT NULL,
       sensor_id integer NOT NULL,
       temperature double precision,
       PRIMARY KEY (time, sensor_id)
   );
   ```

2. **Инициализация гипертаблицы:**

   После создания обычной таблицы, ее необходимо "превратить" в гипертаблицу. Для этого используется функция `create_hypertable`:

   ```sql
   CREATE EXTENSION timescaledb;
   
   SELECT create_hypertable('temperatures', 'time');
   ```

   В этом примере `temperatures` - имя созданной ранее таблицы, а `time` - имя столбца, который будет использоваться как временная метка. 

**Основные моменты:**

* **Временная метка:** Выбор временной метки - ключевой момент. Она должна быть столбцом типа `timestamptz` или `timestamp` и должна быть включена в первичный ключ.
* **Чёрные ящики:** TimeScaleDB автоматически разделит данные на "черные ящики" по выбранной временной метке. Размер каждого "чёрного ящика" настраивается параметром `compress_segmentby`, по умолчанию - 1 день.
* **Индексы:** Для ускорения запросов по столбцам, не являющимся временной меткой, рекомендуется создать индексы:

   ```sql
   CREATE INDEX sensor_id_idx ON temperatures (sensor_id);
   ```

**Примеры использования:**

* **Вставка данных:**

   ```sql
   INSERT INTO temperatures (time, sensor_id, temperature) VALUES
   ('2023-08-15 10:00:00', 1, 25.5),
   ('2023-08-15 10:15:00', 1, 26.2),
   ('2023-08-15 10:30:00', 2, 24.8);
   ```

* **Запрос данных:**

   ```sql
   SELECT * FROM temperatures WHERE time BETWEEN '2023-08-15 10:00:00' AND '2023-08-15 11:00:00';
   ```

**Настройка гипертаблицы:**

TimeScaleDB предоставляет множество настроек для оптимизации гипертаблиц. Например, можно задать размер "черных ящиков" (compress_segmentby), уровень сжатия (compress_scale), а также управлять временем удержания данных (retention_policy).

**Дополнительные сведения:**

* **Retention policies:** TimeScaleDB позволяет автоматически удалять старые данные, чтобы предотвратить переполнение диска.
* **Continuous aggregates:** Используются для агрегирования данных за определенный период времени, например, средняя температура за час.
* **Hyperfunctions:** Предлагают набор функций, оптимизированных для работы с гипертаблицами.

**Заключение:**

Создание гипертаблицы - важный шаг в работе с TimeScaleDB. Гипертаблицы позволяют эффективно хранить и анализировать временные ряды данных, предоставляя множество возможностей для оптимизации и ускорения запросов. В следующих разделах мы рассмотрим более сложные сценарии использования гипертаблиц, такие как создание непрерывных агрегатов и применение Hyperfunctions.
